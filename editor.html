<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>2D„Éû„ÉÉ„Éó„Ç®„Éá„Ç£„ÇøÔºà„Éâ„É©„ÉÉ„Ç∞Ë®≠ÁΩÆÂØæÂøúÔºâ</title>
  <script src="assets-base64.js"></script>
  <script src="editor-common.js"></script>
  <!-- <script src="file-manager.js"></script> -->
  <style>
    body {
      margin: 0;
      font-family: "Yu Gothic", sans-serif;
      background: #000;
      color: #1a2a4f;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    canvas {
      background: #aee;
      image-rendering: pixelated;
      border: 2px solid #1a2a4f;
      display: block;
      margin-top: 120px;
    }
    #slotBar {
      display: flex;
      justify-content: center;
      background: #fff;
      border-radius: 12px;
      padding: 10px;
      margin-top: 8px;
      gap: 12px;
      box-shadow: none;
    }
    #handSlot, #eraserSlot {
      display: flex;
      align-items: center;
      margin-right: 0;
      padding-right: 0;
      border-right: none;
    }
    #mainSlotBar {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .hand-btn {
      width: 48px;
      height: 48px;
      border-radius: 10px;
      border: none;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.10);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: box-shadow 0.2s, border 0.2s, background 0.2s;
      outline: none;
    }
    .hand-btn:hover {
      background: #f0f4ff;
      box-shadow: 0 4px 12px rgba(68,102,255,0.10);
    }
    .hand-btn.selected {
      border: 2px solid #4466ff;
      box-shadow: 0 0 8px #88f;
      background: #eaf2ff;
    }
    .eraser-btn {
      width: 48px;
      height: 48px;
      border-radius: 10px;
      border: none;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.10);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: box-shadow 0.2s, border 0.2s, background 0.2s;
      outline: none;
    }
    .eraser-btn:hover {
      background: #f0f4ff;
      box-shadow: 0 4px 12px rgba(68,102,255,0.10);
    }
    .eraser-btn.selected {
      border: 2px solid #4466ff;
      box-shadow: 0 0 8px #88f;
      background: #eaf2ff;
    }
    .slot-btn {
      width: 56px;
      height: 56px;
      border-radius: 12px;
      border: 3px solid #1a2a4f;
      background: #eef;
      margin: 0 5px;
      box-shadow: none;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s, border 0.2s;
      padding: 0;
      overflow: hidden;
    }
    .slot-btn img {
      width: 48px;
      height: 48px;
      display: block;
      margin: 0 auto;
      pointer-events: none;
      border-radius: 10px;
    }
    .slot-btn.selected {
      background: #88f;
      border: 2px solid #4466ff;
      box-shadow: 0 0 8px #88f;
    }
    .slot-btn:hover {
      background: #dde6ff;
    }
    .slot-btn.sub {
      width: 36px;
      height: 36px;
      font-size: 12px;
    }
    .more-btn {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: 2px solid #1a2a4f;
      background: #f0f0f0;
      color: #666;
      font-size: 18px;
      font-weight: bold;
      margin-left: 4px;
      margin-right: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s, color 0.2s;
    }
    .more-btn:hover {
      background: #e0e0e0;
      color: #333;
    }
    .block-selector {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }
    .block-selector.show {
      display: flex;
    }
    .block-selector-content {
      background: white;
      border-radius: 15px;
      padding: 30px;
      max-width: 80%;
      max-height: 80%;
      overflow-y: auto;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
      gap: 15px;
    }
    .block-selector-btn {
      width: 60px;
      height: 60px;
      border-radius: 10px;
      border: 2px solid #ddd;
      background: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .block-selector-btn:hover {
      border-color: #4466ff;
      background: #f0f4ff;
    }
    .block-selector-btn.selected {
      border-color: #4466ff;
      background: #4466ff;
      color: white;
    }
    .block-selector-close {
      position: absolute;
      top: 20px;
      right: 30px;
      background: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #homeButton, #clearButton, #undoButton, #redoButton, #exportButton, #importButton {
      position: absolute;
      top: 10px;
      font-size: 20px;
      padding: 10px 16px;
      z-index: 999;
      background: #fff;
      color: #1a2a4f;
      border-radius: 12px;
      border: none;
      font-weight: bold;
      cursor: pointer;
      min-width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #homeButton { left: 10px; }
    #clearButton { left: 140px; }
    #undoButton { left: 270px; }
    #redoButton { left: 340px; }
    #exportButton { left: 470px; }
    #importButton { left: 540px; }
    
    #fileInput {
      display: none;
    }
    /* --- „Éñ„É≠„ÉÉ„ÇØË©≥Á¥∞„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó --- */
    #blockDetailPopup {
      position: fixed;
      top: 20px;
      left: 20px;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      border: 2px solid #4466ff;
      display: none;
      align-items: center;
      padding: 16px 24px 16px 16px;
      z-index: 10001;
      min-width: 220px;
      min-height: 64px;
      font-size: 18px;
      font-family: "Yu Gothic", sans-serif;
      color: #1a2a4f;
      gap: 18px;
    }
    #blockDetailPopup img {
      width: 48px;
      height: 48px;
      border-radius: 10px;
      background: #eef;
      border: 1.5px solid #bbb;
      margin-right: 12px;
      flex-shrink: 0;
    }
    #blockDetailPopup .block-name {
      font-size: 20px;
      font-weight: bold;
      color: #223;
      margin-right: 8px;
    }
    #blockDetailPopup .close-btn {
      margin-left: 16px;
      background: #eee;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      color: #888;
      cursor: pointer;
      padding: 2px 10px;
      transition: background 0.2s;
    }
    #blockDetailPopup .close-btn:hover {
      background: #d0d8ff;
      color: #4466ff;
    }
  </style>
</head>
<body>
  <div id="message" style="position:fixed;top:10px;left:50%;transform:translateX(-50%);background:#fff;padding:8px 16px;border-radius:8px;color:#1a2a4f;display:none;z-index:9999;font-weight:bold"></div>
  <canvas id="gameCanvas" width="1024" height="640"></canvas>
  <div id="slotBar">
    <div id="handSlot"></div>
    <div id="eraserSlot"></div>
    <div id="mainSlotBar"></div>
  </div>
  <button id="homeButton">„Éõ„Éº„É†</button>
  <button id="clearButton">üóëÔ∏è</button>
  <button id="undoButton">‚Ü©</button>
  <button id="redoButton">‚Ü™</button>
  <button id="exportButton">üíæ</button>
  <button id="importButton">üìÇ</button>
  <input type="file" id="fileInput" accept=".json">
  <!-- „ÉØ„Éº„É´„ÉâÊ®™ÂπÖÂ§âÊõ¥Ê©üËÉΩ„ÅØÂªÉÊ≠¢„ÄÇÊ®™ÂπÖ„ÅØÂ∏∏„Å´1000„Éñ„É≠„ÉÉ„ÇØ -->
  <div id="blockSelector" class="block-selector">
    <button class="block-selector-close" onclick="closeBlockSelector()">‚úï</button>
    <div class="block-selector-content" id="blockSelectorContent"></div>
  </div>
  <div id="blockDetailPopup">
    <img id="blockDetailImg" src="" alt="block" />
    <span class="block-name" id="blockDetailName"></span>
    <div id="mushroomSettings" style="margin-top:12px;display:none;">
     
    </div>
    <button class="close-btn" onclick="document.getElementById('blockDetailPopup').style.display='none'">‚úï</button>
  </div>
  <script>
    console.log('HELLO');
    // urlParams„Å®slotName„ÅØeditor-common.js„ÅßÊó¢„Å´ÂÆöÁæ©Ê∏à„Åø
    // TILE_SIZE„ÇÇeditor-common.js„ÅßÂÆöÁæ©Ê∏à„Åø
    
    // „Ç®„Éá„Ç£„ÇøÁî®„ÅÆcanvas„Å®ctx„ÇíÂèñÂæóÔºàeditor-common.js„ÅßÊó¢„Å´ÂÆöÁæ©Ê∏à„Åø„ÅÆÂ†¥Âêà„ÅØ‰ΩøÁî®Ôºâ
    const editorCanvas = document.getElementById("gameCanvas");
    if (!window.canvas || !window.ctx) {
      window.canvas = editorCanvas;
      window.ctx = window.canvas.getContext("2d");
      window.ctx.imageSmoothingEnabled = false;
    }
    if (window.attachGameCanvas) {
      window.attachGameCanvas(editorCanvas);
    }
    // window„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Åã„ÇâÁõ¥Êé•ÂèÇÁÖßÔºàconstÂÆ£Ë®Ä„ÇíÈÅø„Åë„ÇãÔºâ
    // const canvas = window.canvas;
    // const ctx = window.ctx;

    // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å®„Åó„Å¶ÂÆöÁæ©Ôºà„ÉØ„Éº„É´„ÉâÊ®™ÂπÖÂ§âÊõ¥„Å´ÂØæÂøúÔºâ
  window.cols = window.cols || 1000;
    if (!window.rows) window.rows = 20;
    const DEFAULT_WORLD_COLS = window.cols;
    const DEFAULT_WORLD_ROWS = window.rows;
    const MIN_WORLD_COLS = 1000;
    let cols = window.cols;
    let rows = window.rows;
    let cameraReady = false;
    let camera = null;
    function updateEditorBounds(rawMap) {
      const dims = window.getWorldDimensions(rawMap);
      window.rows = Math.max(dims.rows, DEFAULT_WORLD_ROWS);
      window.cols = Math.max(dims.cols, MIN_WORLD_COLS);
      rows = window.rows;
      cols = window.cols;
      return dims;
    }

    function applyWorldToEditor(worldData, options = {}) {
      const result = window.applyWorldData(
        worldData,
        Object.assign({
          targetRows: window.rows,
          targetCols: window.cols,
          minRows: window.rows,
          minCols: window.cols
        }, options)
      );
      rows = window.rows;
      cols = window.cols;
      if (cameraReady && typeof updateCameraBounds === "function") updateCameraBounds();
      if (cameraReady && typeof draw === "function") draw();
      return result;
    }
    // map„ÅØeditor-common.js„ÅßÂÆöÁæ©Ê∏à„Åø

    // Âèñ„ÇäÊ∂à„Åó„Éª„ÇÑ„ÇäÁõ¥„ÅóÊ©üËÉΩ„ÅÆÂ±•Ê≠¥ÁÆ°ÁêÜ
    let undoHistory = [];
    let redoHistory = [];
    let isUndoRedoAction = false; // Âèñ„ÇäÊ∂à„Åó„Éª„ÇÑ„ÇäÁõ¥„Åó‰∏≠„ÅÆ„Éï„É©„Ç∞

    // --- „ÉØ„Éº„É´„Éâ„Éá„Éº„ÇøËá™ÂãïË™≠„ÅøËæº„Åø ---
    function loadWorldData() {
      const saved = localStorage.getItem("world_" + slotName);
      if (!saved) {
        window.dummyOverlays = {};
        window.enemyDirs = {};
        window.trampolineAngles = {};
        window.trampolinePowers = {};
        window.enemyProps = {};
        applyWorldToEditor([], {
          targetRows: window.rows,
          targetCols: window.cols,
          minRows: window.rows,
          minCols: window.cols
        });
        return;
      }

      try {
        const mapData = JSON.parse(saved);
        const mapSource = Array.isArray(mapData)
          ? mapData
          : (mapData && Array.isArray(mapData.map) ? mapData.map : null);

        if (mapSource) {
          const dims = updateEditorBounds(mapSource);
          const result = applyWorldToEditor(mapData);
          if (result.mismatch) {
            showMessage(`Ë≠¶Âëä: ‰øùÂ≠ò„Åï„Çå„Åü„ÉØ„Éº„É´„Éâ„Çµ„Ç§„Ç∫(${dims.cols || 0}√ó${dims.rows || 0})„ÅåÁèæÂú®„ÅÆÁ∑®ÈõÜÁØÑÂõ≤„Å®Áï∞„Å™„Çã„Åü„ÇÅ„ÄÅÁØÑÂõ≤Â§ñ„ÅÆ„Éñ„É≠„ÉÉ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü`);
          }
          return;
        }
      } catch (e) {
        console.error("„ÉØ„Éº„É´„Éâ„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:", e);
      }

      // Ë™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„ÅüÂ†¥Âêà„ÅØÂàùÊúüÂåñ
      window.dummyOverlays = {};
      window.enemyDirs = {};
      window.trampolineAngles = {};
      window.trampolinePowers = {};
      window.enemyProps = {};
      applyWorldToEditor([], {
        targetRows: window.rows,
        targetCols: window.cols,
        minRows: window.rows,
        minCols: window.cols
      });
    }
    loadWorldData();
    if (!window.enemyDirs) window.enemyDirs = {};

    // Ë®≠ÂÆö„ÅÆË™≠„ÅøËæº„Åø
    function loadEditorSettings() {
      const settings = JSON.parse(localStorage.getItem('gameSettings') || '{}');
      const keySettings = JSON.parse(localStorage.getItem('keySettings') || '{}');
      
      const defaults = {
        showGrid: true,
        snapToGrid: true
      };
      
      // „Éá„Éï„Ç©„É´„Éà„Ç≠„ÉºË®≠ÂÆö
      const defaultKeys = {
        editorLeft: 'a',
        editorRight: 'd',
        editorUp: 'w',
        editorDown: 's'
      };
      
      window.showGrid = settings.showGrid !== undefined ? settings.showGrid : defaults.showGrid;
      window.snapToGrid = settings.snapToGrid !== undefined ? settings.snapToGrid : defaults.snapToGrid;
      
      // „Ç®„Éá„Ç£„Çø„Éº„Ç≠„ÉºË®≠ÂÆö
      window.editorKeys = {};
      Object.keys(defaultKeys).forEach(key => {
        window.editorKeys[key] = keySettings[key] || defaultKeys[key];
      });
      
      console.log('„Ç®„Éá„Ç£„ÇøË®≠ÂÆöË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', {
        showGrid: window.showGrid, 
        snapToGrid: window.snapToGrid,
        keys: window.editorKeys
      });
    }
    loadEditorSettings();

    // Ë®≠ÂÆöÂ§âÊõ¥ÊôÇ„ÅÆ„É™„Ç¢„É´„Çø„Ç§„É†ÂèçÊò†
    window.addEventListener('storage', (e) => {
      if (e.key === 'gameSettings' || e.key === 'keySettings') {
        console.log('„Ç®„Éá„Ç£„ÇøË®≠ÂÆö„ÅåÂ§âÊõ¥„Åï„Çå„Åæ„Åó„Åü');
        loadEditorSettings();
      }
    });

    // imagesÔºà0:Ê∂à„Åó„Ç¥„É†, 1:Âú∞Èù¢, 2:Âúü, 3:Êïµ, 4:„Ç¥„Éº„É´, 5:Áü≥, 6:ÊØí, 7:„Åç„ÅÆ„Åì, 8:„Éè„Ç∑„Ç¥, 9:Âãï„ÅèÊïµÔºâ
    const images = {
      0: new Image(),
      1: new Image(),
      2: new Image(),
      3: new Image(),
      4: new Image(),
      5: new Image(),
      6: new Image(),
      7: new Image(),
      8: new Image(),
      9: new Image(),
      10:new Image(),
      11:new Image(), // breakable block
      12: new Image(), // rail1
      13: new Image(), // rail2
      14: new Image(), // rail3
      15: new Image(), // coin
      16: new Image(), // checkpoint
      17: new Image(), // goldgoal
      19: new Image(), // dummy block
      // Ëâ≤„Éñ„É≠„ÉÉ„ÇØÔºàID 20Ôºâ
      20: new Image(), // Ëâ≤„Éñ„É≠„ÉÉ„ÇØ
      21: new Image(),
      22: new Image(),
      23: new Image(),
      24: new Image(),
      25: new Image(),
      26: new Image(),
      27: new Image(),
      28: new Image(),
      29: new Image(),
      30: new Image(),
      31: new Image(), // hand.png
      32: new Image(), // clear.png
    };

    images[0].src = window.ASSETS_BASE64["eraser.png"];
    images[1].src = window.ASSETS_BASE64["ground.png"];
    images[2].src = window.ASSETS_BASE64["dirt.png"];
    images[3].src = window.ASSETS_BASE64["enemy.png"];
    images[4].src = window.ASSETS_BASE64["goal.png"];
    images[5].src = window.ASSETS_BASE64["stone.png"];
    images[6].src = window.ASSETS_BASE64["poison.png"];
    images[7].src = window.ASSETS_BASE64["trampoline.png"];
    images[8].src = window.ASSETS_BASE64["ladder.png"];
    images[9].src = window.ASSETS_BASE64["enemy-move1.png"];
    images[10].src = window.ASSETS_BASE64["spawn.png"];
    images[11].src = window.ASSETS_BASE64["breakblock.png"];
    images[12].src = window.ASSETS_BASE64["rail1.png"];
    images[13].src = window.ASSETS_BASE64["rail2.png"];
    images[14].src = window.ASSETS_BASE64["rail3.png"];
    images[15].src = window.ASSETS_BASE64["coin.png"];
    images[16].src = window.ASSETS_BASE64["checkpoint.png"];
    images[17].src = window.ASSETS_BASE64["goldgoal.png"];
    images[19].src = window.ASSETS_BASE64["dummy.png"];
    
    // Ëâ≤„Éñ„É≠„ÉÉ„ÇØÁîªÂÉè„ÅÆË®≠ÂÆöÔºàID 20-30Ôºâ
    images[20].src = window.ASSETS_BASE64["color.png"];
    images[21].src = window.ASSETS_BASE64["color1.png"];
    images[22].src = window.ASSETS_BASE64["color2.png"];
    images[23].src = window.ASSETS_BASE64["color3.png"];
    images[24].src = window.ASSETS_BASE64["color4.png"];
    images[25].src = window.ASSETS_BASE64["color5.png"];
    images[26].src = window.ASSETS_BASE64["color6.png"];
    images[27].src = window.ASSETS_BASE64["color7.png"];
    images[28].src = window.ASSETS_BASE64["color8.png"];
    images[29].src = window.ASSETS_BASE64["color9.png"];
    images[30].src = window.ASSETS_BASE64["color10.png"];

    images[31].src = window.ASSETS_BASE64["hand.png"];
    images[32].src = window.ASSETS_BASE64["clear.png"];

    // ÁîªÂÉèË™≠„ÅøËæº„Åø„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
    Object.values(images).forEach(img => {
      img.onerror = function() {
        console.warn('ÁîªÂÉèË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', img.src);
      };
    });

    // --- „Çπ„É≠„ÉÉ„ÉàÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É† ---
    let mainSlotIndices = [];
    let allSlotIndices = [];
    let selectedTile = 2;
    let isHandMode = false;

    // „Çπ„É≠„ÉÉ„Éà„Éê„ÉºÁîüÊàê
    const handSlot = document.getElementById("handSlot");
    const eraserSlot = document.getElementById("eraserSlot");
    const mainSlotBar = document.getElementById("mainSlotBar");
    handSlot.innerHTML = "";
    eraserSlot.innerHTML = "";
    mainSlotBar.innerHTML = "";

    // ÂÖ®„Éñ„É≠„ÉÉ„ÇØID„ÇíÁîüÊàêÔºàÊ∂à„Åó„Ç¥„É†„ÅØÈô§Â§ñÔºâ
    allSlotIndices = Array.from({length: 20}, (_, i) => i).filter(i => i !== 0 && i !== 1 && i !== 12 && i !== 13 && i !== 18);
    if (!allSlotIndices.includes(9)) allSlotIndices.push(9);
    for (let i = 20; i <= 30; i++) {
      allSlotIndices.push(i);
    }
    // ÂàùÊúü„É°„Ç§„É≥„Çπ„É≠„ÉÉ„ÉàË®≠ÂÆöÔºàÊúÄÂàù„ÅÆ8ÂÄãÔºâ
    mainSlotIndices = allSlotIndices.slice(0, 8);

    // „Éè„É≥„Éâ„Çπ„É≠„ÉÉ„ÉàÁîüÊàê
    function createHandSlot() {
      handSlot.innerHTML = "";
      const btn = document.createElement('button');
      btn.className = 'hand-btn';
      btn.innerHTML = '';
      btn.style.width = btn.style.height = '48px';
      btn.style.fontSize = Math.floor(48 * 0.7) + 'px';
      btn.style.backgroundImage = `url(${images[31].src})`;
      btn.style.backgroundSize = 'cover';
      btn.addEventListener('click', () => {
        isHandMode = !isHandMode;
        document.querySelectorAll('.slot-btn, .eraser-btn, .hand-btn').forEach(b => b.classList.remove('selected'));
        if (isHandMode) {
          btn.classList.add('selected');
        }
      });
      handSlot.appendChild(btn);
    }

    // Ê∂à„Åó„Ç¥„É†„Çπ„É≠„ÉÉ„ÉàÁîüÊàê
    function createEraserSlot() {
      eraserSlot.innerHTML = "";
      const btn = document.createElement('button');
      btn.className = 'eraser-btn';
      btn.innerHTML = '';
      btn.style.width = btn.style.height = '48px';
      btn.style.fontSize = Math.floor(48 * 0.7) + 'px';
      if (images[0]) {
        btn.style.backgroundImage = `url(${images[0].src})`;
        btn.style.backgroundSize = 'cover';
      } else {
        btn.textContent = '0';
      }
      btn.addEventListener('click', () => {
        selectedTile = 0;
        isHandMode = false;
        document.querySelectorAll('.slot-btn, .eraser-btn, .hand-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
      });
      eraserSlot.appendChild(btn);
    }

    // „É°„Ç§„É≥„Çπ„É≠„ÉÉ„ÉàÁîüÊàê
    function createMainSlotButtons() {
      mainSlotBar.innerHTML = "";
      mainSlotIndices.forEach((i, idx) => {
        const btn = document.createElement('button');
        btn.className = 'slot-btn';
        btn.innerHTML = '';
        btn.style.width = btn.style.height = '56px';
        btn.style.borderRadius = '12px';
        btn.style.border = '3px solid #1a2a4f';
        btn.style.background = '#eef';
        btn.style.padding = '0';
        btn.style.overflow = 'hidden';
        if (images[i]) {
          const img = document.createElement('img');
          img.src = images[i].src;
          img.width = img.height = 48;
          img.style.borderRadius = '10px';
          img.style.display = 'block';
          img.style.margin = '0 auto';
          btn.appendChild(img);
        } else {
          btn.textContent = i;
        }
        btn.addEventListener('click', () => {
          selectedTile = i;
          isHandMode = false;
          document.querySelectorAll('.slot-btn, .eraser-btn, .hand-btn').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
        });
        // --- Êâã„É¢„Éº„ÉâÊôÇ„ÅÆË©≥Á¥∞„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó ---
        btn.addEventListener('click', (e) => {
          if (isHandMode) {
            showBlockDetail(i);
            e.stopPropagation();
          }
        });
        mainSlotBar.appendChild(btn);
      });
      // ":"„Éú„Çø„É≥
      const moreBtn = document.createElement('button');
      moreBtn.className = 'more-btn';
      moreBtn.textContent = ':';
      moreBtn.onclick = openBlockSelector;
      mainSlotBar.appendChild(moreBtn);
    }

    // „Éñ„É≠„ÉÉ„ÇØÈÅ∏Êäû„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
    function openBlockSelector() {
      const selector = document.getElementById('blockSelector');
      const content = document.getElementById('blockSelectorContent');
      content.innerHTML = '';
      allSlotIndices.forEach(i => {
        const btn = document.createElement('button');
        btn.className = 'block-selector-btn';
        btn.innerHTML = '';
        if (images[i]) {
          btn.style.backgroundImage = `url(${images[i].src})`;
          btn.style.backgroundSize = 'cover';
        } else {
          btn.textContent = i;
        }
        btn.onclick = () => selectBlockFromModal(i);
        content.appendChild(btn);
      });
      selector.classList.add('show');
    }
    function closeBlockSelector() {
      document.getElementById('blockSelector').classList.remove('show');
    }
    function selectBlockFromModal(blockId) {
      selectedTile = blockId;
      moveToMainLeft(blockId);
      closeBlockSelector();
    }
    // „Éñ„É≠„ÉÉ„ÇØ‰ΩøÁî®ÊôÇ„ÅÆÂá¶ÁêÜ
    function useBlock(blockId) {
      const index = mainSlotIndices.indexOf(blockId);
      if (index > 0) {
        mainSlotIndices.splice(index, 1);
        mainSlotIndices.unshift(blockId);
        createMainSlotButtons();
      }
    }
    // „É°„Ç§„É≥„Çπ„É≠„ÉÉ„Éà„ÅÆ‰∏ÄÁï™Â∑¶„Å´ÁßªÂãï
    function moveToMainLeft(blockId) {
      const index = mainSlotIndices.indexOf(blockId);
      if (index === -1) {
        mainSlotIndices.unshift(blockId);
        if (mainSlotIndices.length > 8) {
          mainSlotIndices.pop();
        }
      } else {
        mainSlotIndices.splice(index, 1);
        mainSlotIndices.unshift(blockId);
      }
      createMainSlotButtons();
    }
    // ÂàùÊúüÁîüÊàê
    createHandSlot();
    createEraserSlot();
    createMainSlotButtons();
    // ÂàùÊúüÈÅ∏ÊäûÁä∂ÊÖã„ÇíË®≠ÂÆö
    document.querySelectorAll('.slot-btn, .eraser-btn, .hand-btn').forEach((b, idx) => {
      if (idx === 0 && isHandMode) b.classList.add('selected');
      else if (idx === 1 && selectedTile === 0) b.classList.add('selected');
      else if (mainSlotIndices[idx-2] === selectedTile) b.classList.add('selected');
    });

    // „ÉØ„Éº„É´„ÉâË™≠„ÅøËæº„ÅøÊôÇ„Å´Êïµ„ÅÆË®≠ÂÆö„ÇíUI„Å´ÂèçÊò†„Åô„ÇãÈñ¢Êï∞
    window.updateEnemySettingsUI = function() {
      if (!window.enemyProps) return;
      
      // ÁèæÂú®Ë°®Á§∫„Åï„Çå„Å¶„ÅÑ„ÇãÊïµ„ÅÆË©≥Á¥∞„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Åå„ÅÇ„Çå„Å∞Êõ¥Êñ∞
      const popup = document.getElementById('blockDetailPopup');
      if (popup && popup.style.display === 'flex' && window.lastDetailRowCol) {
        const key = window.lastDetailRowCol;
        const props = window.enemyProps[key];
        if (props) {
          // ‰∏ä„Éú„Çø„É≥
          const topBtn = document.getElementById('topBtn');
          if (topBtn) {
            if (props.deathTop) {
              topBtn.style.backgroundColor = '#ff4136';
              topBtn.textContent = 'üü•';
              topBtn.title = '‰∏ä:Ê≠ª‰∫°Âà§ÂÆöONÔºà„ÇØ„É™„ÉÉ„ÇØ„ÅßÂΩì„Åü„ÇäÂà§ÂÆö„Å´Â§âÊõ¥Ôºâ';
            } else if (props.hitTop) {
              topBtn.style.backgroundColor = '#2ecc40';
              topBtn.textContent = 'üü©';
              topBtn.title = '‰∏ä:ÂΩì„Åü„ÇäÂà§ÂÆöONÔºà„ÇØ„É™„ÉÉ„ÇØ„ÅßÊ≠ª‰∫°Âà§ÂÆö„Å´Â§âÊõ¥Ôºâ';
            }
          }
          
          // Â∑¶„Éú„Çø„É≥
          const leftBtn = document.getElementById('leftBtn');
          if (leftBtn) {
            if (props.deathSide) {
              leftBtn.style.backgroundColor = '#ff4136';
              leftBtn.textContent = 'üü•';
              leftBtn.title = 'Â∑¶:Ê≠ª‰∫°Âà§ÂÆöONÔºà„ÇØ„É™„ÉÉ„ÇØ„ÅßÂΩì„Åü„ÇäÂà§ÂÆö„Å´Â§âÊõ¥Ôºâ';
            } else if (props.hitSide) {
              leftBtn.style.backgroundColor = '#2ecc40';
              leftBtn.textContent = 'üü©';
              leftBtn.title = 'Â∑¶:ÂΩì„Åü„ÇäÂà§ÂÆöONÔºà„ÇØ„É™„ÉÉ„ÇØ„ÅßÊ≠ª‰∫°Âà§ÂÆö„Å´Â§âÊõ¥Ôºâ';
            }
          }
          
          // Âè≥„Éú„Çø„É≥
          const rightBtn = document.getElementById('rightBtn');
          if (rightBtn) {
            if (props.deathSide) {
              rightBtn.style.backgroundColor = '#ff4136';
              rightBtn.textContent = 'üü•';
              rightBtn.title = 'Âè≥:Ê≠ª‰∫°Âà§ÂÆöONÔºà„ÇØ„É™„ÉÉ„ÇØ„ÅßÂΩì„Åü„ÇäÂà§ÂÆö„Å´Â§âÊõ¥Ôºâ';
            } else if (props.hitSide) {
              rightBtn.style.backgroundColor = '#2ecc40';
              rightBtn.textContent = 'üü©';
              rightBtn.title = 'Âè≥:ÂΩì„Åü„ÇäÂà§ÂÆöONÔºà„ÇØ„É™„ÉÉ„ÇØ„ÅßÊ≠ª‰∫°Âà§ÂÆö„Å´Â§âÊõ¥Ôºâ';
            }
          }
          
          // ‰∏ã„Éú„Çø„É≥
          const bottomBtn = document.getElementById('bottomBtn');
          if (bottomBtn) {
            if (props.deathBottom) {
              bottomBtn.style.backgroundColor = '#ff4136';
              bottomBtn.textContent = 'üü•';
              bottomBtn.title = '‰∏ã:Ê≠ª‰∫°Âà§ÂÆöONÔºà„ÇØ„É™„ÉÉ„ÇØ„ÅßÂΩì„Åü„ÇäÂà§ÂÆö„Å´Â§âÊõ¥Ôºâ';
            } else if (props.hitBottom) {
              bottomBtn.style.backgroundColor = '#2ecc40';
              bottomBtn.textContent = 'üü©';
              bottomBtn.title = '‰∏ã:ÂΩì„Åü„ÇäÂà§ÂÆöONÔºà„ÇØ„É™„ÉÉ„ÇØ„ÅßÊ≠ª‰∫°Âà§ÂÆö„Å´Â§âÊõ¥Ôºâ';
            }
          }
        }
      }
    }

    // „ÉØ„Éº„É´„ÉâË™≠„ÅøËæº„ÅøÂæå„Å´Êïµ„ÅÆË®≠ÂÆö„ÇíUI„Å´ÂèçÊò†
    updateEnemySettingsUI();

    function showMessage(text) {
      const msg = document.getElementById("message");
      msg.innerText = text;
      msg.style.display = "block";
      setTimeout(() => { msg.style.display = "none"; }, 2000);
    }

function showConfirm(text, onYes, onNo) {
  let old = document.getElementById("confirmDialog");
  if (old) old.remove();
  const dialog = document.createElement("div");
  dialog.id = "confirmDialog";
  dialog.style.position = "fixed";
  dialog.style.top = "50%";
  dialog.style.left = "50%";
  dialog.style.transform = "translate(-50%,-50%)";
  dialog.style.background = "#fff";
  dialog.style.color = "#1a2a4f";
  dialog.style.padding = "24px 32px";
  dialog.style.borderRadius = '18px'; // ‚Üê„Çà„ÇäÂ§ß„Åç„Å™‰∏∏„Åø„ÇÇOK
  dialog.style.boxShadow = "0 6px 20px rgba(0,0,0,0.15)";
  dialog.style.zIndex = "99999";
  dialog.style.fontWeight = "bold";
  dialog.style.fontFamily = "\"Yu Gothic\", sans-serif";
  dialog.innerHTML = `
    <div style="margin-bottom:18px;font-size:18px;text-align:center;">${text}</div>
    <div style="display:flex;gap:24px;justify-content:center;">
      <button id="yesBtn" style="padding:10px 32px;border:none;border-radius:12px;background:#4466ff;color:#fff;font-size:16px;font-weight:bold;cursor:pointer;box-shadow:0 1px 4px #2235;">„ÅØ„ÅÑ</button>
      <button id="noBtn" style="padding:10px 32px;border:none;border-radius:12px;background:#ccc;color:#1a2a4f;font-size:16px;font-weight:bold;cursor:pointer;">„ÅÑ„ÅÑ„Åà</button>
    </div>
  `;
  document.body.appendChild(dialog);
  document.getElementById("yesBtn").onclick = () => {
    dialog.remove();
    if (onYes) onYes();
  };
  document.getElementById("noBtn").onclick = () => {
    dialog.remove();
    if (onNo) onNo();
  };
}


    // „Éú„Çø„É≥„Ç§„Éô„É≥„Éà
    document.getElementById("homeButton").onclick = () => {
      showConfirm("„Éõ„Éº„É†„Å´Êàª„Çä„Åæ„Åô„ÅãÔºü", () => {
        saveMap();
        location.href = 'home.html';
      });
    };
    document.getElementById("clearButton").onclick = () => {
      showConfirm("„Éû„ÉÉ„Éó„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ", () => {
        saveMapState(); // „ÇØ„É™„Ç¢Ââç„ÅÆÁä∂ÊÖã„Çí‰øùÂ≠ò
        for (let r = 0; r < rows; r++) {
          for (let c = 0; c < cols; c++) {
            map[r][c] = 0;
            if (window.markTileAndNeighborsDirty) window.markTileAndNeighborsDirty(r, c);
          }
        }
        window.dummyOverlays = {};
        if (window.invalidateStaticChunks) window.invalidateStaticChunks();
        showMessage("„Éû„ÉÉ„Éó„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„ÅüÔºÅ");
      });
    };
    document.getElementById("undoButton").onclick = undo;
    document.getElementById("redoButton").onclick = redo;
    document.getElementById("exportButton").onclick = exportWorldData;
      document.getElementById("importButton").onclick = () => {
    document.getElementById("fileInput").click();
  };
  
  
    
    // „ÉØ„Éº„É´„ÉâÊ®™ÂπÖË®≠ÂÆö„ÅÆÂàùÊúüÂåñ
  // Ê®™ÂπÖÂ§âÊõ¥UI„Éª„Ç§„Éô„É≥„Éà„ÅØÂªÉÊ≠¢

    // „Éï„Ç°„Ç§„É´ÈÅ∏ÊäûÊôÇ„ÅÆ„Ç§„Éô„É≥„Éà
    document.getElementById("fileInput").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        importWorldData(file);
        // „Éï„Ç°„Ç§„É´ÂÖ•Âäõ„Çí„É™„Çª„ÉÉ„ÉàÔºàÂêå„Åò„Éï„Ç°„Ç§„É´„ÇíÂÜçÂ∫¶ÈÅ∏Êäû„Åß„Åç„Çã„Çà„ÅÜ„Å´Ôºâ
        e.target.value = "";
      }
    });

    // „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
    document.addEventListener("keydown", (e) => {
      if (e.ctrlKey || e.metaKey) { // Ctrl (Windows) „Åæ„Åü„ÅØ Cmd (Mac)
        if (e.key === "z") {
          e.preventDefault();
          undo();
        } else if (e.key === "y") {
          e.preventDefault();
          redo();
        }
      }
    });

    camera = { x: 0, y: 0 };
    cameraReady = true;
    if (typeof updateCameraBounds === "function") updateCameraBounds();
    if (typeof draw === "function") draw();
    const cameraSpeed = 6; // „Ç´„É°„É©ÁßªÂãïÈÄüÂ∫¶Ôºàver.2„ÅÆ2ÂÄç„ÅÆÈÄüÂ∫¶Ôºâ
    
    // „Ç≠„ÉºÁä∂ÊÖã„ÅÆÂàùÊúüÂåñ
    if (!window.keys) window.keys = {};
    
    // keys„ÅØeditor-common.js„ÅßÂÆöÁæ©Ê∏à„Åø
    // „Ç®„Éá„Ç£„ÇøÁî®„ÅÆ„Ç≠„Éº„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíËøΩÂä†
    document.addEventListener("keydown", e => {
      if (window.keys) window.keys[e.key] = true;
      
      // „Ç®„Éá„Ç£„Çø„ÉºÂ∞ÇÁî®„ÅÆ„Ç´„É°„É©ÁßªÂãïÔºà„Ç≠„ÉºÁä∂ÊÖã„ÇíË®òÈå≤Ôºâ
      // ÂÆüÈöõ„ÅÆÁßªÂãï„ÅØupdateÈñ¢Êï∞„ÅßÈÄ£Á∂öÁöÑ„Å´Âá¶ÁêÜ
    });
    document.addEventListener("keyup", e => {
      if (window.keys) window.keys[e.key] = false;
    });
    
    // „Ç´„É°„É©„ÅÆÂ¢ÉÁïåÂà∂Èôê„ÇíÊõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞
    function updateCameraBounds() {
      if (!window.canvas || !camera) return;
      
      const canvasWidth = window.canvas.width;
      const canvasHeight = window.canvas.height;
      
      // „Éû„ÉÉ„Éó„ÅÆÂ¢ÉÁïå„ÇíË®àÁÆóÔºà„Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Çí‰ΩøÁî®Ôºâ
      const mapWidth = window.cols * TILE_SIZE;
      const mapHeight = rows * TILE_SIZE;
      
      // „Éû„ÉÉ„ÉóÁØÑÂõ≤ÂÜÖ„Å´Âà∂Èôê
      const maxCameraX = Math.max(0, mapWidth - canvasWidth);
      const maxCameraY = Math.max(0, mapHeight - canvasHeight);
      
      camera.x = Math.max(0, Math.min(camera.x, maxCameraX));
      camera.y = Math.max(0, Math.min(camera.y, maxCameraY));
    }
    


    let isMouseDown = false;
    let hasSavedState = false; // „Éâ„É©„ÉÉ„Ç∞‰∏≠„ÅÆÁä∂ÊÖã‰øùÂ≠ò„Éï„É©„Ç∞
    let lastOutOfBoundsWarning = 0;
    
        // canvas„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅÆ„Åø„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíËøΩÂä†
    if (window.canvas) {
      window.canvas.addEventListener("mousedown", e => {
      isMouseDown = true;
      hasSavedState = false; // „Éâ„É©„ÉÉ„Ç∞ÈñãÂßãÊôÇ„Å´„É™„Çª„ÉÉ„Éà
    });
      window.canvas.addEventListener("mouseup", e => {
      isMouseDown = false;
      hasSavedState = false; // „Éâ„É©„ÉÉ„Ç∞ÁµÇ‰∫ÜÊôÇ„Å´„É™„Çª„ÉÉ„Éà
    });
      window.canvas.addEventListener("mouseleave", e => {
      isMouseDown = false;
      hasSavedState = false; // „Éû„Ç¶„Çπ„ÅåÈõ¢„Çå„ÅüÊôÇ„ÇÇ„É™„Çª„ÉÉ„Éà
    });

      window.canvas.addEventListener("mousemove", placeTile);
      window.canvas.addEventListener("click", placeTile);
    }

    // „Çø„ÉÉ„ÉÅ„Ç§„Éô„É≥„ÉàÂØæÂøú
    let isTouchDown = false;
    let lastPlacedTile = { row: -1, col: -1 }; // ÊúÄÂæå„Å´ÈÖçÁΩÆ„Åó„Åü„Çø„Ç§„É´„ÅÆ‰ΩçÁΩÆ
    let lastTouchTime = 0; // ÊúÄÂæå„ÅÆ„Çø„ÉÉ„ÉÅÂá¶ÁêÜÊôÇÈñì
    const touchThrottle = 50; // „Çø„ÉÉ„ÉÅÂá¶ÁêÜ„ÅÆÈñìÈöî„Çí50ms„Å´Ë™øÊï¥Ôºà„Çà„ÇäÂèçÂøú„Åó„ÇÑ„Åô„ÅèÔºâ
    
        if (window.canvas) {
      window.canvas.addEventListener("touchstart", e => {
      e.preventDefault(); // „Éá„Éï„Ç©„É´„Éà„ÅÆ„Çπ„ÇØ„É≠„Éº„É´„ÇíÈò≤„Åê
      isTouchDown = true;
      hasSavedState = false; // „Çø„ÉÉ„ÉÅÈñãÂßãÊôÇ„Å´„É™„Çª„ÉÉ„Éà
      lastPlacedTile = { row: -1, col: -1 }; // „Çø„ÉÉ„ÉÅÈñãÂßãÊôÇ„Å´„É™„Çª„ÉÉ„Éà
    });
      window.canvas.addEventListener("touchend", e => {
      e.preventDefault();
      isTouchDown = false;
      hasSavedState = false; // „Çø„ÉÉ„ÉÅÁµÇ‰∫ÜÊôÇ„Å´„É™„Çª„ÉÉ„Éà
      lastPlacedTile = { row: -1, col: -1 }; // „Çø„ÉÉ„ÉÅÁµÇ‰∫ÜÊôÇ„Å´„É™„Çª„ÉÉ„Éà
    });
      window.canvas.addEventListener("touchcancel", e => {
      e.preventDefault();
      isTouchDown = false;
      hasSavedState = false; // „Çø„ÉÉ„ÉÅ„Ç≠„É£„É≥„Çª„É´ÊôÇ„ÇÇ„É™„Çª„ÉÉ„Éà
      lastPlacedTile = { row: -1, col: -1 }; // „Çø„ÉÉ„ÉÅ„Ç≠„É£„É≥„Çª„É´ÊôÇ„ÇÇ„É™„Çª„ÉÉ„Éà
    });

      window.canvas.addEventListener("touchmove", e => {
      e.preventDefault(); // „Éá„Éï„Ç©„É´„Éà„ÅÆ„Çπ„ÇØ„É≠„Éº„É´„ÇíÈò≤„Åê
      const now = performance.now();
      if (isTouchDown && e.touches.length > 0 && now - lastTouchTime > touchThrottle) {
        const touch = e.touches[0];
        placeTileTouch(touch);
        lastTouchTime = now;
      }
    });
    }

    // --- „Éà„É©„É≥„Éù„É™„É≥ËßíÂ∫¶ÁÆ°ÁêÜ ---
    if (!window.trampolineAngles) window.trampolineAngles = {};

    function placeTile(e) {
      if (!isMouseDown && e.type !== "click") return;
      if (!window.canvas) return;
      
      // „Ç≠„É£„É≥„Éê„Çπ„ÅÆÂÆüÈöõ„ÅÆ„Çµ„Ç§„Ç∫„Å®Ë°®Á§∫„Çµ„Ç§„Ç∫„ÇíÂèñÂæó
      const rect = window.canvas.getBoundingClientRect();
      
      // „Éû„Ç¶„Çπ‰ΩçÁΩÆ„Çí„Ç≠„É£„É≥„Éê„ÇπÂ∫ßÊ®ôÁ≥ª„Å´Â§âÊèõ
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;
      
      // „Ç≠„É£„É≥„Éê„Çπ„ÅÆË°®Á§∫„Çµ„Ç§„Ç∫„Å®ÂÆüÈöõ„ÅÆ„Çµ„Ç§„Ç∫„ÅÆÊØîÁéá„ÇíË®àÁÆó
      const scaleX = window.canvas.width / rect.width;
      const scaleY = window.canvas.height / rect.height;
      
      // „Çπ„Ç±„Éº„É´„ÇíËÄÉÊÖÆ„Åó„Å¶„Ç≠„É£„É≥„Éê„ÇπÂ∫ßÊ®ô„ÇíË®àÁÆó
      const canvasX = mouseX * scaleX;
      const canvasY = mouseY * scaleY;
      
      // „Ç´„É°„É©‰ΩçÁΩÆ„ÇíËÄÉÊÖÆ„Åó„Å¶„ÉØ„Éº„É´„ÉâÂ∫ßÊ®ô„ÇíË®àÁÆó
      const worldX = canvasX + camera.x;
      const worldY = canvasY + camera.y;
      
      // „Çø„Ç§„É´Â∫ßÊ®ô„ÇíË®àÁÆó
      const col = Math.floor(worldX / TILE_SIZE);
      const row = Math.floor(worldY / TILE_SIZE);
      
      // „Éá„Éê„ÉÉ„Ç∞Áî®„É≠„Ç∞ÔºàÈñãÁô∫ÊôÇ„ÅÆ„ÅøÔºâ
      if (window.debugMode) {
        console.log('Â∫ßÊ®ôÂ§âÊèõ„Éá„Éê„ÉÉ„Ç∞:', {
          mouseX, mouseY,
          scaleX, scaleY,
          canvasX, canvasY,
          cameraX: camera.x, cameraY: camera.y,
          worldX, worldY,
          col, row,
          tileSize: TILE_SIZE
        });
      }
      
      const maxCols = window.cols;
      const maxRows = window.rows;
      if (col < 0 || row < 0 || col >= maxCols || row >= maxRows) {
        const now = performance.now();
        if (col >= 0 && row >= 0 && now - lastOutOfBoundsWarning > 800) {
          showMessage("Á∑®ÈõÜ„Åß„Åç„ÇãÁØÑÂõ≤Â§ñ„Åß„Åô");
          lastOutOfBoundsWarning = now;
        }
        return;
      }

      if (!map[row]) return;

      if (isHandMode) {
        const blockId = map[row][col];
        if (blockId !== 0) {
          window.lastDetailRowCol = `${row},${col}`;
          showBlockDetail(blockId);
        }
        return;
      }

      // „Éâ„É©„ÉÉ„Ç∞‰∏≠„ÅÆÊúÄÂàù„ÅÆ1Âõû„Å†„Åë„ÄÅ„Åæ„Åü„ÅØ„ÇØ„É™„ÉÉ„ÇØÊôÇ„Å´Áä∂ÊÖã„Çí‰øùÂ≠ò
      if (!hasSavedState || e.type === "click") {
        saveMapState();
        hasSavedState = true;
      }
      if (selectedTile === 10) {
        for (let r = 0; r < rows; r++) {
          for (let c = 0; c < cols; c++) {
            if (map[r][c] === 10) map[r][c] = 0;
          }
        }
        map[row][col] = 10;
      } else if (selectedTile === 19) { // „ÉÄ„Éü„Éº„Éñ„É≠„ÉÉ„ÇØ
        // „ÉÄ„Éü„Éº„Éñ„É≠„ÉÉ„ÇØ„ÅØÊó¢Â≠ò„Éñ„É≠„ÉÉ„ÇØ„ÅÆ‰∏ä„Å´„ÅÆ„ÅøÁΩÆ„Åë„Çã
        const existingTile = map[row][col];
        if (existingTile !== 0 && existingTile !== 19) {
          map[row][col] = 19;
          if (!window.dummyOverlays) window.dummyOverlays = {};
          window.dummyOverlays[`${row},${col}`] = existingTile;
        }
      } else if (selectedTile === 14) {
        map[row][col] = 14;
        updateRailTiles(row, col);
        if (col > 0) updateRailTiles(row, col - 1);
        if (col < cols - 1) updateRailTiles(row, col + 1);
      } else if (selectedTile === 2) {
        if (row === 0 || map[row-1][col] === 0) {
          map[row][col] = 1;
        } else {
          map[row][col] = 2;
        }
          // Ë®≠ÁΩÆÁõ¥Âæå„Å´Ëçâ„ÉªÂúü„ÅÆËá™ÂãïÂ§âÊèõÂá¶ÁêÜ„ÇíÂøÖ„ÅöÂÆüË°å
        for (let r = 0; r < rows; r++) {
          for (let c = 0; c < cols; c++) {
            if (map[r][c] === 1 && r > 0 && map[r-1][c] !== 0) {
              const tileAbove = map[r-1][c];
              if (tileAbove !== 4 && tileAbove !== 15 && tileAbove !== 16 && tileAbove !== 17 && tileAbove !== 10 && tileAbove !== 3) {
                map[r][c] = 2;
                if (window.markTileAndNeighborsDirty) window.markTileAndNeighborsDirty(r, c);
              }
            }
            if (map[r][c] === 2 && (r === 0 || map[r-1][c] === 0)) {
              map[r][c] = 1;
              if (window.markTileAndNeighborsDirty) window.markTileAndNeighborsDirty(r, c);
            }
          }
        }
      } else if (selectedTile === 9) {
        map[row][col] = 9;
        const key = `${row},${col}`;
        window.enemyDirs[key] = 1;
        draw();
      } else if (selectedTile === 7) {
        // „Éà„É©„É≥„Éù„É™„É≥„ÅÆÂ†¥Âêà„ÅØËßíÂ∫¶„Å®Âäõ„ÇíÂàùÊúüÂåñ
        map[row][col] = 7;
        const key = `${row},${col}`;
        if (!window.trampolineAngles) window.trampolineAngles = {};
        if (!window.trampolinePowers) window.trampolinePowers = {};
        window.trampolineAngles[key] = 0; // „Éá„Éï„Ç©„É´„Éà„ÅØ‰∏äÂêë„ÅçÔºà0¬∞Ôºâ
        window.trampolinePowers[key] = 2.2; // „Éá„Éï„Ç©„É´„Éà„ÅØ2.2ÂÄç
      } else {
        map[row][col] = selectedTile;
      }
      if (window.markTileAndNeighborsDirty) {
        window.markTileAndNeighborsDirty(row, col);
      }
      draw();
    }

    function placeTileTouch(touch) {
      if (!window.canvas) return;
      
      // „Ç≠„É£„É≥„Éê„Çπ„ÅÆÂÆüÈöõ„ÅÆ„Çµ„Ç§„Ç∫„Å®Ë°®Á§∫„Çµ„Ç§„Ç∫„ÇíÂèñÂæó
      const rect = window.canvas.getBoundingClientRect();
      
      // „Çø„ÉÉ„ÉÅ‰ΩçÁΩÆ„Çí„Ç≠„É£„É≥„Éê„ÇπÂ∫ßÊ®ôÁ≥ª„Å´Â§âÊèõ
      const touchX = touch.clientX - rect.left;
      const touchY = touch.clientY - rect.top;
      
      // „Ç≠„É£„É≥„Éê„Çπ„ÅÆË°®Á§∫„Çµ„Ç§„Ç∫„Å®ÂÆüÈöõ„ÅÆ„Çµ„Ç§„Ç∫„ÅÆÊØîÁéá„ÇíË®àÁÆó
      const scaleX = window.canvas.width / rect.width;
      const scaleY = window.canvas.height / rect.height;
      
      // „Çπ„Ç±„Éº„É´„ÇíËÄÉÊÖÆ„Åó„Å¶„Ç≠„É£„É≥„Éê„ÇπÂ∫ßÊ®ô„ÇíË®àÁÆó
      const canvasX = touchX * scaleX;
      const canvasY = touchY * scaleY;
      
      // „Ç´„É°„É©‰ΩçÁΩÆ„ÇíËÄÉÊÖÆ„Åó„Å¶„ÉØ„Éº„É´„ÉâÂ∫ßÊ®ô„ÇíË®àÁÆó
      const worldX = canvasX + camera.x;
      const worldY = canvasY + camera.y;
      
      // „Çø„Ç§„É´Â∫ßÊ®ô„ÇíË®àÁÆó
      const col = Math.floor(worldX / TILE_SIZE);
      const row = Math.floor(worldY / TILE_SIZE);
      
      // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÁ∑©ÂíåÔºàÂêå„Åò„Çø„Ç§„É´„Åß„ÇÇÂ∞ë„ÅóÈñìÈöî„ÇíÁ©∫„Åë„Çå„Å∞ÈÖçÁΩÆÂèØËÉΩÔºâ
      const now = performance.now();
      if (col === lastPlacedTile.col && row === lastPlacedTile.row && now - lastTouchTime < 100) {
        return;
      }
      
      const maxCols = window.cols;
      const maxRows = window.rows;
      if (col < 0 || row < 0 || col >= maxCols || row >= maxRows) {
        if (col >= 0 && row >= 0 && now - lastOutOfBoundsWarning > 800) {
          showMessage("Á∑®ÈõÜ„Åß„Åç„ÇãÁØÑÂõ≤Â§ñ„Åß„Åô");
          lastOutOfBoundsWarning = now;
        }
        return;
      }

      if (!map[row]) return;

      if (isHandMode) {
        const blockId = map[row][col];
        if (blockId !== 0) {
          window.lastDetailRowCol = `${row},${col}`;
          showBlockDetail(blockId);
        }
        return;
      }
      lastPlacedTile = { row, col };
      lastTouchTime = now;
      
      if (!hasSavedState) {
        saveMapState();
        hasSavedState = true;
      }
      if (selectedTile === 10) {
        for (let r = 0; r < rows; r++) {
          for (let c = 0; c < cols; c++) {
            if (map[r][c] === 10) map[r][c] = 0;
          }
        }
        map[row][col] = 10;
      } else if (selectedTile === 19) {
        const existingTile = map[row][col];
        if (existingTile !== 0 && existingTile !== 19) {
          map[row][col] = 19;
          if (!window.dummyOverlays) window.dummyOverlays = {};
          window.dummyOverlays[`${row},${col}`] = existingTile;
        }
      } else if (selectedTile === 14) {
        map[row][col] = 14;
        updateRailTiles(row, col);
        if (col > 0) updateRailTiles(row, col - 1);
        if (col < cols - 1) updateRailTiles(row, col + 1);
      } else if (selectedTile === 2) {
        if (row === 0 || map[row-1][col] === 0) {
          map[row][col] = 1;
        } else {
          map[row][col] = 2;
        }
        for (let r = 0; r < rows; r++) {
          for (let c = 0; c < cols; c++) {
            if (map[r][c] === 1 && r > 0 && map[r-1][c] !== 0) {
              map[r][c] = 2;
            }
            if (map[r][c] === 2 && (r === 0 || map[r-1][c] === 0)) {
              map[r][c] = 1;
            }
          }
        }
      } else if (selectedTile === 9) {
        map[row][col] = 9;
        const key = `${row},${col}`;
        window.enemyDirs[key] = 1;
        draw();
      } else if (selectedTile === 7) {
        // „Éà„É©„É≥„Éù„É™„É≥„ÅÆÂ†¥Âêà„ÅØËßíÂ∫¶„Å®Âäõ„ÇíÂàùÊúüÂåñ
        map[row][col] = 7;
        const key = `${row},${col}`;
        if (!window.trampolineAngles) window.trampolineAngles = {};
        if (!window.trampolinePowers) window.trampolinePowers = {};
        window.trampolineAngles[key] = 0; // „Éá„Éï„Ç©„É´„Éà„ÅØ‰∏äÂêë„ÅçÔºà0¬∞Ôºâ
        window.trampolinePowers[key] = 2.2; // „Éá„Éï„Ç©„É´„Éà„ÅØ2.2ÂÄç
      } else {
        map[row][col] = selectedTile;
      }
      if (window.markTileAndNeighborsDirty) {
        window.markTileAndNeighborsDirty(row, col);
      }
      draw(); // „Çø„Ç§„É´ÈÖçÁΩÆÂæå„Å´ÊèèÁîª„ÇíÊõ¥Êñ∞
    }

    // „É¨„Éº„É´ÈÄ£ÁµêÁä∂ÊÖã„Å´Âøú„Åò„Å¶„Çø„Ç§„É´ID„ÇíËá™Âãï„ÅßÁΩÆÊèõ
    function updateRailTiles(row, col) {
      if (map[row][col] < 12 || map[row][col] > 14) return;
      const left = col > 0 && map[row][col - 1] >= 12 && map[row][col - 1] <= 14;
      const right = col < cols - 1 && map[row][col + 1] >= 12 && map[row][col + 1] <= 14;
      if (!left && !right) {
        map[row][col] = 14; // Âçò‰Ωì
      } else if (left && right) {
        map[row][col] = 12; // ‰∏≠Èñì
      } else if (right) {
        map[row][col] = 13; // Âè≥Á´Ø
      } else if (left) {
        map[row][col] = 13; // Â∑¶Á´ØÔºàÂèçËª¢ÊèèÁîª„ÅØÊèèÁîªÊôÇ„Å´Ôºâ
      }
      if (window.markTileAndNeighborsDirty) {
        window.markTileAndNeighborsDirty(row, col);
      }
    }

    function update() {
      // ÈÄ£Á∂öÁöÑ„Å™„Ç´„É°„É©ÁßªÂãïÔºàver.2„Çπ„Çø„Ç§„É´Ôºâ
      if (window.keys) {
        if (window.keys['a'] || window.keys['A']) {
          camera.x -= cameraSpeed;
        }
        if (window.keys['d'] || window.keys['D']) {
          camera.x += cameraSpeed;
        }
        if (window.keys['w'] || window.keys['W']) {
          camera.y -= cameraSpeed;
        }
        if (window.keys['s'] || window.keys['S']) {
          camera.y += cameraSpeed;
        }
      }
      
      // „Ç´„É°„É©„ÅÆÂ¢ÉÁïåÂà∂Èôê„ÇíÊõ¥Êñ∞
      updateCameraBounds();
      
      // Âúü„Å®Ëçâ„ÅÆÂ§âÊèõÂá¶ÁêÜÔºà0.5ÁßíÈñì„Å´‰∏ÄÂ∫¶Ôºâ
      if (!window.groundDirtTimer) window.groundDirtTimer = 0;
      window.groundDirtTimer++;
      if (window.groundDirtTimer >= 30) { // 60fps * 0.5Áßí = 30„Éï„É¨„Éº„É†
        for (let r = 0; r < rows; r++) {
          for (let c = 0; c < cols; c++) {
            if (map[r][c] === 1 && r > 0 && map[r-1][c] !== 0) {
              // „Çπ„Ç≥„Ç¢„Çí„Ç≤„ÉÉ„Éà„Åß„Åç„Çã„Éñ„É≠„ÉÉ„ÇØ„ÄÅ„ÉÅ„Çß„ÉÉ„ÇØ„Éù„Ç§„É≥„Éà„ÄÅ„Çπ„Éù„Éº„É≥Âú∞ÁÇπ„ÄÅÂãï„ÅèÊïµ„ÅØÈô§Â§ñ
              const tileAbove = map[r-1][c];
              if (tileAbove !== 4 && tileAbove !== 15 && tileAbove !== 16 && tileAbove !== 17 && tileAbove !== 10 && tileAbove !== 3) {
                map[r][c] = 2; // ground„ÅÆ‰∏ä„Å´‰Ωï„Åã„ÅÇ„Çå„Å∞dirt„Å´Â§âÊèõ
              }
            }
            if (map[r][c] === 2 && (r === 0 || map[r-1][c] === 0)) {
              map[r][c] = 1; // dirt„ÅÆ‰∏ä„Å´‰Ωï„ÇÇ„Å™„Åë„Çå„Å∞ground„Å´Â§âÊèõ
            }
          }
        }
        window.groundDirtTimer = 0;
      }
    }
    

    function draw() {
      if (!window.canvas || !window.ctx) return; // canvas„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØÊèèÁîª„Çí„Çπ„Ç≠„ÉÉ„Éó
      window.ctx.clearRect(0, 0, window.canvas.width, window.canvas.height);
      window.ctx.fillStyle = "#aee";
      window.ctx.fillRect(0, 0, window.canvas.width, window.canvas.height);
      
      // „Ç´„É°„É©ÁßªÂãï„ÇíÈÅ©Áî®
      window.ctx.save();
      window.ctx.translate(-camera.x, -camera.y);

      const canvasWidth = window.canvas.width;
      const canvasHeight = window.canvas.height;
      const paddingTiles = 2;
      const visibleColStart = Math.max(0, Math.floor(camera.x / TILE_SIZE) - paddingTiles);
      const visibleColEnd = Math.min(window.cols, Math.ceil((camera.x + canvasWidth) / TILE_SIZE) + paddingTiles);
      const visibleRowStart = Math.max(0, Math.floor(camera.y / TILE_SIZE) - paddingTiles);
      const visibleRowEnd = Math.min(window.rows, Math.ceil((camera.y + canvasHeight) / TILE_SIZE) + paddingTiles);
      
      // 1. ÈÄöÂ∏∏„ÅÆ„Çø„Ç§„É´„ÇíÊèèÁîªÔºà„ÉÄ„Éü„Éº„Éñ„É≠„ÉÉ„ÇØ„ÅØÈô§Â§ñÔºâ
      for (let r = visibleRowStart; r < Math.min(visibleRowEnd, map.length); r++) {
        const rowTiles = map[r];
        if (!rowTiles) continue;
        for (let c = visibleColStart; c < Math.min(visibleColEnd, rowTiles.length); c++) {
          const tile = rowTiles[c];
          const x = c * TILE_SIZE;
          const y = r * TILE_SIZE;
          if (tile === 19) continue; // „ÉÄ„Éü„Éº„Éñ„É≠„ÉÉ„ÇØ„ÅØÂæå„ÅßÊèèÁîª
          if (tile === 7) {
            // „Éà„É©„É≥„Éù„É™„É≥„ÅØËßíÂ∫¶„Å´Âøú„Åò„Å¶ÂõûËª¢ÊèèÁîª
            const key = `${r},${c}`;
            const angle = (window.trampolineAngles[key] || 0) * Math.PI / 180;
            ctx.save();
            ctx.translate(x + TILE_SIZE/2, y + TILE_SIZE/2);
            ctx.rotate(angle);
            // Á∏¶Èï∑„Å´ÊèèÁîªÔºà‰∏≠ÂøÉÂü∫Ê∫ñ„Åß‰∏ãÊñπÂêë„Å´‰º∏„Å∞„ÅôÔºâ
            ctx.drawImage(images[7], -TILE_SIZE/2, -TILE_SIZE*0.75, TILE_SIZE, TILE_SIZE*1.5);
            ctx.restore();
          } else if (tile >= 12 && tile <= 14) {
            if (tile === 12) {
              ctx.drawImage(images[12], x, y, TILE_SIZE, TILE_SIZE);
            } else if (tile === 13) {
              const left = c > 0 && map[r][c-1] >= 12 && map[r][c-1] <= 14;
              if (left) {
                ctx.drawImage(images[13], x, y, TILE_SIZE, TILE_SIZE);
              } else {
                ctx.save();
                ctx.translate(x + TILE_SIZE, y);
                ctx.scale(-1, 1);
                ctx.drawImage(images[13], 0, 0, TILE_SIZE, TILE_SIZE);
                ctx.restore();
              }
            } else if (tile === 14) {
              ctx.drawImage(images[14], x, y, TILE_SIZE, TILE_SIZE);
            }
          } else if (tile >= 20 && tile <= 30) {
            ctx.drawImage(images[tile], x, y, TILE_SIZE, TILE_SIZE);
          } else if (tile !== 0 && images[tile]) {
            ctx.drawImage(images[tile], x, y, TILE_SIZE, TILE_SIZE);
          }
        }
      }
      // 2. „ÉÄ„Éü„Éº„Éñ„É≠„ÉÉ„ÇØ„Çí‰∏ÄÁï™ÊâãÂâç„Å´ÊèèÁîª
      for (let r = visibleRowStart; r < Math.min(visibleRowEnd, map.length); r++) {
        const rowTiles = map[r];
        if (!rowTiles) continue;
        for (let c = visibleColStart; c < Math.min(visibleColEnd, rowTiles.length); c++) {
          const tile = rowTiles[c];
          if (tile === 19 && window.dummyOverlays && window.dummyOverlays[`${r},${c}`]) {
            const x = c * TILE_SIZE;
            const y = r * TILE_SIZE;
            const drawTile = window.dummyOverlays[`${r},${c}`];
            if (drawTile >= 12 && drawTile <= 14) {
              if (drawTile === 12) {
                ctx.drawImage(images[12], x, y, TILE_SIZE, TILE_SIZE);
              } else if (drawTile === 13) {
                const left = c > 0 && map[r][c-1] >= 12 && map[r][c-1] <= 14;
                if (left) {
                  ctx.drawImage(images[13], x, y, TILE_SIZE, TILE_SIZE);
                } else {
                  ctx.save();
                  ctx.translate(x + TILE_SIZE, y);
                  ctx.scale(-1, 1);
                  ctx.drawImage(images[13], 0, 0, TILE_SIZE, TILE_SIZE);
                  ctx.restore();
                }
              } else if (drawTile === 14) {
                ctx.drawImage(images[14], x, y, TILE_SIZE, TILE_SIZE);
              }
            } else if (drawTile >= 20 && drawTile <= 30) {
              ctx.drawImage(images[drawTile], x, y, TILE_SIZE, TILE_SIZE);
            } else if (drawTile !== 0 && images[drawTile]) {
              ctx.drawImage(images[drawTile], x, y, TILE_SIZE, TILE_SIZE);
            }
            ctx.save();
            ctx.strokeStyle = "rgba(255, 0, 0, 0.7)";
            ctx.lineWidth = 2;
            ctx.strokeRect(x + 1, y + 1, TILE_SIZE - 2, TILE_SIZE - 2);
            ctx.restore();
          }
        }
      }
      if (window.showCollisionBoxes) {
        ctx.save();
        ctx.strokeStyle = 'rgba(255, 64, 64, 0.8)';
        const pixelRatio = window.renderPixelRatio || 1;
        ctx.lineWidth = 1 / pixelRatio;
        for (let r = visibleRowStart; r < Math.min(visibleRowEnd, map.length); r++) {
          const rowTiles = map[r];
          if (!rowTiles) continue;
          for (let c = visibleColStart; c < Math.min(visibleColEnd, rowTiles.length); c++) {
            let drawTile = rowTiles[c];
            if (drawTile === 0) continue;
            if (drawTile === 19 && window.dummyOverlays && window.dummyOverlays[`${r},${c}`]) {
              drawTile = window.dummyOverlays[`${r},${c}`];
            }
            const x = c * TILE_SIZE;
            const y = r * TILE_SIZE;
            ctx.strokeRect(x, y, TILE_SIZE, TILE_SIZE);
          }
        }
        ctx.restore();
      }
      // 3. Âãï„ÅèÊïµ„ÅÆÁü¢Âç∞„Çí‰∏ÄÁï™ÊâãÂâç„Å´ÊèèÁîª
      for (let r = visibleRowStart; r < Math.min(visibleRowEnd, rows); r++) {
        for (let c = visibleColStart; c < Math.min(visibleColEnd, cols); c++) {
          if (map[r][c] === 9) {
            const x = c * TILE_SIZE;
            const y = r * TILE_SIZE;
            const key = `${r},${c}`;
            const dir = window.enemyDirs[key] !== undefined ? window.enemyDirs[key] : 1;
            ctx.save();
            ctx.font = 'bold ' + Math.floor(TILE_SIZE * 1.2) + 'px sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.globalAlpha = 1.0;
            ctx.fillStyle = '#f00';
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 4;
            const arrow = dir === 1 ? '‚Üí' : '‚Üê';
            ctx.strokeText(arrow, x + TILE_SIZE/2, y + TILE_SIZE/2);
            ctx.fillText(arrow, x + TILE_SIZE/2, y + TILE_SIZE/2);
            ctx.restore();
          }
        }
      }
      // „Ç∞„É™„ÉÉ„ÉâÊèèÁîª
      if (window.showGrid) {
        ctx.strokeStyle = "rgba(255, 255, 255, 0.3)";
        ctx.lineWidth = 1;
        // ÁîªÈù¢„Å´Êò†„ÇãÁØÑÂõ≤„Å†„Åë„Ç∞„É™„ÉÉ„Éâ„ÇíÊèèÁîª
        const gridStartCol = Math.max(0, Math.floor(camera.x / TILE_SIZE));
        const gridEndCol = Math.min(window.cols, Math.ceil((camera.x + window.canvas.width) / TILE_SIZE));
        const gridStartRow = Math.max(0, Math.floor(camera.y / TILE_SIZE));
        const gridEndRow = Math.min(window.rows, Math.ceil((camera.y + window.canvas.height) / TILE_SIZE));
        for (let c = gridStartCol; c <= gridEndCol; c++) {
          const x = c * TILE_SIZE;
          window.ctx.beginPath();
          window.ctx.moveTo(x, 0);
          window.ctx.lineTo(x, window.canvas.height);
          window.ctx.stroke();
        }
        for (let r = gridStartRow; r <= gridEndRow; r++) {
          const y = r * TILE_SIZE;
          window.ctx.beginPath();
          window.ctx.moveTo(0, y);
          window.ctx.lineTo(window.canvas.width, y);
          window.ctx.stroke();
        }
      }
      
      // „Ç´„É°„É©ÁßªÂãï„ÅÆÂæ©ÂÖÉ
      window.ctx.restore();
    }

    // „Ç®„Éá„Ç£„Çø„Éö„Éº„Ç∏Áî®„ÅÆ„Ç≤„Éº„É†„É´„Éº„ÉóÔºà„Çπ„É†„Éº„Ç∫„Å™„Ç´„É°„É©ÁßªÂãï„ÅÆ„Åü„ÇÅÔºâ
    function gameLoop() {
      update();
      draw();
      requestAnimationFrame(gameLoop);
    }
    
    // „Ç®„Éá„Ç£„Çø„Éö„Éº„Ç∏„Åß„ÅØgameLoop„ÇíÂÆüË°å
    gameLoop();

    Promise.all(Object.values(images).map(img => new Promise(res => img.onload = res))).then(() => {
      // „Ç®„Éá„Ç£„Çø„Éö„Éº„Ç∏„Åß„ÅØÂàùÊúüÊèèÁîª„ÅÆ„ÅøÂÆüË°å
      if (window.canvas && window.ctx) {
        updateCameraBounds(); // ÂàùÊúü„Ç´„É°„É©Â¢ÉÁïåÂà∂Èôê„ÇíÈÅ©Áî®
        draw();
      }
    });

    function saveMap() {
      const mapData = {
        map: map,
        dummyOverlays: window.dummyOverlays || {},
        enemyDirs: window.enemyDirs || {},
        trampolineAngles: window.trampolineAngles || {},
        trampolinePowers: window.trampolinePowers || {},
        enemyProps: window.enemyProps || {},
      };
      localStorage.setItem("world_" + slotName, JSON.stringify(mapData));
      if (typeof saveThumbnailData === 'function') {
        try {
          saveThumbnailData();
        } catch (err) {
          console.warn('„Çµ„É†„Éç„Ç§„É´„Éá„Éº„Çø„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', err);
        }
      }
      localStorage.removeItem("thumb_" + slotName);
    }

    function loadMap() {
      const saved = localStorage.getItem("world_" + slotName);
      if (saved) {
        try {
          const mapData = JSON.parse(saved);
          const mapSource = Array.isArray(mapData)
            ? mapData
            : (mapData && Array.isArray(mapData.map) ? mapData.map : null);

          if (mapSource) {
            const dims = updateEditorBounds(mapSource);
            const result = applyWorldToEditor(mapData);
            if (result.mismatch) {
              showMessage("„Éû„ÉÉ„Éó„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„ÅüÔºÅÔºàÁØÑÂõ≤Â§ñ„ÅÆ„Éñ„É≠„ÉÉ„ÇØ„ÇíÂâäÈô§Ôºâ");
            } else {
              showMessage("„Éû„ÉÉ„Éó„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„ÅüÔºÅ");
            }
            return;
          }
        } catch (e) {
          showMessage("Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº: " + e.message);
          return;
        }
      } else {
        showMessage("‰øùÂ≠ò„Åï„Çå„Åü„Éû„ÉÉ„Éó„Åå„ÅÇ„Çä„Åæ„Åõ„ÇìÔºÅ");
      }
      // Â§±ÊïóÊôÇ„ÅØÂàùÊúüÂåñ
      window.dummyOverlays = {};
      window.enemyDirs = {};
      window.trampolineAngles = {};
      window.trampolinePowers = {};
      window.enemyProps = {};
      applyWorldToEditor([], {
        targetRows: window.rows,
        targetCols: window.cols,
        minRows: window.rows,
        minCols: window.cols
      });
    }

    // „Éû„ÉÉ„Éó„ÅÆÁä∂ÊÖã„Çí‰øùÂ≠ò
    function saveMapState() {
      if (isUndoRedoAction) return;
      const mapCopy = map.map(row => [...row]);
      const dummyOverlaysCopy = window.dummyOverlays ? JSON.parse(JSON.stringify(window.dummyOverlays)) : {};
      const enemyDirsCopy = window.enemyDirs ? JSON.parse(JSON.stringify(window.enemyDirs)) : {};
      const trampolineAnglesCopy = window.trampolineAngles ? JSON.parse(JSON.stringify(window.trampolineAngles)) : {};
      const enemyPropsCopy = window.enemyProps ? JSON.parse(JSON.stringify(window.enemyProps)) : {};
      undoHistory.push({
        map: mapCopy,
        dummyOverlays: dummyOverlaysCopy,
        enemyDirs: enemyDirsCopy,
        trampolineAngles: trampolineAnglesCopy,
        trampolinePowers: window.trampolinePowers ? JSON.parse(JSON.stringify(window.trampolinePowers)) : {},
        enemyProps: enemyPropsCopy
      });
      if (undoHistory.length > 20) undoHistory.shift();
      redoHistory = [];
    }

    // Âèñ„ÇäÊ∂à„ÅóÊ©üËÉΩ
    function undo() {
      if (undoHistory.length === 0) {
        showMessage("Âèñ„ÇäÊ∂à„ÅôÊìç‰Ωú„Åå„ÅÇ„Çä„Åæ„Åõ„Çì");
        return;
      }
      
      // ÁèæÂú®„ÅÆÁä∂ÊÖã„Çí„ÇÑ„ÇäÁõ¥„ÅóÂ±•Ê≠¥„Å´‰øùÂ≠ò
      const currentMap = map.map(row => [...row]);
      const currentDummyOverlays = window.dummyOverlays ? JSON.parse(JSON.stringify(window.dummyOverlays)) : {};
      const currentEnemyDirs = window.enemyDirs ? JSON.parse(JSON.stringify(window.enemyDirs)) : {};
      const currentTrampolineAngles = window.trampolineAngles ? JSON.parse(JSON.stringify(window.trampolineAngles)) : {};
      const currentEnemyProps = window.enemyProps ? JSON.parse(JSON.stringify(window.enemyProps)) : {};
      const currentTrampolinePowers = window.trampolinePowers ? JSON.parse(JSON.stringify(window.trampolinePowers)) : {};
      redoHistory.push({
        map: currentMap,
        dummyOverlays: currentDummyOverlays,
        enemyDirs: currentEnemyDirs,
        trampolineAngles: currentTrampolineAngles,
        trampolinePowers: currentTrampolinePowers,
        enemyProps: currentEnemyProps
      });
      
      // Ââç„ÅÆÁä∂ÊÖã„ÇíÂæ©ÂÖÉ
      const previousState = undoHistory.pop();
      isUndoRedoAction = true;
      
      map.length = 0;
      map.push(...previousState.map);
      window.dummyOverlays = previousState.dummyOverlays;
      window.enemyDirs = previousState.enemyDirs;
      window.trampolineAngles = previousState.trampolineAngles;
      window.trampolinePowers = previousState.trampolinePowers || {};
      window.enemyProps = previousState.enemyProps;
      
      if (window.invalidateStaticChunks) window.invalidateStaticChunks();
      isUndoRedoAction = false;
      showMessage("Âèñ„ÇäÊ∂à„Åó„Åæ„Åó„Åü");
    }

    // „ÇÑ„ÇäÁõ¥„ÅóÊ©üËÉΩ
    function redo() {
      if (redoHistory.length === 0) {
        showMessage("„ÇÑ„ÇäÁõ¥„ÅôÊìç‰Ωú„Åå„ÅÇ„Çä„Åæ„Åõ„Çì");
        return;
      }
      
      // ÁèæÂú®„ÅÆÁä∂ÊÖã„Çí„ÇÑ„ÇäÁõ¥„ÅóÂ±•Ê≠¥„Å´‰øùÂ≠ò
      const currentMap = map.map(row => [...row]);
      const currentDummyOverlays = window.dummyOverlays ? JSON.parse(JSON.stringify(window.dummyOverlays)) : {};
      const currentEnemyDirs = window.enemyDirs ? JSON.parse(JSON.stringify(window.enemyDirs)) : {};
      const currentTrampolineAngles = window.trampolineAngles ? JSON.parse(JSON.stringify(window.trampolineAngles)) : {};
      const currentEnemyProps = window.enemyProps ? JSON.parse(JSON.stringify(window.enemyProps)) : {};
      const currentTrampolinePowers = window.trampolinePowers ? JSON.parse(JSON.stringify(window.trampolinePowers)) : {};
      redoHistory.push({
        map: currentMap,
        dummyOverlays: currentDummyOverlays,
        enemyDirs: currentEnemyDirs,
        trampolineAngles: currentTrampolineAngles,
        trampolinePowers: currentTrampolinePowers,
        enemyProps: currentEnemyProps
      });
      
      // Ê¨°„ÅÆÁä∂ÊÖã„ÇíÂæ©ÂÖÉ
      const nextState = redoHistory.pop();
      isUndoRedoAction = true;
      
      map.length = 0;
      map.push(...nextState.map);
      window.dummyOverlays = nextState.dummyOverlays;
      window.enemyDirs = nextState.enemyDirs;
      window.trampolineAngles = nextState.trampolineAngles;
      window.trampolinePowers = nextState.trampolinePowers || {};
      window.enemyProps = nextState.enemyProps;
      
      if (window.invalidateStaticChunks) window.invalidateStaticChunks();
      isUndoRedoAction = false;
      showMessage("„ÇÑ„ÇäÁõ¥„Åó„Åæ„Åó„Åü");
    }

    // „ÉØ„Éº„É´„ÉâÊ®™ÂπÖ„ÇíÈÅ©Áî®„Åô„ÇãÈñ¢Êï∞
    function applyWorldWidth(newWidth) {
      if (newWidth === window.cols) {
        showMessage("ÁèæÂú®„ÅÆÊ®™ÂπÖ„Å®Âêå„Åò„Åß„Åô");
        return;
      }
      
      showConfirm(`„ÉØ„Éº„É´„ÉâÊ®™ÂπÖ„Çí${newWidth}„Å´Â§âÊõ¥„Åó„Åæ„Åô„ÅãÔºüÁèæÂú®„ÅÆ„Éû„ÉÉ„Éó„Éá„Éº„Çø„ÅØ‰øùÊåÅ„Åï„Çå„Åæ„Åô„ÄÇ`, () => {
        // ÁèæÂú®„ÅÆÁä∂ÊÖã„ÇíÂ±•Ê≠¥„Å´‰øùÂ≠ò
        saveMapState();
        
        const oldCols = window.cols;
        
        if (newWidth > oldCols) {
          // Ê®™ÂπÖ„ÇíÊã°Âºµ
          for (let r = 0; r < window.rows; r++) {
            for (let c = oldCols; c < newWidth; c++) {
              map[r].push(0);
            }
          }
        } else {
          // Ê®™ÂπÖ„ÇíÁ∏ÆÂ∞èÔºàÂè≥Á´Ø„Åã„ÇâÂâäÈô§Ôºâ
          for (let r = 0; r < window.rows; r++) {
            map[r].splice(newWidth);
          }
        }
        
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„ÇíÊõ¥Êñ∞
        window.cols = newWidth;
        cols = window.cols;
        window.trimWorldMetadata(window.rows, window.cols);
        
        // „Ç´„É°„É©Â¢ÉÁïå„ÇíÊõ¥Êñ∞
        updateCameraBounds();
        
        // ÂÖ•ÂäõÊ¨Ñ„ÇíÊõ¥Êñ∞
        document.getElementById("worldWidthInput").value = newWidth;
        if (window.invalidateStaticChunks) window.invalidateStaticChunks();
        showMessage(`„ÉØ„Éº„É´„ÉâÊ®™ÂπÖ„Çí${newWidth}„Å´Â§âÊõ¥„Åó„Åæ„Åó„Åü`);
      });
    }

    // „ÉØ„Éº„É´„Éâ„Éá„Éº„Çø„ÇíJSON„Éï„Ç°„Ç§„É´„Å®„Åó„Å¶„Ç®„ÇØ„Çπ„Éù„Éº„Éà
    function exportWorldData() {
      const worldData = {
        name: slotName,
        map: map,
        dummyOverlays: window.dummyOverlays || {},
        enemyDirs: window.enemyDirs || {},
        trampolineAngles: window.trampolineAngles || {},
        trampolinePowers: window.trampolinePowers || {},
        enemyProps: window.enemyProps || {},
        exportDate: new Date().toISOString(),
        version: "1.0"
      };
      
      const dataStr = JSON.stringify(worldData, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      
      const link = document.createElement('a');
      link.href = URL.createObjectURL(dataBlob);
      link.download = `${slotName}_world.json`;
      link.click();
      
      URL.revokeObjectURL(link.href);
      showMessage("„ÉØ„Éº„É´„Éâ„Éá„Éº„Çø„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åæ„Åó„ÅüÔºÅ");
    }

    // JSON„Éï„Ç°„Ç§„É´„Åã„Çâ„ÉØ„Éº„É´„Éâ„Éá„Éº„Çø„Çí„Ç§„É≥„Éù„Éº„Éà
    function importWorldData(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const worldData = JSON.parse(e.target.result);
          
          // „Éá„Éº„ÇøÂΩ¢Âºè„ÅÆÊ§úË®º
          if (!worldData.map || !Array.isArray(worldData.map)) {
            showMessage("ÁÑ°Âäπ„Å™„ÉØ„Éº„É´„Éâ„Éá„Éº„Çø„Éï„Ç°„Ç§„É´„Åß„Åô");
            return;
          }

          const dims = window.getWorldDimensions(worldData.map);
          const mismatch = !!(dims && (dims.rows !== window.rows || dims.cols !== window.cols));
          if (mismatch) {
            showMessage(`Ë≠¶Âëä: „Éû„ÉÉ„Éó„Çµ„Ç§„Ç∫„ÅåÁï∞„Å™„Çä„Åæ„ÅôÔºàÁèæÂú®: ${window.cols}√ó${window.rows} ‚Üí Ë™≠„ÅøËæº„Åø: ${dims.cols || 0}√ó${dims.rows || 0}Ôºâ`);
          }
          
          const mismatchNote = mismatch
            ? `<br><span style="display:block;margin-top:12px;color:#ff4136;font-size:14px;">‚Äª Á∑®ÈõÜÂèØËÉΩÁØÑÂõ≤Â§ñ„ÅÆ„Éñ„É≠„ÉÉ„ÇØ„ÅØÂâäÈô§„Åï„Çå„Åæ„Åô„ÄÇ</span>`
            : "";
          showConfirm(`„ÉØ„Éº„É´„Éâ„Äå${worldData.name || '‰∏çÊòé'}„Äç„ÇíË™≠„ÅøËæº„Åø„Åæ„Åô„ÅãÔºüÁèæÂú®„ÅÆ„Éû„ÉÉ„Éó„ÅØ‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô„ÄÇ${mismatchNote}`, () => {
            // ÁèæÂú®„ÅÆÁä∂ÊÖã„ÇíÂ±•Ê≠¥„Å´‰øùÂ≠ò
            saveMapState();
            
            // „Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø
            updateEditorBounds(worldData.map);
            const appliedInfo = applyWorldToEditor(worldData);

            if (mismatch || appliedInfo.mismatch) {
              showMessage("„ÉØ„Éº„É´„Éâ„Éá„Éº„Çø„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„ÅüÔºÅÔºàÁØÑÂõ≤Â§ñ„ÅÆ„Éñ„É≠„ÉÉ„ÇØ„ÇíÂâäÈô§Ôºâ");
            } else {
              showMessage("„ÉØ„Éº„É´„Éâ„Éá„Éº„Çø„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„ÅüÔºÅ");
            }
          });
          
        } catch (error) {
          showMessage("„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: " + error.message);
        }
      };
      reader.readAsText(file);
    }

    // --- „Éñ„É≠„ÉÉ„ÇØË©≥Á¥∞„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË°®Á§∫ ---
    const blockNames = {
      0: 'Ê∂à„Åó„Ç¥„É†',
      1: 'Ëçâ',
      2: 'Âúü',
      3: 'Ê£ò',
      4: '„Ç¥„Éº„É´',
      5: 'Áü≥',
      6: 'ÊØí',
      7: '„Åç„ÅÆ„Åì',
      8: '„Éè„Ç∑„Ç¥',
      9: 'Âãï„ÅèÊïµ',
      10: '„Çπ„Éù„Éº„É≥',
      11: 'Â£ä„Çå„Çã„Éñ„É≠„ÉÉ„ÇØ',
      12: '„É¨„Éº„É´(‰∏≠)',
      13: '„É¨„Éº„É´(Á´Ø)',
      14: '„É¨„Éº„É´(Âçò‰Ωì)',
      15: '„Ç≥„Ç§„É≥',
      16: '„ÉÅ„Çß„ÉÉ„ÇØ„Éù„Ç§„É≥„Éà',
      17: 'Èáë„Ç¥„Éº„É´',
      19: '„ÉÄ„Éü„Éº„Éñ„É≠„ÉÉ„ÇØ',
      20: 'Ëâ≤„Éñ„É≠„ÉÉ„ÇØ0',
      21: 'Ëâ≤„Éñ„É≠„ÉÉ„ÇØ1',
      22: 'Ëâ≤„Éñ„É≠„ÉÉ„ÇØ2',
      23: 'Ëâ≤„Éñ„É≠„ÉÉ„ÇØ3',
      24: 'Ëâ≤„Éñ„É≠„ÉÉ„ÇØ4',
      25: 'Ëâ≤„Éñ„É≠„ÉÉ„ÇØ5',
      26: 'Ëâ≤„Éñ„É≠„ÉÉ„ÇØ6',
      27: 'Ëâ≤„Éñ„É≠„ÉÉ„ÇØ7',
      28: 'Ëâ≤„Éñ„É≠„ÉÉ„ÇØ8',
      29: 'Ëâ≤„Éñ„É≠„ÉÉ„ÇØ9',
      30: 'Ëâ≤„Éñ„É≠„ÉÉ„ÇØ10',
      31: 'Êâã',
      32: '„ÇØ„É™„Ç¢',
    };

    // „Éñ„É≠„ÉÉ„ÇØË©≥Á¥∞„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË°®Á§∫
    function showBlockDetail(blockId) {
      const popup = document.getElementById('blockDetailPopup');
      const img = document.getElementById('blockDetailImg');
      const name = document.getElementById('blockDetailName');
      if (images[blockId]) {
        img.src = images[blockId].src;
        img.style.display = '';
      } else {
        img.style.display = 'none';
      }
      name.textContent = blockNames[blockId] || `ID:${blockId}`;

      // „Åç„ÅÆ„ÅìÔºàblockId===7Ôºâ„ÅÆÂ†¥Âêà„ÅÆ„Åø„Ç∏„É£„É≥„ÉóÊåôÂãïË®≠ÂÆöUI„ÇíË°®Á§∫
      const mushroomSettings = document.getElementById('mushroomSettings');
      if (blockId === 7) {
        if (mushroomSettings) {
          mushroomSettings.style.display = 'block';
          // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆÂÄ§„ÇílocalStorage„Åã„ÇâÂæ©ÂÖÉ
          const checkbox = document.getElementById('mushroomMoveCheckbox');
          if (checkbox) {
            const saved = localStorage.getItem('editor_mushroomMove');
            checkbox.checked = saved === 'true';
            // „ÉÅ„Çß„ÉÉ„ÇØÂ§âÊõ¥ÊôÇ„Å´localStorage„Å∏‰øùÂ≠ò
            checkbox.onchange = function() {
              localStorage.setItem('editor_mushroomMove', checkbox.checked ? 'true' : 'false');
            };
          }
        }
      } else {
        if (mushroomSettings) mushroomSettings.style.display = 'none';
      }

      // Êó¢Â≠ò„ÅÆË®≠ÂÆöUI„ÇíÊ∂à„Åô
      let old = document.getElementById('blockDetailSettings');
      if (old) old.remove();

      // Ë®≠ÂÆöUIËøΩÂä†
      const settings = document.createElement('div');
      settings.id = 'blockDetailSettings';
      settings.style.display = 'flex';
      settings.style.flexDirection = 'column';
      settings.style.marginLeft = '16px';
      settings.style.gap = '8px';

      // --- Âãï„ÅèÊïµÔºàÊ£òÔºâÂ∞ÇÁî®„ÇØ„É™„ÉÉ„ÇØÂàá„ÇäÊõø„ÅàUI ---
      if (blockId === 9 && window.lastDetailRowCol) {
        // --- „Åì„Åì„Åã„ÇâË™¨ÊòéÊñá„ÇíËøΩÂä† ---
        const desc = document.createElement('div');
        desc.style.fontSize = '15px';
        desc.style.marginBottom = '6px';
        desc.innerHTML = '<span style="color:#ff4136;font-weight:bold;">üü• Ëµ§ÔºöÊ≠ª‰∫°Âà§ÂÆöÔºàËß¶„Çå„Çã„Å®Ê≠ª„Å¨Ôºâ</span><br><span style="color:#2ecc40;font-weight:bold;">üü© Á∑ëÔºöÂΩì„Åü„ÇäÂà§ÂÆöÔºàÂÆâÂÖ®„ÉªÊäº„ÅóÊàª„Åó„Éª‰πó„Çå„ÇãÔºâ</span><br><span style="color:#333;">„ÇØ„É™„ÉÉ„ÇØ„ÅßÂàá„ÇäÊõø„Åà</span>';
        settings.appendChild(desc);
        // --- „Åì„Åì„Åæ„ÅßË™¨ÊòéÊñá ---
        if (!window.enemyProps) window.enemyProps = {};
        const key = window.lastDetailRowCol;
        if (!window.enemyProps[key]) {
          window.enemyProps[key] = {
            hitTop: false,
            hitSide: false,
            hitBottom: false,
            deathTop: true,
            deathSide: true,
            deathBottom: true
          };
        }
        if (!window.enemyDirs) window.enemyDirs = {};
        if (window.enemyDirs[key] === undefined) window.enemyDirs[key] = 1;
        const props = window.enemyProps[key];
        
        // ÁîªÂÉè„ÅÆÂë®„Çä„Å´„ÇØ„É™„ÉÉ„ÇØ„Éú„Çø„É≥„ÇíÈÖçÁΩÆ„Åô„Çã„É©„ÉÉ„Éë„Éº
        const wrap = document.createElement('div');
        wrap.style.display = 'grid';
        wrap.style.gridTemplateRows = '32px 48px 32px';
        wrap.style.gridTemplateColumns = '48px 48px 48px';
        wrap.style.gap = '2px';
        wrap.style.alignItems = 'center';
        wrap.style.justifyItems = 'center';
        wrap.style.marginBottom = '8px';
        
        // Áä∂ÊÖã„ÇíÂàá„ÇäÊõø„Åà„ÇãÈñ¢Êï∞
        function toggleState(direction) {
          const currentState = {
            death: props[`death${direction}`],
            hit: props[`hit${direction}`]
          };
          
          // Áä∂ÊÖã„ÇíÂàá„ÇäÊõø„ÅàÔºöÊ≠ª‰∫°Âà§ÂÆö ‚Üí ÂΩì„Åü„ÇäÂà§ÂÆö ‚Üí Ê≠ª‰∫°Âà§ÂÆö
          if (currentState.death && !currentState.hit) {
            // Ê≠ª‰∫°Âà§ÂÆöON ‚Üí ÂΩì„Åü„ÇäÂà§ÂÆöON
            props[`death${direction}`] = false;
            props[`hit${direction}`] = true;
          } else {
            // ÂΩì„Åü„ÇäÂà§ÂÆöON ‚Üí Ê≠ª‰∫°Âà§ÂÆöON
            props[`death${direction}`] = true;
            props[`hit${direction}`] = false;
          }
          
          saveMapState();
          draw();
          updateButtons(); // „Éú„Çø„É≥„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
        }
        
        // „Éú„Çø„É≥„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞
        function updateButtons() {
          // ‰∏ä„Éú„Çø„É≥
          const topBtn = document.getElementById('topBtn');
          if (topBtn) {
            if (props.deathTop) {
              topBtn.style.backgroundColor = '#ff4136';
              topBtn.textContent = 'üü•';
              topBtn.title = '‰∏ä:Ê≠ª‰∫°Âà§ÂÆöONÔºà„ÇØ„É™„ÉÉ„ÇØ„ÅßÂΩì„Åü„ÇäÂà§ÂÆö„Å´Â§âÊõ¥Ôºâ';
            } else if (props.hitTop) {
              topBtn.style.backgroundColor = '#2ecc40';
              topBtn.textContent = 'üü©';
              topBtn.title = '‰∏ä:ÂΩì„Åü„ÇäÂà§ÂÆöONÔºà„ÇØ„É™„ÉÉ„ÇØ„ÅßÊ≠ª‰∫°Âà§ÂÆö„Å´Â§âÊõ¥Ôºâ';
            }
          }
          
          // Â∑¶„Éú„Çø„É≥
          const leftBtn = document.getElementById('leftBtn');
          if (leftBtn) {
            if (props.deathSide) {
              leftBtn.style.backgroundColor = '#ff4136';
              leftBtn.textContent = 'üü•';
              leftBtn.title = 'Â∑¶:Ê≠ª‰∫°Âà§ÂÆöONÔºà„ÇØ„É™„ÉÉ„ÇØ„ÅßÂΩì„Åü„ÇäÂà§ÂÆö„Å´Â§âÊõ¥Ôºâ';
            } else if (props.hitSide) {
              leftBtn.style.backgroundColor = '#2ecc40';
              leftBtn.textContent = 'üü©';
              leftBtn.title = 'Â∑¶:ÂΩì„Åü„ÇäÂà§ÂÆöONÔºà„ÇØ„É™„ÉÉ„ÇØ„ÅßÊ≠ª‰∫°Âà§ÂÆö„Å´Â§âÊõ¥Ôºâ';
            }
          }
          
          // Âè≥„Éú„Çø„É≥
          const rightBtn = document.getElementById('rightBtn');
          if (rightBtn) {
            if (props.deathSide) {
              rightBtn.style.backgroundColor = '#ff4136';
              rightBtn.textContent = 'üü•';
              rightBtn.title = 'Âè≥:Ê≠ª‰∫°Âà§ÂÆöONÔºà„ÇØ„É™„ÉÉ„ÇØ„ÅßÂΩì„Åü„ÇäÂà§ÂÆö„Å´Â§âÊõ¥Ôºâ';
            } else if (props.hitSide) {
              rightBtn.style.backgroundColor = '#2ecc40';
              rightBtn.textContent = 'üü©';
              rightBtn.title = 'Âè≥:ÂΩì„Åü„ÇäÂà§ÂÆöONÔºà„ÇØ„É™„ÉÉ„ÇØ„ÅßÊ≠ª‰∫°Âà§ÂÆö„Å´Â§âÊõ¥Ôºâ';
            }
          }
          
          // ‰∏ã„Éú„Çø„É≥
          const bottomBtn = document.getElementById('bottomBtn');
          if (bottomBtn) {
            if (props.deathBottom) {
              bottomBtn.style.backgroundColor = '#ff4136';
              bottomBtn.textContent = 'üü•';
              bottomBtn.title = '‰∏ã:Ê≠ª‰∫°Âà§ÂÆöONÔºà„ÇØ„É™„ÉÉ„ÇØ„ÅßÂΩì„Åü„ÇäÂà§ÂÆö„Å´Â§âÊõ¥Ôºâ';
            } else if (props.hitBottom) {
              bottomBtn.style.backgroundColor = '#2ecc40';
              bottomBtn.textContent = 'üü©';
              bottomBtn.title = '‰∏ã:ÂΩì„Åü„ÇäÂà§ÂÆöONÔºà„ÇØ„É™„ÉÉ„ÇØ„ÅßÊ≠ª‰∫°Âà§ÂÆö„Å´Â§âÊõ¥Ôºâ';
            }
          }
        }
        
        // ‰∏ä„Éú„Çø„É≥
        const topBtn = document.createElement('button');
        topBtn.id = 'topBtn';
        topBtn.style.width = '32px';
        topBtn.style.height = '32px';
        topBtn.style.border = '2px solid #333';
        topBtn.style.borderRadius = '4px';
        topBtn.style.cursor = 'pointer';
        topBtn.style.fontSize = '16px';
        topBtn.onclick = () => toggleState('Top');
        wrap.appendChild(document.createElement('span'));
        wrap.appendChild(topBtn);
        wrap.appendChild(document.createElement('span'));
        
        // Â∑¶„Éú„Çø„É≥
        const leftBtn = document.createElement('button');
        leftBtn.id = 'leftBtn';
        leftBtn.style.width = '32px';
        leftBtn.style.height = '32px';
        leftBtn.style.border = '2px solid #333';
        leftBtn.style.borderRadius = '4px';
        leftBtn.style.cursor = 'pointer';
        leftBtn.style.fontSize = '16px';
        leftBtn.onclick = () => toggleState('Side');
        wrap.appendChild(leftBtn);
        
        // ÁîªÂÉè
        const imgClone = img.cloneNode(true);
        imgClone.style.margin = '0';
        wrap.appendChild(imgClone);
        
        // Âè≥„Éú„Çø„É≥
        const rightBtn = document.createElement('button');
        rightBtn.id = 'rightBtn';
        rightBtn.style.width = '32px';
        rightBtn.style.height = '32px';
        rightBtn.style.border = '2px solid #333';
        rightBtn.style.borderRadius = '4px';
        rightBtn.style.cursor = 'pointer';
        rightBtn.style.fontSize = '16px';
        rightBtn.onclick = () => toggleState('Side');
        wrap.appendChild(rightBtn);
        
        // ‰∏ã„Éú„Çø„É≥
        const bottomBtn = document.createElement('button');
        bottomBtn.id = 'bottomBtn';
        bottomBtn.style.width = '32px';
        bottomBtn.style.height = '32px';
        bottomBtn.style.border = '2px solid #333';
        bottomBtn.style.borderRadius = '4px';
        bottomBtn.style.cursor = 'pointer';
        bottomBtn.style.fontSize = '16px';
        bottomBtn.onclick = () => toggleState('Bottom');
        wrap.appendChild(document.createElement('span'));
        wrap.appendChild(bottomBtn);
        wrap.appendChild(document.createElement('span'));
        
        settings.appendChild(wrap);
        
        // ÂàùÊúüË°®Á§∫„ÇíË®≠ÂÆö
        updateButtons();
        
        // --- ÊñπÂêë„Çπ„É©„Ç§„ÉÄ„Éº ---
        const dirLabel = document.createElement('label');
        dirLabel.textContent = 'ÁßªÂãïÊñπÂêë:';
        dirLabel.style.marginTop = '8px';
        dirLabel.style.display = 'flex';
        dirLabel.style.alignItems = 'center';
        const dirSlider = document.createElement('input');
        dirSlider.type = 'range';
        dirSlider.min = -1;
        dirSlider.max = 1;
        dirSlider.step = 2;
        dirSlider.value = window.enemyDirs[key];
        dirSlider.style.width = '80px';
        const dirText = document.createElement('span');
        dirText.textContent = (window.enemyDirs[key] == 1 ? '‚Üí' : '‚Üê');
        dirSlider.oninput = function() {
          window.enemyDirs[key] = parseInt(this.value);
          dirText.textContent = (window.enemyDirs[key] == 1 ? '‚Üí' : '‚Üê');
          saveMapState();
          draw();
        };
        dirLabel.appendChild(dirSlider);
        dirLabel.appendChild(dirText);
        settings.appendChild(dirLabel);
      }
      // --- „Éà„É©„É≥„Éù„É™„É≥ËßíÂ∫¶Ôºà„Çπ„É©„Ç§„ÉÄ„Éº: 0-359Ôºâ ---
      if (blockId === 7 && window.lastDetailRowCol) {
        const key = window.lastDetailRowCol;
        let angle = window.trampolineAngles[key] || 0;
        
        // Ë™¨ÊòéÊñá„ÇíËøΩÂä†
        const desc = document.createElement('div');
        desc.style.fontSize = '14px';
        desc.style.marginBottom = '8px';
        desc.style.color = '#666';
        desc.innerHTML = 'ËßíÂ∫¶: <b>0¬∞=‰∏äÔºà„Éá„Éï„Ç©„É´„ÉàÔºâ</b>, 90¬∞=Âè≥, 180¬∞=‰∏ã, 270¬∞=Â∑¶';
        settings.appendChild(desc);
        
        const label = document.createElement('label');
        label.textContent = 'ËßíÂ∫¶:';
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '8px';
        
        const slider = document.createElement('input');
        slider.type = 'range';
        slider.min = 0;
        slider.max = 359;
        slider.step = 0.5; // „Çà„ÇäÁ¥∞„Åã„ÅÑËßíÂ∫¶Ë™øÊï¥
        slider.value = angle;
        slider.style.width = '120px';
        
        // Êñ∞„Åó„Åè„Éà„É©„É≥„Éù„É™„É≥„ÇíÁΩÆ„ÅÑ„ÅüÂ†¥Âêà„ÅÆÂàùÊúüÂåñ
        if (window.trampolineAngles[key] === undefined) {
          window.trampolineAngles[key] = 0; // „Éá„Éï„Ç©„É´„Éà„ÅØ‰∏äÂêë„ÅçÔºà0¬∞Ôºâ
          angle = 0;
          slider.value = 0;
        }
        
        const valueText = document.createElement('span');
        valueText.textContent = angle.toFixed(1) + '¬∞';
        valueText.style.minWidth = '50px';
        
        // ÊñπÂêëÁü¢Âç∞„ÇíËøΩÂä†
        const directionArrow = document.createElement('span');
        directionArrow.style.fontSize = '16px';
        directionArrow.style.fontWeight = 'bold';
        directionArrow.style.color = '#4466ff';
        
        function updateDirectionArrow(angle) {
          if (angle >= 315 || angle < 45) directionArrow.textContent = '‚Üí'; // Âè≥
          else if (angle >= 45 && angle < 135) directionArrow.textContent = '‚Üì'; // ‰∏ã
          else if (angle >= 135 && angle < 225) directionArrow.textContent = '‚Üê'; // Â∑¶
          else directionArrow.textContent = '‚Üë'; // ‰∏ä
        }
        updateDirectionArrow(angle);
        
        slider.oninput = function() {
          const newAngle = parseFloat(this.value);
          valueText.textContent = newAngle.toFixed(1) + '¬∞';
          updateDirectionArrow(newAngle);
          window.trampolineAngles[key] = newAngle;
          drawTrajectoryPreview(newAngle);
          saveMapState();
          draw();
        };
        
        label.appendChild(slider);
        label.appendChild(valueText);
        label.appendChild(directionArrow);
        settings.appendChild(label);
        
        // ËªåÈÅì„Éó„É¨„Éì„É•„Éº
        const previewCanvas = document.createElement('canvas');
        previewCanvas.width = 120;
        previewCanvas.height = 80;
        previewCanvas.style.border = '1px solid #ccc';
        previewCanvas.style.marginTop = '8px';
        previewCanvas.style.backgroundColor = '#f0f0f0';
        
        // ËªåÈÅì„Éó„É¨„Éì„É•„ÉºÈñ¢Êï∞ÔºàËßíÂ∫¶„Å®Âäõ„ÅÆ‰∏°Êñπ„Å´ÂØæÂøúÔºâ
        function drawTrajectoryPreview(angle, power = window.trampolinePowers[key] || 2.2) {
          const ctx = previewCanvas.getContext('2d');
          ctx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
          
          // „Éà„É©„É≥„Éù„É™„É≥‰ΩçÁΩÆÔºà‰∏≠ÂøÉÔºâ
          const centerX = previewCanvas.width / 2;
          const centerY = previewCanvas.height - 10;
          
          // ËªåÈÅìË®àÁÆóÔºà„Ç≤„Éº„É†„Å®Âêå„ÅòË®àÁÆóÔºâ
          const rad = (angle - 90) * Math.PI / 180;
          const basePower = Math.abs(-9) * power * 1.1; // 1.1ÂÄç„ÅÆËøΩÂä†„Éñ„Éº„Çπ„Éà
          
          // ËßíÂ∫¶„Å´Âøú„Åò„ÅüËªåÈÅìË™øÊï¥Ôºà„Ç≤„Éº„É†„Å®Âêå„ÅòË®àÁÆóÔºâ
          let powerMultiplier = 1.0;
          let horizontalMultiplier = 1.0;
          let verticalMultiplier = 1.0;
          
          // ËßíÂ∫¶ÁØÑÂõ≤„Åî„Å®„ÅÆËªåÈÅìË™øÊï¥
          if (angle >= 315 || angle < 45) {
            horizontalMultiplier = 1.2;
            verticalMultiplier = 0.8;
          } else if (angle >= 45 && angle < 135) {
            horizontalMultiplier = 0.6;
            verticalMultiplier = 1.4;
          } else if (angle >= 135 && angle < 225) {
            horizontalMultiplier = 1.2;
            verticalMultiplier = 0.8;
          } else {
            horizontalMultiplier = 0.6;
            verticalMultiplier = 1.4;
          }
          
          // Á¥∞„Åã„ÅÑËßíÂ∫¶Ë™øÊï¥
          const angleMod = angle % 90;
          if (angleMod > 0 && angleMod < 90) {
            const diagonalMultiplier = 0.8 + (angleMod / 90) * 0.4;
            powerMultiplier = diagonalMultiplier;
          }
          
          const finalPower = basePower * powerMultiplier;
          const initialVx = Math.cos(rad) * finalPower * horizontalMultiplier;
          const initialVy = Math.sin(rad) * finalPower * verticalMultiplier;
          
          // Êú¨Áï™„Å®Âêå„ÅòÁâ©ÁêÜÊºîÁÆó„ÅßËªåÈÅì„ÇíË®àÁÆó
          let x = centerX;
          let y = centerY;
          let vx = initialVx;
          let vy = initialVy;
          const gravity = 0.01; // 0.3 ‚Üí 0.01 „Å´Â§ßÂπÖ„Å´Ê∏õ„Çâ„Åó„Å¶Ë∂ÖÈ´òÁ©∫È£õË°å
          const airResistance = 0.999; // 0.99 ‚Üí 0.999 „Å´Â§âÊõ¥„Åó„Å¶Á©∫Ê∞óÊäµÊäó„ÇíÊúÄÂ∞èÈôê„Å´
          const maxFallSpeed = 50; // 15 ‚Üí 50 „Å´‰∏ä„Åí„Å¶Ë∂ÖÈ´òÈÄüËêΩ‰∏ã
          ctx.strokeStyle = '#4466ff';
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.moveTo(x, y);
          for (let frame = 0; frame < 1000; frame++) { // Ë∂ÖÈï∑Ë∑ùÈõ¢ËªåÈÅì
            vx *= airResistance;
            vy += gravity;
            if (vy > maxFallSpeed) vy = maxFallSpeed;
            x += vx;
            y += vy;
            ctx.lineTo(x, y);
            // Âú∞Èù¢„Å´ÁùÄÂú∞„Åó„Åü„ÇâÁµÇ‰∫ÜÔºà„Çà„ÇäÊ≠£Á¢∫„Å™Âà§ÂÆöÔºâ
            if (y > previewCanvas.height - 10) break;
          }
          
          // „Éà„É©„É≥„Éù„É™„É≥„ÇíÊèèÁîª
          const trampolinePreviewImg = new Image();
          trampolinePreviewImg.src = window.ASSETS_BASE64["trampoline.png"];
          
          if (trampolinePreviewImg.complete && trampolinePreviewImg.naturalWidth > 0) {
            ctx.save();
            ctx.translate(centerX, centerY);
            ctx.rotate(angle * Math.PI / 180);
            ctx.drawImage(trampolinePreviewImg, -16, -12, 32, 24);
            ctx.restore();
          } else {
            // ÁîªÂÉè„ÅåÊú™„É≠„Éº„Éâ„Å™„Çâonload„ÅßÂÜçÊèèÁîª
            trampolinePreviewImg.onload = () => drawTrajectoryPreview(angle, power);
            ctx.fillStyle = '#ff6b35';
            ctx.fillRect(centerX - 8, centerY - 4, 16, 8);
          }
          
          // ËßíÂ∫¶Á∑ö„ÇíÊèèÁîª
          ctx.strokeStyle = '#ff0000';
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(centerX, centerY);
          ctx.lineTo(centerX + Math.cos(rad) * 15, centerY + Math.sin(rad) * 15);
          ctx.stroke();
        }
        
        // ÂàùÊúü„Éó„É¨„Éì„É•„Éº„ÇíÊèèÁîª
        drawTrajectoryPreview(angle, window.trampolinePowers[key] || 2.2);
        
        slider.oninput = function() {
          const newAngle = parseFloat(this.value);
          valueText.textContent = newAngle.toFixed(1) + '¬∞';
          updateDirectionArrow(newAngle);
          window.trampolineAngles[key] = newAngle;
          drawTrajectoryPreview(newAngle, window.trampolinePowers[key] || 2.2);
          saveMapState();
          draw();
        };
        
        settings.appendChild(previewCanvas);
        
        // --- „Éà„É©„É≥„Éù„É™„É≥ÂäõÔºà„Çπ„É©„Ç§„ÉÄ„Éº: 0.5-3.0Ôºâ ---
        const powerLabel = document.createElement('label');
        powerLabel.textContent = 'È£õ„Å∂Âäõ:';
        powerLabel.style.display = 'flex';
        powerLabel.style.alignItems = 'center';
        powerLabel.style.gap = '8px';
        powerLabel.style.marginTop = '12px';
        
        const powerSlider = document.createElement('input');
        powerSlider.type = 'range';
        powerSlider.min = 0.5;
        powerSlider.max = 3.0;
        powerSlider.step = 0.1;
        powerSlider.value = window.trampolinePowers[key] || 2.2;
        powerSlider.style.width = '120px';
        
        // Êñ∞„Åó„Åè„Éà„É©„É≥„Éù„É™„É≥„ÇíÁΩÆ„ÅÑ„ÅüÂ†¥Âêà„ÅÆÂäõ„ÅÆÂàùÊúüÂåñ
        if (window.trampolinePowers[key] === undefined) {
          window.trampolinePowers[key] = 2.2; // „Éá„Éï„Ç©„É´„Éà„ÅØ2.2ÂÄç
          powerSlider.value = 2.2;
        }
        
        const powerValueText = document.createElement('span');
        powerValueText.textContent = (window.trampolinePowers[key] || 2.2).toFixed(1) + 'ÂÄç';
        powerValueText.style.minWidth = '50px';
        
        powerSlider.oninput = function() {
          const newPower = parseFloat(this.value);
          powerValueText.textContent = newPower.toFixed(1) + 'ÂÄç';
          window.trampolinePowers[key] = newPower;
          drawTrajectoryPreview(angle, newPower);
          saveMapState();
          draw();
        };
        
        powerLabel.appendChild(powerSlider);
        powerLabel.appendChild(powerValueText);
        settings.appendChild(powerLabel);
        
        // ËªåÈÅì„Éó„É¨„Éì„É•„Éº„ÇíÂäõ„ÅÆË®≠ÂÆö„Å´„ÇÇÂØæÂøú„Åï„Åõ„Çã
        function drawTrajectoryPreview(angle, power = window.trampolinePowers[key] || 2.2) {
          const ctx = previewCanvas.getContext('2d');
          ctx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
          
          // „Éà„É©„É≥„Éù„É™„É≥‰ΩçÁΩÆÔºà‰∏≠ÂøÉÔºâ
          const centerX = previewCanvas.width / 2;
          const centerY = previewCanvas.height - 10;
          
          // ËªåÈÅìË®àÁÆóÔºà„Ç≤„Éº„É†„Å®Âêå„ÅòË®àÁÆóÔºâ
          const rad = (angle - 90) * Math.PI / 180;
          const basePower = Math.abs(-9) * power * 1.1; // 1.1ÂÄç„ÅÆËøΩÂä†„Éñ„Éº„Çπ„Éà
          
          // ËßíÂ∫¶„Å´Âøú„Åò„ÅüËªåÈÅìË™øÊï¥Ôºà„Ç≤„Éº„É†„Å®Âêå„ÅòË®àÁÆóÔºâ
          let powerMultiplier = 1.0;
          let horizontalMultiplier = 1.0;
          let verticalMultiplier = 1.0;
          
          // ËßíÂ∫¶ÁØÑÂõ≤„Åî„Å®„ÅÆËªåÈÅìË™øÊï¥
          if (angle >= 315 || angle < 45) {
            horizontalMultiplier = 1.2;
            verticalMultiplier = 0.8;
          } else if (angle >= 45 && angle < 135) {
            horizontalMultiplier = 0.6;
            verticalMultiplier = 1.4;
          } else if (angle >= 135 && angle < 225) {
            horizontalMultiplier = 1.2;
            verticalMultiplier = 0.8;
          } else {
            horizontalMultiplier = 0.6;
            verticalMultiplier = 1.4;
          }
          
          // Á¥∞„Åã„ÅÑËßíÂ∫¶Ë™øÊï¥
          const angleMod = angle % 90;
          if (angleMod > 0 && angleMod < 90) {
            const diagonalMultiplier = 0.8 + (angleMod / 90) * 0.4;
            powerMultiplier = diagonalMultiplier;
          }
          
          const finalPower = basePower * powerMultiplier;
          const initialVx = Math.cos(rad) * finalPower * horizontalMultiplier;
          const initialVy = Math.sin(rad) * finalPower * verticalMultiplier;
          
          // Êú¨Áï™„Å®Âêå„ÅòÁâ©ÁêÜÊºîÁÆó„ÅßËªåÈÅì„ÇíË®àÁÆó
          let x = centerX;
          let y = centerY;
          let vx = initialVx;
          let vy = initialVy;
          const gravity = 0.01; // 0.3 ‚Üí 0.01 „Å´Â§ßÂπÖ„Å´Ê∏õ„Çâ„Åó„Å¶Ë∂ÖÈ´òÁ©∫È£õË°å
          const airResistance = 0.999; // 0.99 ‚Üí 0.999 „Å´Â§âÊõ¥„Åó„Å¶Á©∫Ê∞óÊäµÊäó„ÇíÊúÄÂ∞èÈôê„Å´
          const maxFallSpeed = 50; // 15 ‚Üí 50 „Å´‰∏ä„Åí„Å¶Ë∂ÖÈ´òÈÄüËêΩ‰∏ã
          ctx.strokeStyle = '#4466ff';
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.moveTo(x, y);
          for (let frame = 0; frame < 1000; frame++) { // Ë∂ÖÈï∑Ë∑ùÈõ¢ËªåÈÅì
            vx *= airResistance;
            vy += gravity;
            if (vy > maxFallSpeed) vy = maxFallSpeed;
            x += vx;
            y += vy;
            ctx.lineTo(x, y);
            // Âú∞Èù¢„Å´ÁùÄÂú∞„Åó„Åü„ÇâÁµÇ‰∫ÜÔºà„Çà„ÇäÊ≠£Á¢∫„Å™Âà§ÂÆöÔºâ
            if (y > previewCanvas.height - 10) break;
          }
          
          // „Éà„É©„É≥„Éù„É™„É≥„ÇíÊèèÁîª
          const trampolinePreviewImg2 = new Image();
          trampolinePreviewImg2.src = window.ASSETS_BASE64["trampoline.png"];
          
          if (trampolinePreviewImg2.complete && trampolinePreviewImg2.naturalWidth > 0) {
            ctx.save();
            ctx.translate(centerX, centerY);
            ctx.rotate(angle * Math.PI / 180);
            ctx.drawImage(trampolinePreviewImg2, -16, -12, 32, 24);
            ctx.restore();
          } else {
            // ÁîªÂÉè„ÅåÊú™„É≠„Éº„Éâ„Å™„Çâonload„ÅßÂÜçÊèèÁîª
            trampolinePreviewImg2.onload = () => drawTrajectoryPreview(angle, power);
            ctx.fillStyle = '#ff6b35';
            ctx.fillRect(centerX - 8, centerY - 4, 16, 8);
          }
          
          // ËßíÂ∫¶Á∑ö„ÇíÊèèÁîª
          ctx.strokeStyle = '#ff0000';
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(centerX, centerY);
          ctx.lineTo(centerX + Math.cos(rad) * 15, centerY + Math.sin(rad) * 15);
          ctx.stroke();
        }
        
        // ÂàùÊúü„Éó„É¨„Éì„É•„Éº„ÇíÊèèÁîª
        drawTrajectoryPreview(angle, window.trampolinePowers[key] || 2.2);
      }
      popup.appendChild(settings);
      popup.style.display = 'flex';
    }

        // --- canvas„ÇØ„É™„ÉÉ„ÇØÊôÇ„ÄÅÂãï„ÅèÊïµ„ÇÑ„Åç„ÅÆ„Åì„ÅÆÊñπÂêë„ÉªËßíÂ∫¶Â§âÊõ¥Âá¶ÁêÜ„ÇíÁÑ°ÂäπÂåñ ---
    if (window.canvas) {
      window.canvas.addEventListener('click', function(e) {
        // „Ç≠„É£„É≥„Éê„Çπ„ÅÆÂÆüÈöõ„ÅÆ„Çµ„Ç§„Ç∫„Å®Ë°®Á§∫„Çµ„Ç§„Ç∫„ÇíÂèñÂæó
        const rect = window.canvas.getBoundingClientRect();
        
        // „Éû„Ç¶„Çπ‰ΩçÁΩÆ„Çí„Ç≠„É£„É≥„Éê„ÇπÂ∫ßÊ®ôÁ≥ª„Å´Â§âÊèõ
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;
        
        // „Ç≠„É£„É≥„Éê„Çπ„ÅÆË°®Á§∫„Çµ„Ç§„Ç∫„Å®ÂÆüÈöõ„ÅÆ„Çµ„Ç§„Ç∫„ÅÆÊØîÁéá„ÇíË®àÁÆó
        const scaleX = window.canvas.width / rect.width;
        const scaleY = window.canvas.height / rect.height;
        
        // „Çπ„Ç±„Éº„É´„ÇíËÄÉÊÖÆ„Åó„Å¶„Ç≠„É£„É≥„Éê„ÇπÂ∫ßÊ®ô„ÇíË®àÁÆó
        const canvasX = mouseX * scaleX;
        const canvasY = mouseY * scaleY;
        
        // „Ç´„É°„É©‰ΩçÁΩÆ„ÇíËÄÉÊÖÆ„Åó„Å¶„ÉØ„Éº„É´„ÉâÂ∫ßÊ®ô„ÇíË®àÁÆó
        const worldX = canvasX + camera.x;
        const worldY = canvasY + camera.y;
        
        // „Çø„Ç§„É´Â∫ßÊ®ô„ÇíË®àÁÆó
        const col = Math.floor(worldX / TILE_SIZE);
        const row = Math.floor(worldY / TILE_SIZE);
      if (col >= 0 && col < cols && row >= 0 && row < rows) {
          if (isHandMode) {
            const blockId = map[row][col];
            if (blockId !== 0) {
              window.lastDetailRowCol = `${row},${col}`;
              showBlockDetail(blockId);
          return;
        }
          }
          // ÊñπÂêë„ÉªËßíÂ∫¶Â§âÊõ¥Âá¶ÁêÜ„ÅØÂâäÈô§
      }
    });
    }

    // clearButton„ÅÆ„Ç¢„Ç§„Ç≥„É≥„Çíclear.png„Å´
    const clearButton = document.getElementById("clearButton");
    clearButton.innerHTML = '';
    clearButton.style.backgroundImage = `url(${images[32].src})`;
    clearButton.style.backgroundSize = 'cover';
    clearButton.style.backgroundRepeat = 'no-repeat';
    clearButton.style.backgroundPosition = 'center';
    clearButton.style.width = '50px';
    clearButton.style.height = '50px';
    
    // ËªåÈÅìË°®Á§∫„É¢„Éº„Éâ„ÅÆËøΩÂä†
    window.showTrajectories = false;
    
    // F3„Ç≠„Éº„ÅßËªåÈÅìË°®Á§∫Âàá„ÇäÊõø„Åà
    document.addEventListener('keydown', function(e) {
      if (e.key === 'p') {
        e.preventDefault();
        window.showTrajectories = !window.showTrajectories;
        console.log('ËªåÈÅìË°®Á§∫„É¢„Éº„Éâ:', window.showTrajectories ? 'ON' : 'OFF');
        updateTrajectoryStatus(); // Áä∂ÊÖãË°®Á§∫„ÇíÊõ¥Êñ∞
        draw(); // ÂÜçÊèèÁîª
      }
    });
    
    // ËªåÈÅìÊèèÁîªÈñ¢Êï∞
    function drawTrajectories() {
      if (!window.showTrajectories) return;
      
      const ctx = window.canvas.getContext('2d');
      ctx.save();
      ctx.setTransform(1, 0, 0, 1, -camera.x, -camera.y);
      
      // Âãï„ÅèÊïµ„ÅÆÊñπÂêë„ÇíÊèèÁîª
      if (window.enemyDirs) {
        for (const key in window.enemyDirs) {
          const [row, col] = key.split(',').map(Number);
          const direction = window.enemyDirs[key];
          const x = col * TILE_SIZE + TILE_SIZE / 2;
          const y = row * TILE_SIZE + TILE_SIZE / 2;
          
          // ÊñπÂêëÁü¢Âç∞„ÇíÊèèÁîª
          ctx.strokeStyle = '#ff0000';
          ctx.lineWidth = 3;
          ctx.beginPath();
          ctx.moveTo(x, y);
          
          let endX = x, endY = y;
          switch (direction) {
            case 'left':
              endX = x - 20;
              break;
            case 'right':
              endX = x + 20;
              break;
            case 'up':
              endY = y - 20;
              break;
            case 'down':
              endY = y + 20;
              break;
          }
          
          ctx.lineTo(endX, endY);
          ctx.stroke();
          
          // Áü¢Âç∞„ÅÆÂÖàÁ´Ø„ÇíÊèèÁîª
          ctx.fillStyle = '#ff0000';
          ctx.beginPath();
          if (direction === 'left' || direction === 'right') {
            ctx.moveTo(endX + (direction === 'left' ? 5 : -5), endY - 3);
            ctx.lineTo(endX, endY);
            ctx.lineTo(endX + (direction === 'left' ? 5 : -5), endY + 3);
          } else {
            ctx.moveTo(endX - 3, endY + (direction === 'up' ? 5 : -5));
            ctx.lineTo(endX, endY);
            ctx.lineTo(endX + 3, endY + (direction === 'up' ? 5 : -5));
          }
          ctx.fill();
        }
      }
      
             // „Éà„É©„É≥„Éù„É™„É≥„ÅÆËªåÈÅì„ÇíÊèèÁîª
       if (window.trampolineAngles) {
         for (const key in window.trampolineAngles) {
           const [row, col] = key.split(',').map(Number);
           // „Éà„É©„É≥„Éù„É™„É≥„ÅåÁèæÂ≠ò„Åó„Å™„ÅÑÂ†¥Âêà„ÅØËªåÈÅì„ÇíÊèèÁîª„Åó„Å™„ÅÑ
           if (!map[row] || map[row][col] !== 7) continue;
           const angle = window.trampolineAngles[key];
           const power = window.trampolinePowers[key] || 1.7;
           const x = col * TILE_SIZE + TILE_SIZE / 2;
           const y = row * TILE_SIZE + TILE_SIZE / 2;
           
           // „Éó„É¨„Ç§„É§„Éº„ÅÆÂàùÊúü‰ΩçÁΩÆÔºà„Éà„É©„É≥„Éù„É™„É≥„ÅÆ‰∏äÔºâ
           const playerStartX = x;
           const playerStartY = y - TILE_SIZE; // „Éà„É©„É≥„Éù„É™„É≥„ÅÆ1„Çø„Ç§„É´‰∏ä
           
           // ËªåÈÅìË®àÁÆóÔºà„Ç≤„Éº„É†„Å®Âêå„ÅòË®àÁÆóÔºâ
           const rad = (angle - 90) * Math.PI / 180;
           const basePower = Math.abs(-9) * power * 1.1; // 1.1ÂÄç„ÅÆËøΩÂä†„Éñ„Éº„Çπ„Éà
           
           // ËßíÂ∫¶„Å´Âøú„Åò„ÅüËªåÈÅìË™øÊï¥
           let powerMultiplier = 1.0;
           let horizontalMultiplier = 1.0;
           let verticalMultiplier = 1.0;
           
           if (angle >= 315 || angle < 45) {
             horizontalMultiplier = 1.2;
             verticalMultiplier = 0.8;
           } else if (angle >= 45 && angle < 135) {
             horizontalMultiplier = 0.6;
             verticalMultiplier = 1.4;
           } else if (angle >= 135 && angle < 225) {
             horizontalMultiplier = 1.2;
             verticalMultiplier = 0.8;
           } else {
             horizontalMultiplier = 0.6;
             verticalMultiplier = 1.4;
           }
           
           const angleMod = angle % 90;
           if (angleMod > 0 && angleMod < 90) {
             const diagonalMultiplier = 0.8 + (angleMod / 90) * 0.4;
             powerMultiplier = diagonalMultiplier;
           }
           
           const finalPower = basePower * powerMultiplier;
           const initialVx = Math.cos(rad) * finalPower * horizontalMultiplier;
           const initialVy = Math.sin(rad) * finalPower * verticalMultiplier;
           
           // ËªåÈÅì„ÅÆ„Éù„Ç§„É≥„Éà„ÇíË®àÁÆó„Åó„Å¶ÊèèÁîªÔºàÂú∞Èù¢„Å´ÁùÄÂú∞„Åô„Çã„Åæ„ÅßÔºâ
           let trajectoryPoints = [];
           
           // Áâ©ÁêÜ„Éë„É©„É°„Éº„Çø„ÇíÂÖà„Å´ÂÆ£Ë®Ä
           const gravity = 0.5;
           const airResistance = 0.98;
           const maxFallSpeed = 12;
           
           // „Éï„É¨„Éº„É†„Åî„Å®„Å´ÈÄüÂ∫¶„ÉªÂ∫ßÊ®ô„ÇíÊõ¥Êñ∞„Åô„ÇãËªåÈÅìË®àÁÆó
           let trajectoryX = playerStartX;
           let trajectoryY = playerStartY;
           let vx = initialVx;
           let vy = initialVy;
           
           ctx.strokeStyle = '#4466ff';
           ctx.lineWidth = 3;
           ctx.setLineDash([8, 4]);
           ctx.beginPath();
           ctx.moveTo(trajectoryX, trajectoryY);
           
           for (let frame = 0; frame < 1000; frame++) {
             vx *= airResistance;
             vy += gravity;
             if (vy > maxFallSpeed) vy = maxFallSpeed;
             trajectoryX += vx;
             trajectoryY += vy;
             trajectoryPoints.push({ x: trajectoryX, y: trajectoryY });
             ctx.lineTo(trajectoryX, trajectoryY);
             
             // Âú∞Èù¢„Å´ÁùÄÂú∞„Åó„Åü„ÇâÁµÇ‰∫ÜÔºàÂú∞ÂΩ¢Âà§ÂÆöÔºâ
             const tileBelow = typeof getTile === 'function' ? getTile(trajectoryX, trajectoryY + 1) : 0;
             // ÂΩì„Åü„ÇäÂà§ÂÆö„ÅÆ„Å™„ÅÑ„Éñ„É≠„ÉÉ„ÇØ„ÇíÈô§Â§ñ: 0(Á©∫), 6(ÊØí), 7(„Éà„É©„É≥„Éù„É™„É≥), 8(„Éè„Ç∑„Ç¥), 10(„Çπ„Éù„Éº„É≥), 15(„Ç≥„Ç§„É≥), 16(„ÉÅ„Çß„ÉÉ„ÇØ„Éù„Ç§„É≥„Éà), 17(„Ç¥„Éº„É´), 19(„ÉÄ„Éü„Éº)
             if (tileBelow !== 0 && tileBelow !== 6 && tileBelow !== 7 && tileBelow !== 8 && tileBelow !== 10 && tileBelow !== 15 && tileBelow !== 16 && tileBelow !== 17 && tileBelow !== 19) {
               break;
             }
           }
           
           ctx.stroke();
           ctx.setLineDash([]);
           
           // ËªåÈÅì„ÅÆ„Éù„Ç§„É≥„Éà„ÇíÂ∞è„Åï„Å™ÂÜÜ„ÅßË°®Á§∫
           ctx.fillStyle = '#4466ff';
           for (let i = 0; i < trajectoryPoints.length; i += 5) { // 5„Éï„É¨„Éº„É†„Åî„Å®„Å´„Éù„Ç§„É≥„Éà„ÇíË°®Á§∫
             const point = trajectoryPoints[i];
             ctx.beginPath();
             ctx.arc(point.x, point.y, 2, 0, Math.PI * 2);
             ctx.fill();
           }
           
           // ÁùÄÂú∞ÁÇπ„ÇíËµ§„ÅÑÂÜÜ„ÅßË°®Á§∫
           if (trajectoryPoints.length > 0) {
             const landingPoint = trajectoryPoints[trajectoryPoints.length - 1];
             ctx.fillStyle = '#ff0000';
             ctx.beginPath();
             ctx.arc(landingPoint.x, landingPoint.y, 6, 0, Math.PI * 2);
             ctx.fill();
             
             // ÁùÄÂú∞ÁÇπ„ÅÆÂ∫ßÊ®ô„ÇíË°®Á§∫
             ctx.fillStyle = '#ff0000';
             ctx.font = '10px Arial';
             ctx.fillText(`ÁùÄÂú∞: (${Math.round(landingPoint.x)}, ${Math.round(landingPoint.y)})`, 
                         landingPoint.x + 10, landingPoint.y - 10);
           }
           
           // „Éó„É¨„Ç§„É§„Éº„ÅÆÈñãÂßã‰ΩçÁΩÆ„ÇíÁ∑ë„ÅÆÂÜÜ„ÅßË°®Á§∫
           ctx.fillStyle = '#00ff00';
           ctx.beginPath();
           ctx.arc(playerStartX, playerStartY, 4, 0, Math.PI * 2);
           ctx.fill();
           
           // ËßíÂ∫¶Á∑ö„ÇíÊèèÁîª
           ctx.strokeStyle = '#ff6b35';
           ctx.lineWidth = 2;
           ctx.beginPath();
           ctx.moveTo(x, y);
           ctx.lineTo(x + Math.cos(rad) * 25, y + Math.sin(rad) * 25);
           ctx.stroke();
           
           // ËßíÂ∫¶„Å®Âäõ„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÇíÊèèÁîª
           ctx.fillStyle = '#ff6b35';
           ctx.font = '12px Arial';
           ctx.fillText(`${angle.toFixed(1)}¬∞ / ${power.toFixed(1)}ÂÄç`, x + 30, y - 10);
         }
       }
      
      ctx.restore();
    }
    
    // Êó¢Â≠ò„ÅÆdrawÈñ¢Êï∞„ÇíÊã°Âºµ
    const originalDraw = window.draw;
    window.draw = function() {
      if (originalDraw) originalDraw();
      drawTrajectories();
    };
    
    // ËªåÈÅìË°®Á§∫„É¢„Éº„Éâ„ÅÆÁä∂ÊÖã„ÇíË°®Á§∫
    function updateTrajectoryStatus() {
      const statusDiv = document.getElementById('trajectoryStatus');
      if (!statusDiv) {
        const div = document.createElement('div');
        div.id = 'trajectoryStatus';
        div.style.cssText = `
          position: fixed;
          top: 10px;
          right: 10px;
          background: rgba(0,0,0,0.7);
          color: white;
          padding: 8px 12px;
          border-radius: 6px;
          font-size: 12px;
          z-index: 1000;
          display: none;
        `;
        document.body.appendChild(div);
      }
      
      const div = document.getElementById('trajectoryStatus');
      if (window.showTrajectories) {
        div.textContent = 'ËªåÈÅìË°®Á§∫: ON (P„ÅßOFF)';
        div.style.display = 'block';
      } else {
        div.style.display = 'none';
      }
    }
    

    

    

    

    

    
    // ÂàùÊúüÁä∂ÊÖã„ÇíË®≠ÂÆö
    updateTrajectoryStatus();
    


  </script>
</body>
</html>
