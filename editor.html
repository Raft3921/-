<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>2Dãƒãƒƒãƒ—ã‚¨ãƒ‡ã‚£ã‚¿ï¼ˆãƒ‰ãƒ©ãƒƒã‚°è¨­ç½®å¯¾å¿œï¼‰</title>
  <script src="assets-base64.js"></script>
  <script src="editor-common.js"></script>
  <!-- <script src="file-manager.js"></script> -->
  <style>
    body {
      margin: 0;
      font-family: "Yu Gothic", sans-serif;
      background: #000;
      color: #1a2a4f;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    canvas {
      background: #aee;
      image-rendering: pixelated;
      border: 2px solid #1a2a4f;
      display: block;
      margin-top: 120px;
    }
    #slotBar {
      display: flex;
      justify-content: center;
      background: #fff;
      border-radius: 12px;
      padding: 10px;
      margin-top: 8px;
      gap: 12px;
      box-shadow: none;
    }
    #handSlot, #eraserSlot {
      display: flex;
      align-items: center;
      margin-right: 0;
      padding-right: 0;
      border-right: none;
    }
    #mainSlotBar {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .hand-btn {
      width: 48px;
      height: 48px;
      border-radius: 10px;
      border: none;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.10);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: box-shadow 0.2s, border 0.2s, background 0.2s;
      outline: none;
    }
    .hand-btn:hover {
      background: #f0f4ff;
      box-shadow: 0 4px 12px rgba(68,102,255,0.10);
    }
    .hand-btn.selected {
      border: 2px solid #4466ff;
      box-shadow: 0 0 8px #88f;
      background: #eaf2ff;
    }
    .eraser-btn {
      width: 48px;
      height: 48px;
      border-radius: 10px;
      border: none;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.10);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: box-shadow 0.2s, border 0.2s, background 0.2s;
      outline: none;
    }
    .eraser-btn:hover {
      background: #f0f4ff;
      box-shadow: 0 4px 12px rgba(68,102,255,0.10);
    }
    .eraser-btn.selected {
      border: 2px solid #4466ff;
      box-shadow: 0 0 8px #88f;
      background: #eaf2ff;
    }
    .slot-btn {
      width: 56px;
      height: 56px;
      border-radius: 12px;
      border: 3px solid #1a2a4f;
      background: #eef;
      margin: 0 5px;
      box-shadow: none;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s, border 0.2s;
      padding: 0;
      overflow: hidden;
    }
    .slot-btn img {
      width: 48px;
      height: 48px;
      display: block;
      margin: 0 auto;
      pointer-events: none;
      border-radius: 10px;
    }
    .slot-btn.selected {
      background: #88f;
      border: 2px solid #4466ff;
      box-shadow: 0 0 8px #88f;
    }
    .slot-btn:hover {
      background: #dde6ff;
    }
    .slot-btn.sub {
      width: 36px;
      height: 36px;
      font-size: 12px;
    }
    .more-btn {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: 2px solid #1a2a4f;
      background: #f0f0f0;
      color: #666;
      font-size: 18px;
      font-weight: bold;
      margin-left: 4px;
      margin-right: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s, color 0.2s;
    }
    .more-btn:hover {
      background: #e0e0e0;
      color: #333;
    }
    .block-selector {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }
    .block-selector.show {
      display: flex;
    }
    .block-selector-content {
      background: white;
      border-radius: 15px;
      padding: 30px;
      max-width: 80%;
      max-height: 80%;
      overflow-y: auto;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
      gap: 15px;
    }
    .block-selector-btn {
      width: 60px;
      height: 60px;
      border-radius: 10px;
      border: 2px solid #ddd;
      background: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .block-selector-btn:hover {
      border-color: #4466ff;
      background: #f0f4ff;
    }
    .block-selector-btn.selected {
      border-color: #4466ff;
      background: #4466ff;
      color: white;
    }
    .block-selector-close {
      position: absolute;
      top: 20px;
      right: 30px;
      background: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #homeButton, #clearButton, #undoButton, #redoButton, #exportButton, #importButton {
      position: absolute;
      top: 10px;
      font-size: 20px;
      padding: 10px 16px;
      z-index: 999;
      background: #fff;
      color: #1a2a4f;
      border-radius: 12px;
      border: none;
      font-weight: bold;
      cursor: pointer;
      min-width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #homeButton { left: 10px; }
    #clearButton { left: 140px; }
    #undoButton { left: 270px; }
    #redoButton { left: 340px; }
    #exportButton { left: 470px; }
    #importButton { left: 540px; }
    
    #fileInput {
      display: none;
    }
    /* --- ãƒ–ãƒ­ãƒƒã‚¯è©³ç´°ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— --- */
    #blockDetailPopup {
      position: fixed;
      top: 20px;
      left: 20px;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      border: 2px solid #4466ff;
      display: none;
      align-items: center;
      padding: 16px 24px 16px 16px;
      z-index: 10001;
      min-width: 220px;
      min-height: 64px;
      font-size: 18px;
      font-family: "Yu Gothic", sans-serif;
      color: #1a2a4f;
      gap: 18px;
    }
    #blockDetailPopup img {
      width: 48px;
      height: 48px;
      border-radius: 10px;
      background: #eef;
      border: 1.5px solid #bbb;
      margin-right: 12px;
      flex-shrink: 0;
    }
    #blockDetailPopup .block-name {
      font-size: 20px;
      font-weight: bold;
      color: #223;
      margin-right: 8px;
    }
    #blockDetailPopup .close-btn {
      margin-left: 16px;
      background: #eee;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      color: #888;
      cursor: pointer;
      padding: 2px 10px;
      transition: background 0.2s;
    }
    #blockDetailPopup .close-btn:hover {
      background: #d0d8ff;
      color: #4466ff;
    }
  </style>
</head>
<body>
  <div id="message" style="position:fixed;top:10px;left:50%;transform:translateX(-50%);background:#fff;padding:8px 16px;border-radius:8px;color:#1a2a4f;display:none;z-index:9999;font-weight:bold"></div>
  <canvas id="gameCanvas" width="1024" height="640"></canvas>
  <div id="slotBar">
    <div id="handSlot"></div>
    <div id="eraserSlot"></div>
    <div id="mainSlotBar"></div>
  </div>
  <button id="homeButton">ãƒ›ãƒ¼ãƒ </button>
  <button id="clearButton">ğŸ—‘ï¸</button>
  <button id="undoButton">â†©</button>
  <button id="redoButton">â†ª</button>
  <button id="exportButton">ğŸ’¾</button>
  <button id="importButton">ğŸ“‚</button>
  <input type="file" id="fileInput" accept=".json">
  <!-- ãƒ¯ãƒ¼ãƒ«ãƒ‰æ¨ªå¹…å¤‰æ›´æ©Ÿèƒ½ã¯å»ƒæ­¢ã€‚æ¨ªå¹…ã¯å¸¸ã«1000ãƒ–ãƒ­ãƒƒã‚¯ -->
  <div id="blockSelector" class="block-selector">
    <button class="block-selector-close" onclick="closeBlockSelector()">âœ•</button>
    <div class="block-selector-content" id="blockSelectorContent"></div>
  </div>
  <div id="blockDetailPopup">
    <img id="blockDetailImg" src="" alt="block" />
    <span class="block-name" id="blockDetailName"></span>
    <div id="mushroomSettings" style="margin-top:12px;display:none;">
     
    </div>
    <button class="close-btn" onclick="document.getElementById('blockDetailPopup').style.display='none'">âœ•</button>
  </div>
  <script>
    console.log('HELLO');
    // urlParamsã¨slotNameã¯editor-common.jsã§æ—¢ã«å®šç¾©æ¸ˆã¿
    // TILE_SIZEã‚‚editor-common.jsã§å®šç¾©æ¸ˆã¿
    
    // ã‚¨ãƒ‡ã‚£ã‚¿ç”¨ã®canvasã¨ctxã‚’å–å¾—ï¼ˆeditor-common.jsã§æ—¢ã«å®šç¾©æ¸ˆã¿ã®å ´åˆã¯ä½¿ç”¨ï¼‰
    const editorCanvas = document.getElementById("gameCanvas");
    if (!window.canvas || !window.ctx) {
      window.canvas = editorCanvas;
      window.ctx = window.canvas.getContext("2d");
      window.ctx.imageSmoothingEnabled = false;
    }
    if (window.attachGameCanvas) {
      window.attachGameCanvas(editorCanvas);
    }
    // windowã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ç›´æ¥å‚ç…§ï¼ˆconstå®£è¨€ã‚’é¿ã‘ã‚‹ï¼‰
    // const canvas = window.canvas;
    // const ctx = window.ctx;

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦å®šç¾©ï¼ˆãƒ¯ãƒ¼ãƒ«ãƒ‰æ¨ªå¹…å¤‰æ›´ã«å¯¾å¿œï¼‰
  window.cols = window.cols || 1000;
    if (!window.rows) window.rows = 20;
    const DEFAULT_WORLD_COLS = window.cols;
    const DEFAULT_WORLD_ROWS = window.rows;
    const MIN_WORLD_COLS = 1000;
    let cols = window.cols;
    let rows = window.rows;
    let cameraReady = false;
    let camera = null;
    function updateEditorBounds(rawMap) {
      const dims = window.getWorldDimensions(rawMap);
      window.rows = Math.max(dims.rows, DEFAULT_WORLD_ROWS);
      window.cols = Math.max(dims.cols, MIN_WORLD_COLS);
      rows = window.rows;
      cols = window.cols;
      return dims;
    }

    function applyWorldToEditor(worldData, options = {}) {
      const result = window.applyWorldData(
        worldData,
        Object.assign({
          targetRows: window.rows,
          targetCols: window.cols,
          minRows: window.rows,
          minCols: window.cols
        }, options)
      );
      rows = window.rows;
      cols = window.cols;
      if (cameraReady && typeof updateCameraBounds === "function") updateCameraBounds();
      if (cameraReady && typeof draw === "function") draw();
      return result;
    }
    // mapã¯editor-common.jsã§å®šç¾©æ¸ˆã¿

    // å–ã‚Šæ¶ˆã—ãƒ»ã‚„ã‚Šç›´ã—æ©Ÿèƒ½ã®å±¥æ­´ç®¡ç†
    let undoHistory = [];
    let redoHistory = [];
    let isUndoRedoAction = false; // å–ã‚Šæ¶ˆã—ãƒ»ã‚„ã‚Šç›´ã—ä¸­ã®ãƒ•ãƒ©ã‚°

    // --- ãƒ¯ãƒ¼ãƒ«ãƒ‰ãƒ‡ãƒ¼ã‚¿è‡ªå‹•èª­ã¿è¾¼ã¿ ---
    function loadWorldData() {
      const saved = localStorage.getItem("world_" + slotName);
      if (!saved) {
        window.dummyOverlays = {};
        window.enemyDirs = {};
        window.trampolineAngles = {};
        window.trampolinePowers = {};
        window.enemyProps = {};
        applyWorldToEditor([], {
          targetRows: window.rows,
          targetCols: window.cols,
          minRows: window.rows,
          minCols: window.cols
        });
        return;
      }

      try {
        const mapData = JSON.parse(saved);
        const mapSource = Array.isArray(mapData)
          ? mapData
          : (mapData && Array.isArray(mapData.map) ? mapData.map : null);

        if (mapSource) {
          const dims = updateEditorBounds(mapSource);
          const result = applyWorldToEditor(mapData);
          if (result.mismatch) {
            showMessage(`è­¦å‘Š: ä¿å­˜ã•ã‚ŒãŸãƒ¯ãƒ¼ãƒ«ãƒ‰ã‚µã‚¤ã‚º(${dims.cols || 0}Ã—${dims.rows || 0})ãŒç¾åœ¨ã®ç·¨é›†ç¯„å›²ã¨ç•°ãªã‚‹ãŸã‚ã€ç¯„å›²å¤–ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
          }
          return;
        }
      } catch (e) {
        console.error("ãƒ¯ãƒ¼ãƒ«ãƒ‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e);
      }

      // èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ãŸå ´åˆã¯åˆæœŸåŒ–
      window.dummyOverlays = {};
      window.enemyDirs = {};
      window.trampolineAngles = {};
      window.trampolinePowers = {};
      window.enemyProps = {};
      applyWorldToEditor([], {
        targetRows: window.rows,
        targetCols: window.cols,
        minRows: window.rows,
        minCols: window.cols
      });
    }
    loadWorldData();
    if (!window.enemyDirs) window.enemyDirs = {};

    // è¨­å®šã®èª­ã¿è¾¼ã¿
    function loadEditorSettings() {
      const settings = JSON.parse(localStorage.getItem('gameSettings') || '{}');
      const keySettings = JSON.parse(localStorage.getItem('keySettings') || '{}');
      
      const defaults = {
        showGrid: true,
        snapToGrid: true
      };
      
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚­ãƒ¼è¨­å®š
      const defaultKeys = {
        editorLeft: 'a',
        editorRight: 'd',
        editorUp: 'w',
        editorDown: 's'
      };
      
      window.showGrid = settings.showGrid !== undefined ? settings.showGrid : defaults.showGrid;
      window.snapToGrid = settings.snapToGrid !== undefined ? settings.snapToGrid : defaults.snapToGrid;
      
      // ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã‚­ãƒ¼è¨­å®š
      window.editorKeys = {};
      Object.keys(defaultKeys).forEach(key => {
        window.editorKeys[key] = keySettings[key] || defaultKeys[key];
      });
      
      console.log('ã‚¨ãƒ‡ã‚£ã‚¿è¨­å®šèª­ã¿è¾¼ã¿å®Œäº†:', {
        showGrid: window.showGrid, 
        snapToGrid: window.snapToGrid,
        keys: window.editorKeys
      });
    }
    loadEditorSettings();

    // è¨­å®šå¤‰æ›´æ™‚ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åæ˜ 
    window.addEventListener('storage', (e) => {
      if (e.key === 'gameSettings' || e.key === 'keySettings') {
        console.log('ã‚¨ãƒ‡ã‚£ã‚¿è¨­å®šãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸ');
        loadEditorSettings();
      }
    });

    // imagesï¼ˆ0:æ¶ˆã—ã‚´ãƒ , 1:åœ°é¢, 2:åœŸ, 3:æ•µ, 4:ã‚´ãƒ¼ãƒ«, 5:çŸ³, 6:æ¯’, 7:ãã®ã“, 8:ãƒã‚·ã‚´, 9:å‹•ãæ•µï¼‰
    const images = {
      0: new Image(),
      1: new Image(),
      2: new Image(),
      3: new Image(),
      4: new Image(),
      5: new Image(),
      6: new Image(),
      7: new Image(),
      8: new Image(),
      9: new Image(),
      10:new Image(),
      11:new Image(), // breakable block
      12: new Image(), // rail1
      13: new Image(), // rail2
      14: new Image(), // rail3
      15: new Image(), // coin
      16: new Image(), // checkpoint
      17: new Image(), // goldgoal
      19: new Image(), // dummy block
      // è‰²ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆID 20ï¼‰
      20: new Image(), // è‰²ãƒ–ãƒ­ãƒƒã‚¯
      21: new Image(),
      22: new Image(),
      23: new Image(),
      24: new Image(),
      25: new Image(),
      26: new Image(),
      27: new Image(),
      28: new Image(),
      29: new Image(),
      30: new Image(),
      31: new Image(), // hand.png
      32: new Image(), // clear.png
    };

    images[0].src = window.ASSETS_BASE64["eraser.png"];
    images[1].src = window.ASSETS_BASE64["ground.png"];
    images[2].src = window.ASSETS_BASE64["dirt.png"];
    images[3].src = window.ASSETS_BASE64["enemy.png"];
    images[4].src = window.ASSETS_BASE64["goal.png"];
    images[5].src = window.ASSETS_BASE64["stone.png"];
    images[6].src = window.ASSETS_BASE64["poison.png"];
    images[7].src = window.ASSETS_BASE64["trampoline.png"];
    images[8].src = window.ASSETS_BASE64["ladder.png"];
    images[9].src = window.ASSETS_BASE64["enemy-move1.png"];
    images[10].src = window.ASSETS_BASE64["spawn.png"];
    images[11].src = window.ASSETS_BASE64["breakblock.png"];
    images[12].src = window.ASSETS_BASE64["rail1.png"];
    images[13].src = window.ASSETS_BASE64["rail2.png"];
    images[14].src = window.ASSETS_BASE64["rail3.png"];
    images[15].src = window.ASSETS_BASE64["coin.png"];
    images[16].src = window.ASSETS_BASE64["checkpoint.png"];
    images[17].src = window.ASSETS_BASE64["goldgoal.png"];
    images[19].src = window.ASSETS_BASE64["dummy.png"];
    
    // è‰²ãƒ–ãƒ­ãƒƒã‚¯ç”»åƒã®è¨­å®šï¼ˆID 20-30ï¼‰
    images[20].src = window.ASSETS_BASE64["color.png"];
    images[21].src = window.ASSETS_BASE64["color1.png"];
    images[22].src = window.ASSETS_BASE64["color2.png"];
    images[23].src = window.ASSETS_BASE64["color3.png"];
    images[24].src = window.ASSETS_BASE64["color4.png"];
    images[25].src = window.ASSETS_BASE64["color5.png"];
    images[26].src = window.ASSETS_BASE64["color6.png"];
    images[27].src = window.ASSETS_BASE64["color7.png"];
    images[28].src = window.ASSETS_BASE64["color8.png"];
    images[29].src = window.ASSETS_BASE64["color9.png"];
    images[30].src = window.ASSETS_BASE64["color10.png"];

    images[31].src = window.ASSETS_BASE64["hand.png"];
    images[32].src = window.ASSETS_BASE64["clear.png"];

    // ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    Object.values(images).forEach(img => {
      img.onerror = function() {
        console.warn('ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', img.src);
      };
    });

    // --- ã‚¹ãƒ­ãƒƒãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  ---
    let mainSlotIndices = [];
    let allSlotIndices = [];
    let selectedTile = 2;
    let isHandMode = false;

    // ã‚¹ãƒ­ãƒƒãƒˆãƒãƒ¼ç”Ÿæˆ
    const handSlot = document.getElementById("handSlot");
    const eraserSlot = document.getElementById("eraserSlot");
    const mainSlotBar = document.getElementById("mainSlotBar");
    handSlot.innerHTML = "";
    eraserSlot.innerHTML = "";
    mainSlotBar.innerHTML = "";

    // å…¨ãƒ–ãƒ­ãƒƒã‚¯IDã‚’ç”Ÿæˆï¼ˆæ¶ˆã—ã‚´ãƒ ã¯é™¤å¤–ï¼‰
    allSlotIndices = Array.from({length: 20}, (_, i) => i).filter(i => i !== 0 && i !== 1 && i !== 12 && i !== 13 && i !== 18);
    if (!allSlotIndices.includes(9)) allSlotIndices.push(9);
    for (let i = 20; i <= 30; i++) {
      allSlotIndices.push(i);
    }
    // åˆæœŸãƒ¡ã‚¤ãƒ³ã‚¹ãƒ­ãƒƒãƒˆè¨­å®šï¼ˆæœ€åˆã®8å€‹ï¼‰
    mainSlotIndices = allSlotIndices.slice(0, 8);

    // ãƒãƒ³ãƒ‰ã‚¹ãƒ­ãƒƒãƒˆç”Ÿæˆ
    function createHandSlot() {
      handSlot.innerHTML = "";
      const btn = document.createElement('button');
      btn.className = 'hand-btn';
      btn.innerHTML = '';
      btn.style.width = btn.style.height = '48px';
      btn.style.fontSize = Math.floor(48 * 0.7) + 'px';
      btn.style.backgroundImage = `url(${images[31].src})`;
      btn.style.backgroundSize = 'cover';
      btn.addEventListener('click', () => {
        isHandMode = !isHandMode;
        document.querySelectorAll('.slot-btn, .eraser-btn, .hand-btn').forEach(b => b.classList.remove('selected'));
        if (isHandMode) {
          btn.classList.add('selected');
        }
      });
      handSlot.appendChild(btn);
    }

    // æ¶ˆã—ã‚´ãƒ ã‚¹ãƒ­ãƒƒãƒˆç”Ÿæˆ
    function createEraserSlot() {
      eraserSlot.innerHTML = "";
      const btn = document.createElement('button');
      btn.className = 'eraser-btn';
      btn.innerHTML = '';
      btn.style.width = btn.style.height = '48px';
      btn.style.fontSize = Math.floor(48 * 0.7) + 'px';
      if (images[0]) {
        btn.style.backgroundImage = `url(${images[0].src})`;
        btn.style.backgroundSize = 'cover';
      } else {
        btn.textContent = '0';
      }
      btn.addEventListener('click', () => {
        selectedTile = 0;
        isHandMode = false;
        document.querySelectorAll('.slot-btn, .eraser-btn, .hand-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
      });
      eraserSlot.appendChild(btn);
    }

    // ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ­ãƒƒãƒˆç”Ÿæˆ
    function createMainSlotButtons() {
      mainSlotBar.innerHTML = "";
      mainSlotIndices.forEach((i, idx) => {
        const btn = document.createElement('button');
        btn.className = 'slot-btn';
        btn.innerHTML = '';
        btn.style.width = btn.style.height = '56px';
        btn.style.borderRadius = '12px';
        btn.style.border = '3px solid #1a2a4f';
        btn.style.background = '#eef';
        btn.style.padding = '0';
        btn.style.overflow = 'hidden';
        if (images[i]) {
          const img = document.createElement('img');
          img.src = images[i].src;
          img.width = img.height = 48;
          img.style.borderRadius = '10px';
          img.style.display = 'block';
          img.style.margin = '0 auto';
          btn.appendChild(img);
        } else {
          btn.textContent = i;
        }
        btn.addEventListener('click', () => {
          selectedTile = i;
          isHandMode = false;
          document.querySelectorAll('.slot-btn, .eraser-btn, .hand-btn').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
        });
        // --- æ‰‹ãƒ¢ãƒ¼ãƒ‰æ™‚ã®è©³ç´°ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— ---
        btn.addEventListener('click', (e) => {
          if (isHandMode) {
            showBlockDetail(i);
            e.stopPropagation();
          }
        });
        mainSlotBar.appendChild(btn);
      });
      // ":"ãƒœã‚¿ãƒ³
      const moreBtn = document.createElement('button');
      moreBtn.className = 'more-btn';
      moreBtn.textContent = ':';
      moreBtn.onclick = openBlockSelector;
      mainSlotBar.appendChild(moreBtn);
    }

    // ãƒ–ãƒ­ãƒƒã‚¯é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    function openBlockSelector() {
      const selector = document.getElementById('blockSelector');
      const content = document.getElementById('blockSelectorContent');
      content.innerHTML = '';
      allSlotIndices.forEach(i => {
        const btn = document.createElement('button');
        btn.className = 'block-selector-btn';
        btn.innerHTML = '';
        if (images[i]) {
          btn.style.backgroundImage = `url(${images[i].src})`;
          btn.style.backgroundSize = 'cover';
        } else {
          btn.textContent = i;
        }
        btn.onclick = () => selectBlockFromModal(i);
        content.appendChild(btn);
      });
      selector.classList.add('show');
    }
    function closeBlockSelector() {
      document.getElementById('blockSelector').classList.remove('show');
    }
    function selectBlockFromModal(blockId) {
      selectedTile = blockId;
      moveToMainLeft(blockId);
      closeBlockSelector();
    }
    // ãƒ–ãƒ­ãƒƒã‚¯ä½¿ç”¨æ™‚ã®å‡¦ç†
    function useBlock(blockId) {
      const index = mainSlotIndices.indexOf(blockId);
      if (index > 0) {
        mainSlotIndices.splice(index, 1);
        mainSlotIndices.unshift(blockId);
        createMainSlotButtons();
      }
    }
    // ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ­ãƒƒãƒˆã®ä¸€ç•ªå·¦ã«ç§»å‹•
    function moveToMainLeft(blockId) {
      const index = mainSlotIndices.indexOf(blockId);
      if (index === -1) {
        mainSlotIndices.unshift(blockId);
        if (mainSlotIndices.length > 8) {
          mainSlotIndices.pop();
        }
      } else {
        mainSlotIndices.splice(index, 1);
        mainSlotIndices.unshift(blockId);
      }
      createMainSlotButtons();
    }
    // åˆæœŸç”Ÿæˆ
    createHandSlot();
    createEraserSlot();
    createMainSlotButtons();
    // åˆæœŸé¸æŠçŠ¶æ…‹ã‚’è¨­å®š
    document.querySelectorAll('.slot-btn, .eraser-btn, .hand-btn').forEach((b, idx) => {
      if (idx === 0 && isHandMode) b.classList.add('selected');
      else if (idx === 1 && selectedTile === 0) b.classList.add('selected');
      else if (mainSlotIndices[idx-2] === selectedTile) b.classList.add('selected');
    });

    // ãƒ¯ãƒ¼ãƒ«ãƒ‰èª­ã¿è¾¼ã¿æ™‚ã«æ•µã®è¨­å®šã‚’UIã«åæ˜ ã™ã‚‹é–¢æ•°
    window.updateEnemySettingsUI = function() {
      if (!window.enemyProps) return;
      
      // ç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹æ•µã®è©³ç´°ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒã‚ã‚Œã°æ›´æ–°
      const popup = document.getElementById('blockDetailPopup');
      if (popup && popup.style.display === 'flex' && window.lastDetailRowCol) {
        const key = window.lastDetailRowCol;
        const props = window.enemyProps[key];
        if (props) {
          // ä¸Šãƒœã‚¿ãƒ³
          const topBtn = document.getElementById('topBtn');
          if (topBtn) {
            if (props.deathTop) {
              topBtn.style.backgroundColor = '#ff4136';
              topBtn.textContent = 'ğŸŸ¥';
              topBtn.title = 'ä¸Š:æ­»äº¡åˆ¤å®šONï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å½“ãŸã‚Šåˆ¤å®šã«å¤‰æ›´ï¼‰';
            } else if (props.hitTop) {
              topBtn.style.backgroundColor = '#2ecc40';
              topBtn.textContent = 'ğŸŸ©';
              topBtn.title = 'ä¸Š:å½“ãŸã‚Šåˆ¤å®šONï¼ˆã‚¯ãƒªãƒƒã‚¯ã§æ­»äº¡åˆ¤å®šã«å¤‰æ›´ï¼‰';
            }
          }
          
          // å·¦ãƒœã‚¿ãƒ³
          const leftBtn = document.getElementById('leftBtn');
          if (leftBtn) {
            if (props.deathSide) {
              leftBtn.style.backgroundColor = '#ff4136';
              leftBtn.textContent = 'ğŸŸ¥';
              leftBtn.title = 'å·¦:æ­»äº¡åˆ¤å®šONï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å½“ãŸã‚Šåˆ¤å®šã«å¤‰æ›´ï¼‰';
            } else if (props.hitSide) {
              leftBtn.style.backgroundColor = '#2ecc40';
              leftBtn.textContent = 'ğŸŸ©';
              leftBtn.title = 'å·¦:å½“ãŸã‚Šåˆ¤å®šONï¼ˆã‚¯ãƒªãƒƒã‚¯ã§æ­»äº¡åˆ¤å®šã«å¤‰æ›´ï¼‰';
            }
          }
          
          // å³ãƒœã‚¿ãƒ³
          const rightBtn = document.getElementById('rightBtn');
          if (rightBtn) {
            if (props.deathSide) {
              rightBtn.style.backgroundColor = '#ff4136';
              rightBtn.textContent = 'ğŸŸ¥';
              rightBtn.title = 'å³:æ­»äº¡åˆ¤å®šONï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å½“ãŸã‚Šåˆ¤å®šã«å¤‰æ›´ï¼‰';
            } else if (props.hitSide) {
              rightBtn.style.backgroundColor = '#2ecc40';
              rightBtn.textContent = 'ğŸŸ©';
              rightBtn.title = 'å³:å½“ãŸã‚Šåˆ¤å®šONï¼ˆã‚¯ãƒªãƒƒã‚¯ã§æ­»äº¡åˆ¤å®šã«å¤‰æ›´ï¼‰';
            }
          }
          
          // ä¸‹ãƒœã‚¿ãƒ³
          const bottomBtn = document.getElementById('bottomBtn');
          if (bottomBtn) {
            if (props.deathBottom) {
              bottomBtn.style.backgroundColor = '#ff4136';
              bottomBtn.textContent = 'ğŸŸ¥';
              bottomBtn.title = 'ä¸‹:æ­»äº¡åˆ¤å®šONï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å½“ãŸã‚Šåˆ¤å®šã«å¤‰æ›´ï¼‰';
            } else if (props.hitBottom) {
              bottomBtn.style.backgroundColor = '#2ecc40';
              bottomBtn.textContent = 'ğŸŸ©';
              bottomBtn.title = 'ä¸‹:å½“ãŸã‚Šåˆ¤å®šONï¼ˆã‚¯ãƒªãƒƒã‚¯ã§æ­»äº¡åˆ¤å®šã«å¤‰æ›´ï¼‰';
            }
          }
        }
      }
    }

    // ãƒ¯ãƒ¼ãƒ«ãƒ‰èª­ã¿è¾¼ã¿å¾Œã«æ•µã®è¨­å®šã‚’UIã«åæ˜ 
    updateEnemySettingsUI();

    function showMessage(text) {
      const msg = document.getElementById("message");
      msg.innerText = text;
      msg.style.display = "block";
      setTimeout(() => { msg.style.display = "none"; }, 2000);
    }

function showConfirm(text, onYes, onNo) {
  let old = document.getElementById("confirmDialog");
  if (old) old.remove();
  const dialog = document.createElement("div");
  dialog.id = "confirmDialog";
  dialog.style.position = "fixed";
  dialog.style.top = "50%";
  dialog.style.left = "50%";
  dialog.style.transform = "translate(-50%,-50%)";
  dialog.style.background = "#fff";
  dialog.style.color = "#1a2a4f";
  dialog.style.padding = "24px 32px";
  dialog.style.borderRadius = '18px'; // â†ã‚ˆã‚Šå¤§ããªä¸¸ã¿ã‚‚OK
  dialog.style.boxShadow = "0 6px 20px rgba(0,0,0,0.15)";
  dialog.style.zIndex = "99999";
  dialog.style.fontWeight = "bold";
  dialog.style.fontFamily = "\"Yu Gothic\", sans-serif";
  dialog.innerHTML = `
    <div style="margin-bottom:18px;font-size:18px;text-align:center;">${text}</div>
    <div style="display:flex;gap:24px;justify-content:center;">
      <button id="yesBtn" style="padding:10px 32px;border:none;border-radius:12px;background:#4466ff;color:#fff;font-size:16px;font-weight:bold;cursor:pointer;box-shadow:0 1px 4px #2235;">ã¯ã„</button>
      <button id="noBtn" style="padding:10px 32px;border:none;border-radius:12px;background:#ccc;color:#1a2a4f;font-size:16px;font-weight:bold;cursor:pointer;">ã„ã„ãˆ</button>
    </div>
  `;
  document.body.appendChild(dialog);
  document.getElementById("yesBtn").onclick = () => {
    dialog.remove();
    if (onYes) onYes();
  };
  document.getElementById("noBtn").onclick = () => {
    dialog.remove();
    if (onNo) onNo();
  };
}


    // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById("homeButton").onclick = () => {
      showConfirm("ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ", () => {
        saveMap();
        location.href = 'home.html';
      });
    };
    document.getElementById("clearButton").onclick = () => {
      showConfirm("ãƒãƒƒãƒ—ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚", () => {
        saveMapState(); // ã‚¯ãƒªã‚¢å‰ã®çŠ¶æ…‹ã‚’ä¿å­˜
        for (let r = 0; r < rows; r++) {
          for (let c = 0; c < cols; c++) {
            map[r][c] = 0;
            if (window.markTileAndNeighborsDirty) window.markTileAndNeighborsDirty(r, c);
          }
        }
        window.dummyOverlays = {};
        if (window.invalidateStaticChunks) window.invalidateStaticChunks();
        showMessage("ãƒãƒƒãƒ—ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸï¼");
      });
    };
    document.getElementById("undoButton").onclick = undo;
    document.getElementById("redoButton").onclick = redo;
    document.getElementById("exportButton").onclick = exportWorldData;
      document.getElementById("importButton").onclick = () => {
    document.getElementById("fileInput").click();
  };
  
  
    
    // ãƒ¯ãƒ¼ãƒ«ãƒ‰æ¨ªå¹…è¨­å®šã®åˆæœŸåŒ–
  // æ¨ªå¹…å¤‰æ›´UIãƒ»ã‚¤ãƒ™ãƒ³ãƒˆã¯å»ƒæ­¢

    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById("fileInput").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        importWorldData(file);
        // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆåŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†åº¦é¸æŠã§ãã‚‹ã‚ˆã†ã«ï¼‰
        e.target.value = "";
      }
    });

    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
    document.addEventListener("keydown", (e) => {
      if (e.ctrlKey || e.metaKey) { // Ctrl (Windows) ã¾ãŸã¯ Cmd (Mac)
        if (e.key === "z") {
          e.preventDefault();
          undo();
        } else if (e.key === "y") {
          e.preventDefault();
          redo();
        }
      }
    });

    camera = { x: 0, y: 0 };
    cameraReady = true;
    if (typeof updateCameraBounds === "function") updateCameraBounds();
    if (typeof draw === "function") draw();
    const cameraSpeed = 6; // ã‚«ãƒ¡ãƒ©ç§»å‹•é€Ÿåº¦ï¼ˆver.2ã®2å€ã®é€Ÿåº¦ï¼‰
    
    // ã‚­ãƒ¼çŠ¶æ…‹ã®åˆæœŸåŒ–
    if (!window.keys) window.keys = {};
    
    // keysã¯editor-common.jsã§å®šç¾©æ¸ˆã¿
    // ã‚¨ãƒ‡ã‚£ã‚¿ç”¨ã®ã‚­ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
    document.addEventListener("keydown", e => {
      if (window.keys) window.keys[e.key] = true;
      
      // ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼å°‚ç”¨ã®ã‚«ãƒ¡ãƒ©ç§»å‹•ï¼ˆã‚­ãƒ¼çŠ¶æ…‹ã‚’è¨˜éŒ²ï¼‰
      // å®Ÿéš›ã®ç§»å‹•ã¯updateé–¢æ•°ã§é€£ç¶šçš„ã«å‡¦ç†
    });
    document.addEventListener("keyup", e => {
      if (window.keys) window.keys[e.key] = false;
    });
    
    // ã‚«ãƒ¡ãƒ©ã®å¢ƒç•Œåˆ¶é™ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateCameraBounds() {
      if (!window.canvas || !camera) return;
      
      const canvasWidth = window.canvas.width;
      const canvasHeight = window.canvas.height;
      
      // ãƒãƒƒãƒ—ã®å¢ƒç•Œã‚’è¨ˆç®—ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ä½¿ç”¨ï¼‰
      const mapWidth = window.cols * TILE_SIZE;
      const mapHeight = rows * TILE_SIZE;
      
      // ãƒãƒƒãƒ—ç¯„å›²å†…ã«åˆ¶é™
      const maxCameraX = Math.max(0, mapWidth - canvasWidth);
      const maxCameraY = Math.max(0, mapHeight - canvasHeight);
      
      camera.x = Math.max(0, Math.min(camera.x, maxCameraX));
      camera.y = Math.max(0, Math.min(camera.y, maxCameraY));
    }
    


    let isMouseDown = false;
    let hasSavedState = false; // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®çŠ¶æ…‹ä¿å­˜ãƒ•ãƒ©ã‚°
    let lastOutOfBoundsWarning = 0;
    
        // canvasãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
    if (window.canvas) {
      window.canvas.addEventListener("mousedown", e => {
      isMouseDown = true;
      hasSavedState = false; // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹æ™‚ã«ãƒªã‚»ãƒƒãƒˆ
    });
      window.canvas.addEventListener("mouseup", e => {
      isMouseDown = false;
      hasSavedState = false; // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†æ™‚ã«ãƒªã‚»ãƒƒãƒˆ
    });
      window.canvas.addEventListener("mouseleave", e => {
      isMouseDown = false;
      hasSavedState = false; // ãƒã‚¦ã‚¹ãŒé›¢ã‚ŒãŸæ™‚ã‚‚ãƒªã‚»ãƒƒãƒˆ
    });

      window.canvas.addEventListener("mousemove", placeTile);
      window.canvas.addEventListener("click", placeTile);
    }

    // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆå¯¾å¿œ
    let isTouchDown = false;
    let lastPlacedTile = { row: -1, col: -1 }; // æœ€å¾Œã«é…ç½®ã—ãŸã‚¿ã‚¤ãƒ«ã®ä½ç½®
    let lastTouchTime = 0; // æœ€å¾Œã®ã‚¿ãƒƒãƒå‡¦ç†æ™‚é–“
    const touchThrottle = 50; // ã‚¿ãƒƒãƒå‡¦ç†ã®é–“éš”ã‚’50msã«èª¿æ•´ï¼ˆã‚ˆã‚Šåå¿œã—ã‚„ã™ãï¼‰
    
        if (window.canvas) {
      window.canvas.addEventListener("touchstart", e => {
      e.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²ã
      isTouchDown = true;
      hasSavedState = false; // ã‚¿ãƒƒãƒé–‹å§‹æ™‚ã«ãƒªã‚»ãƒƒãƒˆ
      lastPlacedTile = { row: -1, col: -1 }; // ã‚¿ãƒƒãƒé–‹å§‹æ™‚ã«ãƒªã‚»ãƒƒãƒˆ
    });
      window.canvas.addEventListener("touchend", e => {
      e.preventDefault();
      isTouchDown = false;
      hasSavedState = false; // ã‚¿ãƒƒãƒçµ‚äº†æ™‚ã«ãƒªã‚»ãƒƒãƒˆ
      lastPlacedTile = { row: -1, col: -1 }; // ã‚¿ãƒƒãƒçµ‚äº†æ™‚ã«ãƒªã‚»ãƒƒãƒˆ
    });
      window.canvas.addEventListener("touchcancel", e => {
      e.preventDefault();
      isTouchDown = false;
      hasSavedState = false; // ã‚¿ãƒƒãƒã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã‚‚ãƒªã‚»ãƒƒãƒˆ
      lastPlacedTile = { row: -1, col: -1 }; // ã‚¿ãƒƒãƒã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã‚‚ãƒªã‚»ãƒƒãƒˆ
    });

      window.canvas.addEventListener("touchmove", e => {
      e.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²ã
      const now = performance.now();
      if (isTouchDown && e.touches.length > 0 && now - lastTouchTime > touchThrottle) {
        const touch = e.touches[0];
        placeTileTouch(touch);
        lastTouchTime = now;
      }
    });
    }

    // --- ãƒˆãƒ©ãƒ³ãƒãƒªãƒ³è§’åº¦ç®¡ç† ---
    if (!window.trampolineAngles) window.trampolineAngles = {};

    function placeTile(e) {
      if (!isMouseDown && e.type !== "click") return;
      if (!window.canvas) return;
      
      // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®å®Ÿéš›ã®ã‚µã‚¤ã‚ºã¨è¡¨ç¤ºã‚µã‚¤ã‚ºã‚’å–å¾—
      const rect = window.canvas.getBoundingClientRect();
      
      // ãƒã‚¦ã‚¹ä½ç½®ã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ç³»ã«å¤‰æ›
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;
      
      // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®è¡¨ç¤ºã‚µã‚¤ã‚ºã¨å®Ÿéš›ã®ã‚µã‚¤ã‚ºã®æ¯”ç‡ã‚’è¨ˆç®—
      const scaleX = window.canvas.width / rect.width;
      const scaleY = window.canvas.height / rect.height;
      
      // ã‚¹ã‚±ãƒ¼ãƒ«ã‚’è€ƒæ…®ã—ã¦ã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ã‚’è¨ˆç®—
      const canvasX = mouseX * scaleX;
      const canvasY = mouseY * scaleY;
      
      // ã‚«ãƒ¡ãƒ©ä½ç½®ã‚’è€ƒæ…®ã—ã¦ãƒ¯ãƒ¼ãƒ«ãƒ‰åº§æ¨™ã‚’è¨ˆç®—
      const worldX = canvasX + camera.x;
      const worldY = canvasY + camera.y;
      
      // ã‚¿ã‚¤ãƒ«åº§æ¨™ã‚’è¨ˆç®—
      const col = Math.floor(worldX / TILE_SIZE);
      const row = Math.floor(worldY / TILE_SIZE);
      
      // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°ï¼ˆé–‹ç™ºæ™‚ã®ã¿ï¼‰
      if (window.debugMode) {
        console.log('åº§æ¨™å¤‰æ›ãƒ‡ãƒãƒƒã‚°:', {
          mouseX, mouseY,
          scaleX, scaleY,
          canvasX, canvasY,
          cameraX: camera.x, cameraY: camera.y,
          worldX, worldY,
          col, row,
          tileSize: TILE_SIZE
        });
      }
      
      const maxCols = window.cols;
      const maxRows = window.rows;
      if (col < 0 || row < 0 || col >= maxCols || row >= maxRows) {
        const now = performance.now();
        if (col >= 0 && row >= 0 && now - lastOutOfBoundsWarning > 800) {
          showMessage("ç·¨é›†ã§ãã‚‹ç¯„å›²å¤–ã§ã™");
          lastOutOfBoundsWarning = now;
        }
        return;
      }

      if (!map[row]) return;

      if (isHandMode) {
        const blockId = map[row][col];
        if (blockId !== 0) {
          window.lastDetailRowCol = `${row},${col}`;
          showBlockDetail(blockId);
        }
        return;
      }

      // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®æœ€åˆã®1å›ã ã‘ã€ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯æ™‚ã«çŠ¶æ…‹ã‚’ä¿å­˜
      if (!hasSavedState || e.type === "click") {
        saveMapState();
        hasSavedState = true;
      }
      if (selectedTile === 10) {
        for (let r = 0; r < rows; r++) {
          for (let c = 0; c < cols; c++) {
            if (map[r][c] === 10) map[r][c] = 0;
          }
        }
        map[row][col] = 10;
      } else if (selectedTile === 19) { // ãƒ€ãƒŸãƒ¼ãƒ–ãƒ­ãƒƒã‚¯
        // ãƒ€ãƒŸãƒ¼ãƒ–ãƒ­ãƒƒã‚¯ã¯æ—¢å­˜ãƒ–ãƒ­ãƒƒã‚¯ã®ä¸Šã«ã®ã¿ç½®ã‘ã‚‹
        const existingTile = map[row][col];
        if (existingTile !== 0 && existingTile !== 19) {
          map[row][col] = 19;
          if (!window.dummyOverlays) window.dummyOverlays = {};
          window.dummyOverlays[`${row},${col}`] = existingTile;
        }
      } else if (selectedTile === 14) {
        map[row][col] = 14;
        updateRailTiles(row, col);
        if (col > 0) updateRailTiles(row, col - 1);
        if (col < cols - 1) updateRailTiles(row, col + 1);
      } else if (selectedTile === 2) {
        if (row === 0 || map[row-1][col] === 0) {
          map[row][col] = 1;
        } else {
          map[row][col] = 2;
        }
          // è¨­ç½®ç›´å¾Œã«è‰ãƒ»åœŸã®è‡ªå‹•å¤‰æ›å‡¦ç†ã‚’å¿…ãšå®Ÿè¡Œ
        for (let r = 0; r < rows; r++) {
          for (let c = 0; c < cols; c++) {
            if (map[r][c] === 1 && r > 0 && map[r-1][c] !== 0) {
              const tileAbove = map[r-1][c];
              if (tileAbove !== 4 && tileAbove !== 15 && tileAbove !== 16 && tileAbove !== 17 && tileAbove !== 10 && tileAbove !== 3) {
                map[r][c] = 2;
                if (window.markTileAndNeighborsDirty) window.markTileAndNeighborsDirty(r, c);
              }
            }
            if (map[r][c] === 2 && (r === 0 || map[r-1][c] === 0)) {
              map[r][c] = 1;
              if (window.markTileAndNeighborsDirty) window.markTileAndNeighborsDirty(r, c);
            }
          }
        }
      } else if (selectedTile === 9) {
        map[row][col] = 9;
        const key = `${row},${col}`;
        window.enemyDirs[key] = 1;
        draw();
      } else if (selectedTile === 7) {
        // ãƒˆãƒ©ãƒ³ãƒãƒªãƒ³ã®å ´åˆã¯è§’åº¦ã¨åŠ›ã‚’åˆæœŸåŒ–
        map[row][col] = 7;
        const key = `${row},${col}`;
        if (!window.trampolineAngles) window.trampolineAngles = {};
        if (!window.trampolinePowers) window.trampolinePowers = {};
        window.trampolineAngles[key] = 0; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ä¸Šå‘ãï¼ˆ0Â°ï¼‰
        window.trampolinePowers[key] = 2.2; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯2.2å€
      } else {
        map[row][col] = selectedTile;
      }
      if (window.markTileAndNeighborsDirty) {
        window.markTileAndNeighborsDirty(row, col);
      }
      draw();
    }

    function placeTileTouch(touch) {
      if (!window.canvas) return;
      
      // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®å®Ÿéš›ã®ã‚µã‚¤ã‚ºã¨è¡¨ç¤ºã‚µã‚¤ã‚ºã‚’å–å¾—
      const rect = window.canvas.getBoundingClientRect();
      
      // ã‚¿ãƒƒãƒä½ç½®ã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ç³»ã«å¤‰æ›
      const touchX = touch.clientX - rect.left;
      const touchY = touch.clientY - rect.top;
      
      // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®è¡¨ç¤ºã‚µã‚¤ã‚ºã¨å®Ÿéš›ã®ã‚µã‚¤ã‚ºã®æ¯”ç‡ã‚’è¨ˆç®—
      const scaleX = window.canvas.width / rect.width;
      const scaleY = window.canvas.height / rect.height;
      
      // ã‚¹ã‚±ãƒ¼ãƒ«ã‚’è€ƒæ…®ã—ã¦ã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ã‚’è¨ˆç®—
      const canvasX = touchX * scaleX;
      const canvasY = touchY * scaleY;
      
      // ã‚«ãƒ¡ãƒ©ä½ç½®ã‚’è€ƒæ…®ã—ã¦ãƒ¯ãƒ¼ãƒ«ãƒ‰åº§æ¨™ã‚’è¨ˆç®—
      const worldX = canvasX + camera.x;
      const worldY = canvasY + camera.y;
      
      // ã‚¿ã‚¤ãƒ«åº§æ¨™ã‚’è¨ˆç®—
      const col = Math.floor(worldX / TILE_SIZE);
      const row = Math.floor(worldY / TILE_SIZE);
      
      // é‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚’ç·©å’Œï¼ˆåŒã˜ã‚¿ã‚¤ãƒ«ã§ã‚‚å°‘ã—é–“éš”ã‚’ç©ºã‘ã‚Œã°é…ç½®å¯èƒ½ï¼‰
      const now = performance.now();
      if (col === lastPlacedTile.col && row === lastPlacedTile.row && now - lastTouchTime < 100) {
        return;
      }
      
      const maxCols = window.cols;
      const maxRows = window.rows;
      if (col < 0 || row < 0 || col >= maxCols || row >= maxRows) {
        if (col >= 0 && row >= 0 && now - lastOutOfBoundsWarning > 800) {
          showMessage("ç·¨é›†ã§ãã‚‹ç¯„å›²å¤–ã§ã™");
          lastOutOfBoundsWarning = now;
        }
        return;
      }

      if (!map[row]) return;

      if (isHandMode) {
        const blockId = map[row][col];
        if (blockId !== 0) {
          window.lastDetailRowCol = `${row},${col}`;
          showBlockDetail(blockId);
        }
        return;
      }
      lastPlacedTile = { row, col };
      lastTouchTime = now;
      
      if (!hasSavedState) {
        saveMapState();
        hasSavedState = true;
      }
      if (selectedTile === 10) {
        for (let r = 0; r < rows; r++) {
          for (let c = 0; c < cols; c++) {
            if (map[r][c] === 10) map[r][c] = 0;
          }
        }
        map[row][col] = 10;
      } else if (selectedTile === 19) {
        const existingTile = map[row][col];
        if (existingTile !== 0 && existingTile !== 19) {
          map[row][col] = 19;
          if (!window.dummyOverlays) window.dummyOverlays = {};
          window.dummyOverlays[`${row},${col}`] = existingTile;
        }
      } else if (selectedTile === 14) {
        map[row][col] = 14;
        updateRailTiles(row, col);
        if (col > 0) updateRailTiles(row, col - 1);
        if (col < cols - 1) updateRailTiles(row, col + 1);
      } else if (selectedTile === 2) {
        if (row === 0 || map[row-1][col] === 0) {
          map[row][col] = 1;
        } else {
          map[row][col] = 2;
        }
        for (let r = 0; r < rows; r++) {
          for (let c = 0; c < cols; c++) {
            if (map[r][c] === 1 && r > 0 && map[r-1][c] !== 0) {
              map[r][c] = 2;
            }
            if (map[r][c] === 2 && (r === 0 || map[r-1][c] === 0)) {
              map[r][c] = 1;
            }
          }
        }
      } else if (selectedTile === 9) {
        map[row][col] = 9;
        const key = `${row},${col}`;
        window.enemyDirs[key] = 1;
        draw();
      } else if (selectedTile === 7) {
        // ãƒˆãƒ©ãƒ³ãƒãƒªãƒ³ã®å ´åˆã¯è§’åº¦ã¨åŠ›ã‚’åˆæœŸåŒ–
        map[row][col] = 7;
        const key = `${row},${col}`;
        if (!window.trampolineAngles) window.trampolineAngles = {};
        if (!window.trampolinePowers) window.trampolinePowers = {};
        window.trampolineAngles[key] = 0; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ä¸Šå‘ãï¼ˆ0Â°ï¼‰
        window.trampolinePowers[key] = 2.2; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯2.2å€
      } else {
        map[row][col] = selectedTile;
      }
      if (window.markTileAndNeighborsDirty) {
        window.markTileAndNeighborsDirty(row, col);
      }
      draw(); // ã‚¿ã‚¤ãƒ«é…ç½®å¾Œã«æç”»ã‚’æ›´æ–°
    }

    // ãƒ¬ãƒ¼ãƒ«é€£çµçŠ¶æ…‹ã«å¿œã˜ã¦ã‚¿ã‚¤ãƒ«IDã‚’è‡ªå‹•ã§ç½®æ›
    function updateRailTiles(row, col) {
      if (map[row][col] < 12 || map[row][col] > 14) return;
      const left = col > 0 && map[row][col - 1] >= 12 && map[row][col - 1] <= 14;
      const right = col < cols - 1 && map[row][col + 1] >= 12 && map[row][col + 1] <= 14;
      if (!left && !right) {
        map[row][col] = 14; // å˜ä½“
      } else if (left && right) {
        map[row][col] = 12; // ä¸­é–“
      } else if (right) {
        map[row][col] = 13; // å³ç«¯
      } else if (left) {
        map[row][col] = 13; // å·¦ç«¯ï¼ˆåè»¢æç”»ã¯æç”»æ™‚ã«ï¼‰
      }
      if (window.markTileAndNeighborsDirty) {
        window.markTileAndNeighborsDirty(row, col);
      }
    }

    function update() {
      // é€£ç¶šçš„ãªã‚«ãƒ¡ãƒ©ç§»å‹•ï¼ˆver.2ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰
      if (window.keys) {
        if (window.keys['a'] || window.keys['A']) {
          camera.x -= cameraSpeed;
        }
        if (window.keys['d'] || window.keys['D']) {
          camera.x += cameraSpeed;
        }
        if (window.keys['w'] || window.keys['W']) {
          camera.y -= cameraSpeed;
        }
        if (window.keys['s'] || window.keys['S']) {
          camera.y += cameraSpeed;
        }
      }
      
      // ã‚«ãƒ¡ãƒ©ã®å¢ƒç•Œåˆ¶é™ã‚’æ›´æ–°
      updateCameraBounds();
      
      // åœŸã¨è‰ã®å¤‰æ›å‡¦ç†ï¼ˆ0.5ç§’é–“ã«ä¸€åº¦ï¼‰
      if (!window.groundDirtTimer) window.groundDirtTimer = 0;
      window.groundDirtTimer++;
      if (window.groundDirtTimer >= 30) { // 60fps * 0.5ç§’ = 30ãƒ•ãƒ¬ãƒ¼ãƒ 
        for (let r = 0; r < rows; r++) {
          for (let c = 0; c < cols; c++) {
            if (map[r][c] === 1 && r > 0 && map[r-1][c] !== 0) {
              // ã‚¹ã‚³ã‚¢ã‚’ã‚²ãƒƒãƒˆã§ãã‚‹ãƒ–ãƒ­ãƒƒã‚¯ã€ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã€ã‚¹ãƒãƒ¼ãƒ³åœ°ç‚¹ã€å‹•ãæ•µã¯é™¤å¤–
              const tileAbove = map[r-1][c];
              if (tileAbove !== 4 && tileAbove !== 15 && tileAbove !== 16 && tileAbove !== 17 && tileAbove !== 10 && tileAbove !== 3) {
                map[r][c] = 2; // groundã®ä¸Šã«ä½•ã‹ã‚ã‚Œã°dirtã«å¤‰æ›
              }
            }
            if (map[r][c] === 2 && (r === 0 || map[r-1][c] === 0)) {
              map[r][c] = 1; // dirtã®ä¸Šã«ä½•ã‚‚ãªã‘ã‚Œã°groundã«å¤‰æ›
            }
          }
        }
        window.groundDirtTimer = 0;
      }
    }
    

    function draw() {
      if (!window.canvas || !window.ctx) return; // canvasãŒå­˜åœ¨ã—ãªã„å ´åˆã¯æç”»ã‚’ã‚¹ã‚­ãƒƒãƒ—
      window.ctx.clearRect(0, 0, window.canvas.width, window.canvas.height);
      window.ctx.fillStyle = "#aee";
      window.ctx.fillRect(0, 0, window.canvas.width, window.canvas.height);
      
      // ã‚«ãƒ¡ãƒ©ç§»å‹•ã‚’é©ç”¨
      window.ctx.save();
      window.ctx.translate(-camera.x, -camera.y);

      const canvasWidth = window.canvas.width;
      const canvasHeight = window.canvas.height;
      const paddingTiles = 2;
      const visibleColStart = Math.max(0, Math.floor(camera.x / TILE_SIZE) - paddingTiles);
      const visibleColEnd = Math.min(window.cols, Math.ceil((camera.x + canvasWidth) / TILE_SIZE) + paddingTiles);
      const visibleRowStart = Math.max(0, Math.floor(camera.y / TILE_SIZE) - paddingTiles);
      const visibleRowEnd = Math.min(window.rows, Math.ceil((camera.y + canvasHeight) / TILE_SIZE) + paddingTiles);
      
      // 1. é€šå¸¸ã®ã‚¿ã‚¤ãƒ«ã‚’æç”»ï¼ˆãƒ€ãƒŸãƒ¼ãƒ–ãƒ­ãƒƒã‚¯ã¯é™¤å¤–ï¼‰
      for (let r = visibleRowStart; r < Math.min(visibleRowEnd, map.length); r++) {
        const rowTiles = map[r];
        if (!rowTiles) continue;
        for (let c = visibleColStart; c < Math.min(visibleColEnd, rowTiles.length); c++) {
          const tile = rowTiles[c];
          const x = c * TILE_SIZE;
          const y = r * TILE_SIZE;
          if (tile === 19) continue; // ãƒ€ãƒŸãƒ¼ãƒ–ãƒ­ãƒƒã‚¯ã¯å¾Œã§æç”»
          if (tile === 7) {
            // ãƒˆãƒ©ãƒ³ãƒãƒªãƒ³ã¯è§’åº¦ã«å¿œã˜ã¦å›è»¢æç”»
            const key = `${r},${c}`;
            const angle = (window.trampolineAngles[key] || 0) * Math.PI / 180;
            ctx.save();
            ctx.translate(x + TILE_SIZE/2, y + TILE_SIZE/2);
            ctx.rotate(angle);
            // ç¸¦é•·ã«æç”»ï¼ˆä¸­å¿ƒåŸºæº–ã§ä¸‹æ–¹å‘ã«ä¼¸ã°ã™ï¼‰
            ctx.drawImage(images[7], -TILE_SIZE/2, -TILE_SIZE*0.75, TILE_SIZE, TILE_SIZE*1.5);
            ctx.restore();
          } else if (tile >= 12 && tile <= 14) {
            if (tile === 12) {
              ctx.drawImage(images[12], x, y, TILE_SIZE, TILE_SIZE);
            } else if (tile === 13) {
              const left = c > 0 && map[r][c-1] >= 12 && map[r][c-1] <= 14;
              if (left) {
                ctx.drawImage(images[13], x, y, TILE_SIZE, TILE_SIZE);
              } else {
                ctx.save();
                ctx.translate(x + TILE_SIZE, y);
                ctx.scale(-1, 1);
                ctx.drawImage(images[13], 0, 0, TILE_SIZE, TILE_SIZE);
                ctx.restore();
              }
            } else if (tile === 14) {
              ctx.drawImage(images[14], x, y, TILE_SIZE, TILE_SIZE);
            }
          } else if (tile >= 20 && tile <= 30) {
            ctx.drawImage(images[tile], x, y, TILE_SIZE, TILE_SIZE);
          } else if (tile !== 0 && images[tile]) {
            ctx.drawImage(images[tile], x, y, TILE_SIZE, TILE_SIZE);
          }
        }
      }
      // 2. ãƒ€ãƒŸãƒ¼ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä¸€ç•ªæ‰‹å‰ã«æç”»
      for (let r = visibleRowStart; r < Math.min(visibleRowEnd, map.length); r++) {
        const rowTiles = map[r];
        if (!rowTiles) continue;
        for (let c = visibleColStart; c < Math.min(visibleColEnd, rowTiles.length); c++) {
          const tile = rowTiles[c];
          if (tile === 19 && window.dummyOverlays && window.dummyOverlays[`${r},${c}`]) {
            const x = c * TILE_SIZE;
            const y = r * TILE_SIZE;
            const drawTile = window.dummyOverlays[`${r},${c}`];
            if (drawTile >= 12 && drawTile <= 14) {
              if (drawTile === 12) {
                ctx.drawImage(images[12], x, y, TILE_SIZE, TILE_SIZE);
              } else if (drawTile === 13) {
                const left = c > 0 && map[r][c-1] >= 12 && map[r][c-1] <= 14;
                if (left) {
                  ctx.drawImage(images[13], x, y, TILE_SIZE, TILE_SIZE);
                } else {
                  ctx.save();
                  ctx.translate(x + TILE_SIZE, y);
                  ctx.scale(-1, 1);
                  ctx.drawImage(images[13], 0, 0, TILE_SIZE, TILE_SIZE);
                  ctx.restore();
                }
              } else if (drawTile === 14) {
                ctx.drawImage(images[14], x, y, TILE_SIZE, TILE_SIZE);
              }
            } else if (drawTile >= 20 && drawTile <= 30) {
              ctx.drawImage(images[drawTile], x, y, TILE_SIZE, TILE_SIZE);
            } else if (drawTile !== 0 && images[drawTile]) {
              ctx.drawImage(images[drawTile], x, y, TILE_SIZE, TILE_SIZE);
            }
            ctx.save();
            ctx.strokeStyle = "rgba(255, 0, 0, 0.7)";
            ctx.lineWidth = 2;
            ctx.strokeRect(x + 1, y + 1, TILE_SIZE - 2, TILE_SIZE - 2);
            ctx.restore();
          }
        }
      }
      if (window.showCollisionBoxes) {
        ctx.save();
        ctx.strokeStyle = 'rgba(255, 64, 64, 0.8)';
        const pixelRatio = window.renderPixelRatio || 1;
        ctx.lineWidth = 1 / pixelRatio;
        for (let r = visibleRowStart; r < Math.min(visibleRowEnd, map.length); r++) {
          const rowTiles = map[r];
          if (!rowTiles) continue;
          for (let c = visibleColStart; c < Math.min(visibleColEnd, rowTiles.length); c++) {
            let drawTile = rowTiles[c];
            if (drawTile === 0) continue;
            if (drawTile === 19 && window.dummyOverlays && window.dummyOverlays[`${r},${c}`]) {
              drawTile = window.dummyOverlays[`${r},${c}`];
            }
            const x = c * TILE_SIZE;
            const y = r * TILE_SIZE;
            ctx.strokeRect(x, y, TILE_SIZE, TILE_SIZE);
          }
        }
        ctx.restore();
      }
      // 3. å‹•ãæ•µã®çŸ¢å°ã‚’ä¸€ç•ªæ‰‹å‰ã«æç”»
      for (let r = visibleRowStart; r < Math.min(visibleRowEnd, rows); r++) {
        for (let c = visibleColStart; c < Math.min(visibleColEnd, cols); c++) {
          if (map[r][c] === 9) {
            const x = c * TILE_SIZE;
            const y = r * TILE_SIZE;
            const key = `${r},${c}`;
            const dir = window.enemyDirs[key] !== undefined ? window.enemyDirs[key] : 1;
            ctx.save();
            ctx.font = 'bold ' + Math.floor(TILE_SIZE * 1.2) + 'px sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.globalAlpha = 1.0;
            ctx.fillStyle = '#f00';
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 4;
            const arrow = dir === 1 ? 'â†’' : 'â†';
            ctx.strokeText(arrow, x + TILE_SIZE/2, y + TILE_SIZE/2);
            ctx.fillText(arrow, x + TILE_SIZE/2, y + TILE_SIZE/2);
            ctx.restore();
          }
        }
      }
      // ã‚°ãƒªãƒƒãƒ‰æç”»
      if (window.showGrid) {
        ctx.strokeStyle = "rgba(255, 255, 255, 0.3)";
        ctx.lineWidth = 1;
        // ç”»é¢ã«æ˜ ã‚‹ç¯„å›²ã ã‘ã‚°ãƒªãƒƒãƒ‰ã‚’æç”»
        const gridStartCol = Math.max(0, Math.floor(camera.x / TILE_SIZE));
        const gridEndCol = Math.min(window.cols, Math.ceil((camera.x + window.canvas.width) / TILE_SIZE));
        const gridStartRow = Math.max(0, Math.floor(camera.y / TILE_SIZE));
        const gridEndRow = Math.min(window.rows, Math.ceil((camera.y + window.canvas.height) / TILE_SIZE));
        for (let c = gridStartCol; c <= gridEndCol; c++) {
          const x = c * TILE_SIZE;
          window.ctx.beginPath();
          window.ctx.moveTo(x, 0);
          window.ctx.lineTo(x, window.canvas.height);
          window.ctx.stroke();
        }
        for (let r = gridStartRow; r <= gridEndRow; r++) {
          const y = r * TILE_SIZE;
          window.ctx.beginPath();
          window.ctx.moveTo(0, y);
          window.ctx.lineTo(window.canvas.width, y);
          window.ctx.stroke();
        }
      }
      
      // ã‚«ãƒ¡ãƒ©ç§»å‹•ã®å¾©å…ƒ
      window.ctx.restore();
    }

    // ã‚¨ãƒ‡ã‚£ã‚¿ãƒšãƒ¼ã‚¸ç”¨ã®ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ï¼ˆã‚¹ãƒ ãƒ¼ã‚ºãªã‚«ãƒ¡ãƒ©ç§»å‹•ã®ãŸã‚ï¼‰
    function gameLoop() {
      update();
      draw();
      requestAnimationFrame(gameLoop);
    }
    
    // ã‚¨ãƒ‡ã‚£ã‚¿ãƒšãƒ¼ã‚¸ã§ã¯gameLoopã‚’å®Ÿè¡Œ
    gameLoop();

    Promise.all(Object.values(images).map(img => new Promise(res => img.onload = res))).then(() => {
      // ã‚¨ãƒ‡ã‚£ã‚¿ãƒšãƒ¼ã‚¸ã§ã¯åˆæœŸæç”»ã®ã¿å®Ÿè¡Œ
      if (window.canvas && window.ctx) {
        updateCameraBounds(); // åˆæœŸã‚«ãƒ¡ãƒ©å¢ƒç•Œåˆ¶é™ã‚’é©ç”¨
        draw();
      }
    });

    function saveMap() {
      const mapData = {
        map: map,
        dummyOverlays: window.dummyOverlays || {},
        enemyDirs: window.enemyDirs || {},
        trampolineAngles: window.trampolineAngles || {},
        trampolinePowers: window.trampolinePowers || {},
        enemyProps: window.enemyProps || {},
      };
      localStorage.setItem("world_" + slotName, JSON.stringify(mapData));
      if (typeof saveThumbnailData === 'function') {
        try {
          saveThumbnailData();
        } catch (err) {
          console.warn('ã‚µãƒ ãƒã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ:', err);
        }
      }
      localStorage.removeItem("thumb_" + slotName);
    }

    function loadMap() {
      const saved = localStorage.getItem("world_" + slotName);
      if (saved) {
        try {
          const mapData = JSON.parse(saved);
          const mapSource = Array.isArray(mapData)
            ? mapData
            : (mapData && Array.isArray(mapData.map) ? mapData.map : null);

          if (mapSource) {
            const dims = updateEditorBounds(mapSource);
            const result = applyWorldToEditor(mapData);
            if (result.mismatch) {
              showMessage("ãƒãƒƒãƒ—ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ï¼ˆç¯„å›²å¤–ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’å‰Šé™¤ï¼‰");
            } else {
              showMessage("ãƒãƒƒãƒ—ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼");
            }
            return;
          }
        } catch (e) {
          showMessage("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: " + e.message);
          return;
        }
      } else {
        showMessage("ä¿å­˜ã•ã‚ŒãŸãƒãƒƒãƒ—ãŒã‚ã‚Šã¾ã›ã‚“ï¼");
      }
      // å¤±æ•—æ™‚ã¯åˆæœŸåŒ–
      window.dummyOverlays = {};
      window.enemyDirs = {};
      window.trampolineAngles = {};
      window.trampolinePowers = {};
      window.enemyProps = {};
      applyWorldToEditor([], {
        targetRows: window.rows,
        targetCols: window.cols,
        minRows: window.rows,
        minCols: window.cols
      });
    }

    // ãƒãƒƒãƒ—ã®çŠ¶æ…‹ã‚’ä¿å­˜
    function saveMapState() {
      if (isUndoRedoAction) return;
      const mapCopy = map.map(row => [...row]);
      const dummyOverlaysCopy = window.dummyOverlays ? JSON.parse(JSON.stringify(window.dummyOverlays)) : {};
      const enemyDirsCopy = window.enemyDirs ? JSON.parse(JSON.stringify(window.enemyDirs)) : {};
      const trampolineAnglesCopy = window.trampolineAngles ? JSON.parse(JSON.stringify(window.trampolineAngles)) : {};
      const enemyPropsCopy = window.enemyProps ? JSON.parse(JSON.stringify(window.enemyProps)) : {};
      undoHistory.push({
        map: mapCopy,
        dummyOverlays: dummyOverlaysCopy,
        enemyDirs: enemyDirsCopy,
        trampolineAngles: trampolineAnglesCopy,
        trampolinePowers: window.trampolinePowers ? JSON.parse(JSON.stringify(window.trampolinePowers)) : {},
        enemyProps: enemyPropsCopy
      });
      if (undoHistory.length > 20) undoHistory.shift();
      redoHistory = [];
    }

    // å–ã‚Šæ¶ˆã—æ©Ÿèƒ½
    function undo() {
      if (undoHistory.length === 0) {
        showMessage("å–ã‚Šæ¶ˆã™æ“ä½œãŒã‚ã‚Šã¾ã›ã‚“");
        return;
      }
      
      // ç¾åœ¨ã®çŠ¶æ…‹ã‚’ã‚„ã‚Šç›´ã—å±¥æ­´ã«ä¿å­˜
      const currentMap = map.map(row => [...row]);
      const currentDummyOverlays = window.dummyOverlays ? JSON.parse(JSON.stringify(window.dummyOverlays)) : {};
      const currentEnemyDirs = window.enemyDirs ? JSON.parse(JSON.stringify(window.enemyDirs)) : {};
      const currentTrampolineAngles = window.trampolineAngles ? JSON.parse(JSON.stringify(window.trampolineAngles)) : {};
      const currentEnemyProps = window.enemyProps ? JSON.parse(JSON.stringify(window.enemyProps)) : {};
      const currentTrampolinePowers = window.trampolinePowers ? JSON.parse(JSON.stringify(window.trampolinePowers)) : {};
      redoHistory.push({
        map: currentMap,
        dummyOverlays: currentDummyOverlays,
        enemyDirs: currentEnemyDirs,
        trampolineAngles: currentTrampolineAngles,
        trampolinePowers: currentTrampolinePowers,
        enemyProps: currentEnemyProps
      });
      
      // å‰ã®çŠ¶æ…‹ã‚’å¾©å…ƒ
      const previousState = undoHistory.pop();
      isUndoRedoAction = true;
      
      map.length = 0;
      map.push(...previousState.map);
      window.dummyOverlays = previousState.dummyOverlays;
      window.enemyDirs = previousState.enemyDirs;
      window.trampolineAngles = previousState.trampolineAngles;
      window.trampolinePowers = previousState.trampolinePowers || {};
      window.enemyProps = previousState.enemyProps;
      
      if (window.invalidateStaticChunks) window.invalidateStaticChunks();
      isUndoRedoAction = false;
      showMessage("å–ã‚Šæ¶ˆã—ã¾ã—ãŸ");
    }

    // ã‚„ã‚Šç›´ã—æ©Ÿèƒ½
    function redo() {
      if (redoHistory.length === 0) {
        showMessage("ã‚„ã‚Šç›´ã™æ“ä½œãŒã‚ã‚Šã¾ã›ã‚“");
        return;
      }
      
      // ç¾åœ¨ã®çŠ¶æ…‹ã‚’ã‚„ã‚Šç›´ã—å±¥æ­´ã«ä¿å­˜
      const currentMap = map.map(row => [...row]);
      const currentDummyOverlays = window.dummyOverlays ? JSON.parse(JSON.stringify(window.dummyOverlays)) : {};
      const currentEnemyDirs = window.enemyDirs ? JSON.parse(JSON.stringify(window.enemyDirs)) : {};
      const currentTrampolineAngles = window.trampolineAngles ? JSON.parse(JSON.stringify(window.trampolineAngles)) : {};
      const currentEnemyProps = window.enemyProps ? JSON.parse(JSON.stringify(window.enemyProps)) : {};
      const currentTrampolinePowers = window.trampolinePowers ? JSON.parse(JSON.stringify(window.trampolinePowers)) : {};
      redoHistory.push({
        map: currentMap,
        dummyOverlays: currentDummyOverlays,
        enemyDirs: currentEnemyDirs,
        trampolineAngles: currentTrampolineAngles,
        trampolinePowers: currentTrampolinePowers,
        enemyProps: currentEnemyProps
      });
      
      // æ¬¡ã®çŠ¶æ…‹ã‚’å¾©å…ƒ
      const nextState = redoHistory.pop();
      isUndoRedoAction = true;
      
      map.length = 0;
      map.push(...nextState.map);
      window.dummyOverlays = nextState.dummyOverlays;
      window.enemyDirs = nextState.enemyDirs;
      window.trampolineAngles = nextState.trampolineAngles;
      window.trampolinePowers = nextState.trampolinePowers || {};
      window.enemyProps = nextState.enemyProps;
      
      if (window.invalidateStaticChunks) window.invalidateStaticChunks();
      isUndoRedoAction = false;
      showMessage("ã‚„ã‚Šç›´ã—ã¾ã—ãŸ");
    }

    // ãƒ¯ãƒ¼ãƒ«ãƒ‰æ¨ªå¹…ã‚’é©ç”¨ã™ã‚‹é–¢æ•°
    function applyWorldWidth(newWidth) {
      if (newWidth === window.cols) {
        showMessage("ç¾åœ¨ã®æ¨ªå¹…ã¨åŒã˜ã§ã™");
        return;
      }
      
      showConfirm(`ãƒ¯ãƒ¼ãƒ«ãƒ‰æ¨ªå¹…ã‚’${newWidth}ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®ãƒãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒã•ã‚Œã¾ã™ã€‚`, () => {
        // ç¾åœ¨ã®çŠ¶æ…‹ã‚’å±¥æ­´ã«ä¿å­˜
        saveMapState();
        
        const oldCols = window.cols;
        
        if (newWidth > oldCols) {
          // æ¨ªå¹…ã‚’æ‹¡å¼µ
          for (let r = 0; r < window.rows; r++) {
            for (let c = oldCols; c < newWidth; c++) {
              map[r].push(0);
            }
          }
        } else {
          // æ¨ªå¹…ã‚’ç¸®å°ï¼ˆå³ç«¯ã‹ã‚‰å‰Šé™¤ï¼‰
          for (let r = 0; r < window.rows; r++) {
            map[r].splice(newWidth);
          }
        }
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’æ›´æ–°
        window.cols = newWidth;
        cols = window.cols;
        window.trimWorldMetadata(window.rows, window.cols);
        
        // ã‚«ãƒ¡ãƒ©å¢ƒç•Œã‚’æ›´æ–°
        updateCameraBounds();
        
        // å…¥åŠ›æ¬„ã‚’æ›´æ–°
        document.getElementById("worldWidthInput").value = newWidth;
        if (window.invalidateStaticChunks) window.invalidateStaticChunks();
        showMessage(`ãƒ¯ãƒ¼ãƒ«ãƒ‰æ¨ªå¹…ã‚’${newWidth}ã«å¤‰æ›´ã—ã¾ã—ãŸ`);
      });
    }

    // ãƒ¯ãƒ¼ãƒ«ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    function exportWorldData() {
      const worldData = {
        name: slotName,
        map: map,
        dummyOverlays: window.dummyOverlays || {},
        enemyDirs: window.enemyDirs || {},
        trampolineAngles: window.trampolineAngles || {},
        trampolinePowers: window.trampolinePowers || {},
        enemyProps: window.enemyProps || {},
        exportDate: new Date().toISOString(),
        version: "1.0"
      };
      
      const dataStr = JSON.stringify(worldData, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      
      const link = document.createElement('a');
      link.href = URL.createObjectURL(dataBlob);
      link.download = `${slotName}_world.json`;
      link.click();
      
      URL.revokeObjectURL(link.href);
      showMessage("ãƒ¯ãƒ¼ãƒ«ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼");
    }

    // JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ¯ãƒ¼ãƒ«ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    function importWorldData(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const worldData = JSON.parse(e.target.result);
          
          // ãƒ‡ãƒ¼ã‚¿å½¢å¼ã®æ¤œè¨¼
          if (!worldData.map || !Array.isArray(worldData.map)) {
            showMessage("ç„¡åŠ¹ãªãƒ¯ãƒ¼ãƒ«ãƒ‰ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™");
            return;
          }

          const dims = window.getWorldDimensions(worldData.map);
          const mismatch = !!(dims && (dims.rows !== window.rows || dims.cols !== window.cols));
          if (mismatch) {
            showMessage(`è­¦å‘Š: ãƒãƒƒãƒ—ã‚µã‚¤ã‚ºãŒç•°ãªã‚Šã¾ã™ï¼ˆç¾åœ¨: ${window.cols}Ã—${window.rows} â†’ èª­ã¿è¾¼ã¿: ${dims.cols || 0}Ã—${dims.rows || 0}ï¼‰`);
          }
          
          const mismatchNote = mismatch
            ? `<br><span style="display:block;margin-top:12px;color:#ff4136;font-size:14px;">â€» ç·¨é›†å¯èƒ½ç¯„å›²å¤–ã®ãƒ–ãƒ­ãƒƒã‚¯ã¯å‰Šé™¤ã•ã‚Œã¾ã™ã€‚</span>`
            : "";
          showConfirm(`ãƒ¯ãƒ¼ãƒ«ãƒ‰ã€Œ${worldData.name || 'ä¸æ˜'}ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®ãƒãƒƒãƒ—ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚${mismatchNote}`, () => {
            // ç¾åœ¨ã®çŠ¶æ…‹ã‚’å±¥æ­´ã«ä¿å­˜
            saveMapState();
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            updateEditorBounds(worldData.map);
            const appliedInfo = applyWorldToEditor(worldData);

            if (mismatch || appliedInfo.mismatch) {
              showMessage("ãƒ¯ãƒ¼ãƒ«ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼ï¼ˆç¯„å›²å¤–ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’å‰Šé™¤ï¼‰");
            } else {
              showMessage("ãƒ¯ãƒ¼ãƒ«ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼");
            }
          });
          
        } catch (error) {
          showMessage("ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
        }
      };
      reader.readAsText(file);
    }

    // --- ãƒ–ãƒ­ãƒƒã‚¯è©³ç´°ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º ---
    const blockNames = {
      0: 'æ¶ˆã—ã‚´ãƒ ',
      1: 'è‰',
      2: 'åœŸ',
      3: 'æ£˜',
      4: 'ã‚´ãƒ¼ãƒ«',
      5: 'çŸ³',
      6: 'æ¯’',
      7: 'ãã®ã“',
      8: 'ãƒã‚·ã‚´',
      9: 'å‹•ãæ•µ',
      10: 'ã‚¹ãƒãƒ¼ãƒ³',
      11: 'å£Šã‚Œã‚‹ãƒ–ãƒ­ãƒƒã‚¯',
      12: 'ãƒ¬ãƒ¼ãƒ«(ä¸­)',
      13: 'ãƒ¬ãƒ¼ãƒ«(ç«¯)',
      14: 'ãƒ¬ãƒ¼ãƒ«(å˜ä½“)',
      15: 'ã‚³ã‚¤ãƒ³',
      16: 'ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ',
      17: 'é‡‘ã‚´ãƒ¼ãƒ«',
      19: 'ãƒ€ãƒŸãƒ¼ãƒ–ãƒ­ãƒƒã‚¯',
      20: 'è‰²ãƒ–ãƒ­ãƒƒã‚¯0',
      21: 'è‰²ãƒ–ãƒ­ãƒƒã‚¯1',
      22: 'è‰²ãƒ–ãƒ­ãƒƒã‚¯2',
      23: 'è‰²ãƒ–ãƒ­ãƒƒã‚¯3',
      24: 'è‰²ãƒ–ãƒ­ãƒƒã‚¯4',
      25: 'è‰²ãƒ–ãƒ­ãƒƒã‚¯5',
      26: 'è‰²ãƒ–ãƒ­ãƒƒã‚¯6',
      27: 'è‰²ãƒ–ãƒ­ãƒƒã‚¯7',
      28: 'è‰²ãƒ–ãƒ­ãƒƒã‚¯8',
      29: 'è‰²ãƒ–ãƒ­ãƒƒã‚¯9',
      30: 'è‰²ãƒ–ãƒ­ãƒƒã‚¯10',
      31: 'æ‰‹',
      32: 'ã‚¯ãƒªã‚¢',
    };

    // ãƒ–ãƒ­ãƒƒã‚¯è©³ç´°ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º
    function showBlockDetail(blockId) {
      const popup = document.getElementById('blockDetailPopup');
      const img = document.getElementById('blockDetailImg');
      const name = document.getElementById('blockDetailName');
      if (images[blockId]) {
        img.src = images[blockId].src;
        img.style.display = '';
      } else {
        img.style.display = 'none';
      }
      name.textContent = blockNames[blockId] || `ID:${blockId}`;

      // ãã®ã“ï¼ˆblockId===7ï¼‰ã®å ´åˆã®ã¿ã‚¸ãƒ£ãƒ³ãƒ—æŒ™å‹•è¨­å®šUIã‚’è¡¨ç¤º
      const mushroomSettings = document.getElementById('mushroomSettings');
      if (blockId === 7) {
        if (mushroomSettings) {
          mushroomSettings.style.display = 'block';
          // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å€¤ã‚’localStorageã‹ã‚‰å¾©å…ƒ
          const checkbox = document.getElementById('mushroomMoveCheckbox');
          if (checkbox) {
            const saved = localStorage.getItem('editor_mushroomMove');
            checkbox.checked = saved === 'true';
            // ãƒã‚§ãƒƒã‚¯å¤‰æ›´æ™‚ã«localStorageã¸ä¿å­˜
            checkbox.onchange = function() {
              localStorage.setItem('editor_mushroomMove', checkbox.checked ? 'true' : 'false');
            };
          }
        }
      } else {
        if (mushroomSettings) mushroomSettings.style.display = 'none';
      }

      // æ—¢å­˜ã®è¨­å®šUIã‚’æ¶ˆã™
      let old = document.getElementById('blockDetailSettings');
      if (old) old.remove();

      // è¨­å®šUIè¿½åŠ 
      const settings = document.createElement('div');
      settings.id = 'blockDetailSettings';
      settings.style.display = 'flex';
      settings.style.flexDirection = 'column';
      settings.style.marginLeft = '16px';
      settings.style.gap = '8px';

      // --- å‹•ãæ•µï¼ˆæ£˜ï¼‰å°‚ç”¨ã‚¯ãƒªãƒƒã‚¯åˆ‡ã‚Šæ›¿ãˆUI ---
      if (blockId === 9 && window.lastDetailRowCol) {
        // --- ã“ã“ã‹ã‚‰èª¬æ˜æ–‡ã‚’è¿½åŠ  ---
        const desc = document.createElement('div');
        desc.style.fontSize = '15px';
        desc.style.marginBottom = '6px';
        desc.innerHTML = '<span style="color:#ff4136;font-weight:bold;">ğŸŸ¥ èµ¤ï¼šæ­»äº¡åˆ¤å®šï¼ˆè§¦ã‚Œã‚‹ã¨æ­»ã¬ï¼‰</span><br><span style="color:#2ecc40;font-weight:bold;">ğŸŸ© ç·‘ï¼šå½“ãŸã‚Šåˆ¤å®šï¼ˆå®‰å…¨ãƒ»æŠ¼ã—æˆ»ã—ãƒ»ä¹—ã‚Œã‚‹ï¼‰</span><br><span style="color:#333;">ã‚¯ãƒªãƒƒã‚¯ã§åˆ‡ã‚Šæ›¿ãˆ</span>';
        settings.appendChild(desc);
        // --- ã“ã“ã¾ã§èª¬æ˜æ–‡ ---
        if (!window.enemyProps) window.enemyProps = {};
        const key = window.lastDetailRowCol;
        if (!window.enemyProps[key]) {
          window.enemyProps[key] = {
            hitTop: false,
            hitSide: false,
            hitBottom: false,
            deathTop: true,
            deathSide: true,
            deathBottom: true
          };
        }
        if (!window.enemyDirs) window.enemyDirs = {};
        if (window.enemyDirs[key] === undefined) window.enemyDirs[key] = 1;
        const props = window.enemyProps[key];
        
        // ç”»åƒã®å‘¨ã‚Šã«ã‚¯ãƒªãƒƒã‚¯ãƒœã‚¿ãƒ³ã‚’é…ç½®ã™ã‚‹ãƒ©ãƒƒãƒ‘ãƒ¼
        const wrap = document.createElement('div');
        wrap.style.display = 'grid';
        wrap.style.gridTemplateRows = '32px 48px 32px';
        wrap.style.gridTemplateColumns = '48px 48px 48px';
        wrap.style.gap = '2px';
        wrap.style.alignItems = 'center';
        wrap.style.justifyItems = 'center';
        wrap.style.marginBottom = '8px';
        
        // çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
        function toggleState(direction) {
          const currentState = {
            death: props[`death${direction}`],
            hit: props[`hit${direction}`]
          };
          
          // çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆï¼šæ­»äº¡åˆ¤å®š â†’ å½“ãŸã‚Šåˆ¤å®š â†’ æ­»äº¡åˆ¤å®š
          if (currentState.death && !currentState.hit) {
            // æ­»äº¡åˆ¤å®šON â†’ å½“ãŸã‚Šåˆ¤å®šON
            props[`death${direction}`] = false;
            props[`hit${direction}`] = true;
          } else {
            // å½“ãŸã‚Šåˆ¤å®šON â†’ æ­»äº¡åˆ¤å®šON
            props[`death${direction}`] = true;
            props[`hit${direction}`] = false;
          }
          
          saveMapState();
          draw();
          updateButtons(); // ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’æ›´æ–°
        }
        
        // ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateButtons() {
          // ä¸Šãƒœã‚¿ãƒ³
          const topBtn = document.getElementById('topBtn');
          if (topBtn) {
            if (props.deathTop) {
              topBtn.style.backgroundColor = '#ff4136';
              topBtn.textContent = 'ğŸŸ¥';
              topBtn.title = 'ä¸Š:æ­»äº¡åˆ¤å®šONï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å½“ãŸã‚Šåˆ¤å®šã«å¤‰æ›´ï¼‰';
            } else if (props.hitTop) {
              topBtn.style.backgroundColor = '#2ecc40';
              topBtn.textContent = 'ğŸŸ©';
              topBtn.title = 'ä¸Š:å½“ãŸã‚Šåˆ¤å®šONï¼ˆã‚¯ãƒªãƒƒã‚¯ã§æ­»äº¡åˆ¤å®šã«å¤‰æ›´ï¼‰';
            }
          }
          
          // å·¦ãƒœã‚¿ãƒ³
          const leftBtn = document.getElementById('leftBtn');
          if (leftBtn) {
            if (props.deathSide) {
              leftBtn.style.backgroundColor = '#ff4136';
              leftBtn.textContent = 'ğŸŸ¥';
              leftBtn.title = 'å·¦:æ­»äº¡åˆ¤å®šONï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å½“ãŸã‚Šåˆ¤å®šã«å¤‰æ›´ï¼‰';
            } else if (props.hitSide) {
              leftBtn.style.backgroundColor = '#2ecc40';
              leftBtn.textContent = 'ğŸŸ©';
              leftBtn.title = 'å·¦:å½“ãŸã‚Šåˆ¤å®šONï¼ˆã‚¯ãƒªãƒƒã‚¯ã§æ­»äº¡åˆ¤å®šã«å¤‰æ›´ï¼‰';
            }
          }
          
          // å³ãƒœã‚¿ãƒ³
          const rightBtn = document.getElementById('rightBtn');
          if (rightBtn) {
            if (props.deathSide) {
              rightBtn.style.backgroundColor = '#ff4136';
              rightBtn.textContent = 'ğŸŸ¥';
              rightBtn.title = 'å³:æ­»äº¡åˆ¤å®šONï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å½“ãŸã‚Šåˆ¤å®šã«å¤‰æ›´ï¼‰';
            } else if (props.hitSide) {
              rightBtn.style.backgroundColor = '#2ecc40';
              rightBtn.textContent = 'ğŸŸ©';
              rightBtn.title = 'å³:å½“ãŸã‚Šåˆ¤å®šONï¼ˆã‚¯ãƒªãƒƒã‚¯ã§æ­»äº¡åˆ¤å®šã«å¤‰æ›´ï¼‰';
            }
          }
          
          // ä¸‹ãƒœã‚¿ãƒ³
          const bottomBtn = document.getElementById('bottomBtn');
          if (bottomBtn) {
            if (props.deathBottom) {
              bottomBtn.style.backgroundColor = '#ff4136';
              bottomBtn.textContent = 'ğŸŸ¥';
              bottomBtn.title = 'ä¸‹:æ­»äº¡åˆ¤å®šONï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å½“ãŸã‚Šåˆ¤å®šã«å¤‰æ›´ï¼‰';
            } else if (props.hitBottom) {
              bottomBtn.style.backgroundColor = '#2ecc40';
              bottomBtn.textContent = 'ğŸŸ©';
              bottomBtn.title = 'ä¸‹:å½“ãŸã‚Šåˆ¤å®šONï¼ˆã‚¯ãƒªãƒƒã‚¯ã§æ­»äº¡åˆ¤å®šã«å¤‰æ›´ï¼‰';
            }
          }
        }
        
        // ä¸Šãƒœã‚¿ãƒ³
        const topBtn = document.createElement('button');
        topBtn.id = 'topBtn';
        topBtn.style.width = '32px';
        topBtn.style.height = '32px';
        topBtn.style.border = '2px solid #333';
        topBtn.style.borderRadius = '4px';
        topBtn.style.cursor = 'pointer';
        topBtn.style.fontSize = '16px';
        topBtn.onclick = () => toggleState('Top');
        wrap.appendChild(document.createElement('span'));
        wrap.appendChild(topBtn);
        wrap.appendChild(document.createElement('span'));
        
        // å·¦ãƒœã‚¿ãƒ³
        const leftBtn = document.createElement('button');
        leftBtn.id = 'leftBtn';
        leftBtn.style.width = '32px';
        leftBtn.style.height = '32px';
        leftBtn.style.border = '2px solid #333';
        leftBtn.style.borderRadius = '4px';
        leftBtn.style.cursor = 'pointer';
        leftBtn.style.fontSize = '16px';
        leftBtn.onclick = () => toggleState('Side');
        wrap.appendChild(leftBtn);
        
        // ç”»åƒ
        const imgClone = img.cloneNode(true);
        imgClone.style.margin = '0';
        wrap.appendChild(imgClone);
        
        // å³ãƒœã‚¿ãƒ³
        const rightBtn = document.createElement('button');
        rightBtn.id = 'rightBtn';
        rightBtn.style.width = '32px';
        rightBtn.style.height = '32px';
        rightBtn.style.border = '2px solid #333';
        rightBtn.style.borderRadius = '4px';
        rightBtn.style.cursor = 'pointer';
        rightBtn.style.fontSize = '16px';
        rightBtn.onclick = () => toggleState('Side');
        wrap.appendChild(rightBtn);
        
        // ä¸‹ãƒœã‚¿ãƒ³
        const bottomBtn = document.createElement('button');
        bottomBtn.id = 'bottomBtn';
        bottomBtn.style.width = '32px';
        bottomBtn.style.height = '32px';
        bottomBtn.style.border = '2px solid #333';
        bottomBtn.style.borderRadius = '4px';
        bottomBtn.style.cursor = 'pointer';
        bottomBtn.style.fontSize = '16px';
        bottomBtn.onclick = () => toggleState('Bottom');
        wrap.appendChild(document.createElement('span'));
        wrap.appendChild(bottomBtn);
        wrap.appendChild(document.createElement('span'));
        
        settings.appendChild(wrap);
        
        // åˆæœŸè¡¨ç¤ºã‚’è¨­å®š
        updateButtons();
        
        // --- æ–¹å‘ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ ---
        const dirLabel = document.createElement('label');
        dirLabel.textContent = 'ç§»å‹•æ–¹å‘:';
        dirLabel.style.marginTop = '8px';
        dirLabel.style.display = 'flex';
        dirLabel.style.alignItems = 'center';
        const dirSlider = document.createElement('input');
        dirSlider.type = 'range';
        dirSlider.min = -1;
        dirSlider.max = 1;
        dirSlider.step = 2;
        dirSlider.value = window.enemyDirs[key];
        dirSlider.style.width = '80px';
        const dirText = document.createElement('span');
        dirText.textContent = (window.enemyDirs[key] == 1 ? 'â†’' : 'â†');
        dirSlider.oninput = function() {
          window.enemyDirs[key] = parseInt(this.value);
          dirText.textContent = (window.enemyDirs[key] == 1 ? 'â†’' : 'â†');
          saveMapState();
          draw();
        };
        dirLabel.appendChild(dirSlider);
        dirLabel.appendChild(dirText);
        settings.appendChild(dirLabel);
      }
      // --- ãƒˆãƒ©ãƒ³ãƒãƒªãƒ³è§’åº¦ï¼ˆã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼: 0-359ï¼‰ ---
      if (blockId === 7 && window.lastDetailRowCol) {
        const key = window.lastDetailRowCol;
        let angle = window.trampolineAngles[key] || 0;
        
        // èª¬æ˜æ–‡ã‚’è¿½åŠ 
        const desc = document.createElement('div');
        desc.style.fontSize = '14px';
        desc.style.marginBottom = '8px';
        desc.style.color = '#666';
        desc.innerHTML = 'è§’åº¦: <b>0Â°=ä¸Šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰</b>, 90Â°=å³, 180Â°=ä¸‹, 270Â°=å·¦';
        settings.appendChild(desc);
        
        const label = document.createElement('label');
        label.textContent = 'è§’åº¦:';
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '8px';
        
        const slider = document.createElement('input');
        slider.type = 'range';
        slider.min = 0;
        slider.max = 359;
        slider.step = 0.5; // ã‚ˆã‚Šç´°ã‹ã„è§’åº¦èª¿æ•´
        slider.value = angle;
        slider.style.width = '120px';
        
        // æ–°ã—ããƒˆãƒ©ãƒ³ãƒãƒªãƒ³ã‚’ç½®ã„ãŸå ´åˆã®åˆæœŸåŒ–
        if (window.trampolineAngles[key] === undefined) {
          window.trampolineAngles[key] = 0; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ä¸Šå‘ãï¼ˆ0Â°ï¼‰
          angle = 0;
          slider.value = 0;
        }
        
        const valueText = document.createElement('span');
        valueText.textContent = angle.toFixed(1) + 'Â°';
        valueText.style.minWidth = '50px';
        
        // æ–¹å‘çŸ¢å°ã‚’è¿½åŠ 
        const directionArrow = document.createElement('span');
        directionArrow.style.fontSize = '16px';
        directionArrow.style.fontWeight = 'bold';
        directionArrow.style.color = '#4466ff';
        
        function updateDirectionArrow(angle) {
          if (angle >= 315 || angle < 45) directionArrow.textContent = 'â†’'; // å³
          else if (angle >= 45 && angle < 135) directionArrow.textContent = 'â†“'; // ä¸‹
          else if (angle >= 135 && angle < 225) directionArrow.textContent = 'â†'; // å·¦
          else directionArrow.textContent = 'â†‘'; // ä¸Š
        }
        updateDirectionArrow(angle);
        
        slider.oninput = function() {
          const newAngle = parseFloat(this.value);
          valueText.textContent = newAngle.toFixed(1) + 'Â°';
          updateDirectionArrow(newAngle);
          window.trampolineAngles[key] = newAngle;
          drawTrajectoryPreview(newAngle);
          saveMapState();
          draw();
        };
        
        label.appendChild(slider);
        label.appendChild(valueText);
        label.appendChild(directionArrow);
        settings.appendChild(label);
        
        // è»Œé“ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        const previewCanvas = document.createElement('canvas');
        previewCanvas.width = 120;
        previewCanvas.height = 80;
        previewCanvas.style.border = '1px solid #ccc';
        previewCanvas.style.marginTop = '8px';
        previewCanvas.style.backgroundColor = '#f0f0f0';
        
        // è»Œé“ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é–¢æ•°ï¼ˆè§’åº¦ã¨åŠ›ã®ä¸¡æ–¹ã«å¯¾å¿œï¼‰
        function drawTrajectoryPreview(angle, power = window.trampolinePowers[key] || 2.2) {
          const ctx = previewCanvas.getContext('2d');
          ctx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
          
          // ãƒˆãƒ©ãƒ³ãƒãƒªãƒ³ä½ç½®ï¼ˆä¸­å¿ƒï¼‰
          const centerX = previewCanvas.width / 2;
          const centerY = previewCanvas.height - 10;
          
          // è»Œé“è¨ˆç®—ï¼ˆã‚²ãƒ¼ãƒ ã¨åŒã˜è¨ˆç®—ï¼‰
          const rad = (angle - 90) * Math.PI / 180;
          const basePower = Math.abs(-9) * power * 1.1; // 1.1å€ã®è¿½åŠ ãƒ–ãƒ¼ã‚¹ãƒˆ
          
          // è§’åº¦ã«å¿œã˜ãŸè»Œé“èª¿æ•´ï¼ˆã‚²ãƒ¼ãƒ ã¨åŒã˜è¨ˆç®—ï¼‰
          let powerMultiplier = 1.0;
          let horizontalMultiplier = 1.0;
          let verticalMultiplier = 1.0;
          
          // è§’åº¦ç¯„å›²ã”ã¨ã®è»Œé“èª¿æ•´
          if (angle >= 315 || angle < 45) {
            horizontalMultiplier = 1.2;
            verticalMultiplier = 0.8;
          } else if (angle >= 45 && angle < 135) {
            horizontalMultiplier = 0.6;
            verticalMultiplier = 1.4;
          } else if (angle >= 135 && angle < 225) {
            horizontalMultiplier = 1.2;
            verticalMultiplier = 0.8;
          } else {
            horizontalMultiplier = 0.6;
            verticalMultiplier = 1.4;
          }
          
          // ç´°ã‹ã„è§’åº¦èª¿æ•´
          const angleMod = angle % 90;
          if (angleMod > 0 && angleMod < 90) {
            const diagonalMultiplier = 0.8 + (angleMod / 90) * 0.4;
            powerMultiplier = diagonalMultiplier;
          }
          
          const finalPower = basePower * powerMultiplier;
          const initialVx = Math.cos(rad) * finalPower * horizontalMultiplier;
          const initialVy = Math.sin(rad) * finalPower * verticalMultiplier;
          
          // æœ¬ç•ªã¨åŒã˜ç‰©ç†æ¼”ç®—ã§è»Œé“ã‚’è¨ˆç®—
          let x = centerX;
          let y = centerY;
          let vx = initialVx;
          let vy = initialVy;
          const gravity = 0.01; // 0.3 â†’ 0.01 ã«å¤§å¹…ã«æ¸›ã‚‰ã—ã¦è¶…é«˜ç©ºé£›è¡Œ
          const airResistance = 0.999; // 0.99 â†’ 0.999 ã«å¤‰æ›´ã—ã¦ç©ºæ°—æŠµæŠ—ã‚’æœ€å°é™ã«
          const maxFallSpeed = 50; // 15 â†’ 50 ã«ä¸Šã’ã¦è¶…é«˜é€Ÿè½ä¸‹
          ctx.strokeStyle = '#4466ff';
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.moveTo(x, y);
          for (let frame = 0; frame < 1000; frame++) { // è¶…é•·è·é›¢è»Œé“
            vx *= airResistance;
            vy += gravity;
            if (vy > maxFallSpeed) vy = maxFallSpeed;
            x += vx;
            y += vy;
            ctx.lineTo(x, y);
            // åœ°é¢ã«ç€åœ°ã—ãŸã‚‰çµ‚äº†ï¼ˆã‚ˆã‚Šæ­£ç¢ºãªåˆ¤å®šï¼‰
            if (y > previewCanvas.height - 10) break;
          }
          
          // ãƒˆãƒ©ãƒ³ãƒãƒªãƒ³ã‚’æç”»
          const trampolinePreviewImg = new Image();
          trampolinePreviewImg.src = window.ASSETS_BASE64["trampoline.png"];
          
          if (trampolinePreviewImg.complete && trampolinePreviewImg.naturalWidth > 0) {
            ctx.save();
            ctx.translate(centerX, centerY);
            ctx.rotate(angle * Math.PI / 180);
            ctx.drawImage(trampolinePreviewImg, -16, -12, 32, 24);
            ctx.restore();
          } else {
            // ç”»åƒãŒæœªãƒ­ãƒ¼ãƒ‰ãªã‚‰onloadã§å†æç”»
            trampolinePreviewImg.onload = () => drawTrajectoryPreview(angle, power);
            ctx.fillStyle = '#ff6b35';
            ctx.fillRect(centerX - 8, centerY - 4, 16, 8);
          }
          
          // è§’åº¦ç·šã‚’æç”»
          ctx.strokeStyle = '#ff0000';
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(centerX, centerY);
          ctx.lineTo(centerX + Math.cos(rad) * 15, centerY + Math.sin(rad) * 15);
          ctx.stroke();
        }
        
        // åˆæœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æç”»
        drawTrajectoryPreview(angle, window.trampolinePowers[key] || 2.2);
        
        slider.oninput = function() {
          const newAngle = parseFloat(this.value);
          valueText.textContent = newAngle.toFixed(1) + 'Â°';
          updateDirectionArrow(newAngle);
          window.trampolineAngles[key] = newAngle;
          drawTrajectoryPreview(newAngle, window.trampolinePowers[key] || 2.2);
          saveMapState();
          draw();
        };
        
        settings.appendChild(previewCanvas);
        
        // --- ãƒˆãƒ©ãƒ³ãƒãƒªãƒ³åŠ›ï¼ˆã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼: 0.5-3.0ï¼‰ ---
        const powerLabel = document.createElement('label');
        powerLabel.textContent = 'é£›ã¶åŠ›:';
        powerLabel.style.display = 'flex';
        powerLabel.style.alignItems = 'center';
        powerLabel.style.gap = '8px';
        powerLabel.style.marginTop = '12px';
        
        const powerSlider = document.createElement('input');
        powerSlider.type = 'range';
        powerSlider.min = 0.5;
        powerSlider.max = 3.0;
        powerSlider.step = 0.1;
        powerSlider.value = window.trampolinePowers[key] || 2.2;
        powerSlider.style.width = '120px';
        
        // æ–°ã—ããƒˆãƒ©ãƒ³ãƒãƒªãƒ³ã‚’ç½®ã„ãŸå ´åˆã®åŠ›ã®åˆæœŸåŒ–
        if (window.trampolinePowers[key] === undefined) {
          window.trampolinePowers[key] = 2.2; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯2.2å€
          powerSlider.value = 2.2;
        }
        
        const powerValueText = document.createElement('span');
        powerValueText.textContent = (window.trampolinePowers[key] || 2.2).toFixed(1) + 'å€';
        powerValueText.style.minWidth = '50px';
        
        powerSlider.oninput = function() {
          const newPower = parseFloat(this.value);
          powerValueText.textContent = newPower.toFixed(1) + 'å€';
          window.trampolinePowers[key] = newPower;
          drawTrajectoryPreview(angle, newPower);
          saveMapState();
          draw();
        };
        
        powerLabel.appendChild(powerSlider);
        powerLabel.appendChild(powerValueText);
        settings.appendChild(powerLabel);
        
        // è»Œé“ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’åŠ›ã®è¨­å®šã«ã‚‚å¯¾å¿œã•ã›ã‚‹
        function drawTrajectoryPreview(angle, power = window.trampolinePowers[key] || 2.2) {
          const ctx = previewCanvas.getContext('2d');
          ctx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
          
          // ãƒˆãƒ©ãƒ³ãƒãƒªãƒ³ä½ç½®ï¼ˆä¸­å¿ƒï¼‰
          const centerX = previewCanvas.width / 2;
          const centerY = previewCanvas.height - 10;
          
          // è»Œé“è¨ˆç®—ï¼ˆã‚²ãƒ¼ãƒ ã¨åŒã˜è¨ˆç®—ï¼‰
          const rad = (angle - 90) * Math.PI / 180;
          const basePower = Math.abs(-9) * power * 1.1; // 1.1å€ã®è¿½åŠ ãƒ–ãƒ¼ã‚¹ãƒˆ
          
          // è§’åº¦ã«å¿œã˜ãŸè»Œé“èª¿æ•´ï¼ˆã‚²ãƒ¼ãƒ ã¨åŒã˜è¨ˆç®—ï¼‰
          let powerMultiplier = 1.0;
          let horizontalMultiplier = 1.0;
          let verticalMultiplier = 1.0;
          
          // è§’åº¦ç¯„å›²ã”ã¨ã®è»Œé“èª¿æ•´
          if (angle >= 315 || angle < 45) {
            horizontalMultiplier = 1.2;
            verticalMultiplier = 0.8;
          } else if (angle >= 45 && angle < 135) {
            horizontalMultiplier = 0.6;
            verticalMultiplier = 1.4;
          } else if (angle >= 135 && angle < 225) {
            horizontalMultiplier = 1.2;
            verticalMultiplier = 0.8;
          } else {
            horizontalMultiplier = 0.6;
            verticalMultiplier = 1.4;
          }
          
          // ç´°ã‹ã„è§’åº¦èª¿æ•´
          const angleMod = angle % 90;
          if (angleMod > 0 && angleMod < 90) {
            const diagonalMultiplier = 0.8 + (angleMod / 90) * 0.4;
            powerMultiplier = diagonalMultiplier;
          }
          
          const finalPower = basePower * powerMultiplier;
          const initialVx = Math.cos(rad) * finalPower * horizontalMultiplier;
          const initialVy = Math.sin(rad) * finalPower * verticalMultiplier;
          
          // æœ¬ç•ªã¨åŒã˜ç‰©ç†æ¼”ç®—ã§è»Œé“ã‚’è¨ˆç®—
          let x = centerX;
          let y = centerY;
          let vx = initialVx;
          let vy = initialVy;
          const gravity = 0.01; // 0.3 â†’ 0.01 ã«å¤§å¹…ã«æ¸›ã‚‰ã—ã¦è¶…é«˜ç©ºé£›è¡Œ
          const airResistance = 0.999; // 0.99 â†’ 0.999 ã«å¤‰æ›´ã—ã¦ç©ºæ°—æŠµæŠ—ã‚’æœ€å°é™ã«
          const maxFallSpeed = 50; // 15 â†’ 50 ã«ä¸Šã’ã¦è¶…é«˜é€Ÿè½ä¸‹
          ctx.strokeStyle = '#4466ff';
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.moveTo(x, y);
          for (let frame = 0; frame < 1000; frame++) { // è¶…é•·è·é›¢è»Œé“
            vx *= airResistance;
            vy += gravity;
            if (vy > maxFallSpeed) vy = maxFallSpeed;
            x += vx;
            y += vy;
            ctx.lineTo(x, y);
            // åœ°é¢ã«ç€åœ°ã—ãŸã‚‰çµ‚äº†ï¼ˆã‚ˆã‚Šæ­£ç¢ºãªåˆ¤å®šï¼‰
            if (y > previewCanvas.height - 10) break;
          }
          
          // ãƒˆãƒ©ãƒ³ãƒãƒªãƒ³ã‚’æç”»
          const trampolinePreviewImg2 = new Image();
          trampolinePreviewImg2.src = window.ASSETS_BASE64["trampoline.png"];
          
          if (trampolinePreviewImg2.complete && trampolinePreviewImg2.naturalWidth > 0) {
            ctx.save();
            ctx.translate(centerX, centerY);
            ctx.rotate(angle * Math.PI / 180);
            ctx.drawImage(trampolinePreviewImg2, -16, -12, 32, 24);
            ctx.restore();
          } else {
            // ç”»åƒãŒæœªãƒ­ãƒ¼ãƒ‰ãªã‚‰onloadã§å†æç”»
            trampolinePreviewImg2.onload = () => drawTrajectoryPreview(angle, power);
            ctx.fillStyle = '#ff6b35';
            ctx.fillRect(centerX - 8, centerY - 4, 16, 8);
          }
          
          // è§’åº¦ç·šã‚’æç”»
          ctx.strokeStyle = '#ff0000';
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(centerX, centerY);
          ctx.lineTo(centerX + Math.cos(rad) * 15, centerY + Math.sin(rad) * 15);
          ctx.stroke();
        }
        
        // åˆæœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æç”»
        drawTrajectoryPreview(angle, window.trampolinePowers[key] || 2.2);
      }
      popup.appendChild(settings);
      popup.style.display = 'flex';
    }

        // --- canvasã‚¯ãƒªãƒƒã‚¯æ™‚ã€å‹•ãæ•µã‚„ãã®ã“ã®æ–¹å‘ãƒ»è§’åº¦å¤‰æ›´å‡¦ç†ã‚’ç„¡åŠ¹åŒ– ---
    if (window.canvas) {
      window.canvas.addEventListener('click', function(e) {
        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®å®Ÿéš›ã®ã‚µã‚¤ã‚ºã¨è¡¨ç¤ºã‚µã‚¤ã‚ºã‚’å–å¾—
        const rect = window.canvas.getBoundingClientRect();
        
        // ãƒã‚¦ã‚¹ä½ç½®ã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ç³»ã«å¤‰æ›
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;
        
        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®è¡¨ç¤ºã‚µã‚¤ã‚ºã¨å®Ÿéš›ã®ã‚µã‚¤ã‚ºã®æ¯”ç‡ã‚’è¨ˆç®—
        const scaleX = window.canvas.width / rect.width;
        const scaleY = window.canvas.height / rect.height;
        
        // ã‚¹ã‚±ãƒ¼ãƒ«ã‚’è€ƒæ…®ã—ã¦ã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ã‚’è¨ˆç®—
        const canvasX = mouseX * scaleX;
        const canvasY = mouseY * scaleY;
        
        // ã‚«ãƒ¡ãƒ©ä½ç½®ã‚’è€ƒæ…®ã—ã¦ãƒ¯ãƒ¼ãƒ«ãƒ‰åº§æ¨™ã‚’è¨ˆç®—
        const worldX = canvasX + camera.x;
        const worldY = canvasY + camera.y;
        
        // ã‚¿ã‚¤ãƒ«åº§æ¨™ã‚’è¨ˆç®—
        const col = Math.floor(worldX / TILE_SIZE);
        const row = Math.floor(worldY / TILE_SIZE);
      if (col >= 0 && col < cols && row >= 0 && row < rows) {
          if (isHandMode) {
            const blockId = map[row][col];
            if (blockId !== 0) {
              window.lastDetailRowCol = `${row},${col}`;
              showBlockDetail(blockId);
          return;
        }
          }
          // æ–¹å‘ãƒ»è§’åº¦å¤‰æ›´å‡¦ç†ã¯å‰Šé™¤
      }
    });
    }

    // clearButtonã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’clear.pngã«
    const clearButton = document.getElementById("clearButton");
    clearButton.innerHTML = '';
    clearButton.style.backgroundImage = `url(${images[32].src})`;
    clearButton.style.backgroundSize = 'cover';
    clearButton.style.backgroundRepeat = 'no-repeat';
    clearButton.style.backgroundPosition = 'center';
    clearButton.style.width = '50px';
    clearButton.style.height = '50px';
    
    // è»Œé“è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã®è¿½åŠ 
    window.showTrajectories = false;
    
    // F3ã‚­ãƒ¼ã§è»Œé“è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
    document.addEventListener('keydown', function(e) {
      if (e.key === 'p') {
        e.preventDefault();
        window.showTrajectories = !window.showTrajectories;
        console.log('è»Œé“è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰:', window.showTrajectories ? 'ON' : 'OFF');
        updateTrajectoryStatus(); // çŠ¶æ…‹è¡¨ç¤ºã‚’æ›´æ–°
        draw(); // å†æç”»
      }
    });
    
    // è»Œé“æç”»é–¢æ•°
    function drawTrajectories() {
      if (!window.showTrajectories) return;
      
      const ctx = window.canvas.getContext('2d');
      ctx.save();
      ctx.setTransform(1, 0, 0, 1, -camera.x, -camera.y);
      
      // å‹•ãæ•µã®æ–¹å‘ã‚’æç”»
      if (window.enemyDirs) {
        for (const key in window.enemyDirs) {
          const [row, col] = key.split(',').map(Number);
          const direction = window.enemyDirs[key];
          const x = col * TILE_SIZE + TILE_SIZE / 2;
          const y = row * TILE_SIZE + TILE_SIZE / 2;
          
          // æ–¹å‘çŸ¢å°ã‚’æç”»
          ctx.strokeStyle = '#ff0000';
          ctx.lineWidth = 3;
          ctx.beginPath();
          ctx.moveTo(x, y);
          
          let endX = x, endY = y;
          switch (direction) {
            case 'left':
              endX = x - 20;
              break;
            case 'right':
              endX = x + 20;
              break;
            case 'up':
              endY = y - 20;
              break;
            case 'down':
              endY = y + 20;
              break;
          }
          
          ctx.lineTo(endX, endY);
          ctx.stroke();
          
          // çŸ¢å°ã®å…ˆç«¯ã‚’æç”»
          ctx.fillStyle = '#ff0000';
          ctx.beginPath();
          if (direction === 'left' || direction === 'right') {
            ctx.moveTo(endX + (direction === 'left' ? 5 : -5), endY - 3);
            ctx.lineTo(endX, endY);
            ctx.lineTo(endX + (direction === 'left' ? 5 : -5), endY + 3);
          } else {
            ctx.moveTo(endX - 3, endY + (direction === 'up' ? 5 : -5));
            ctx.lineTo(endX, endY);
            ctx.lineTo(endX + 3, endY + (direction === 'up' ? 5 : -5));
          }
          ctx.fill();
        }
      }
      
             // ãƒˆãƒ©ãƒ³ãƒãƒªãƒ³ã®è»Œé“ã‚’æç”»
       if (window.trampolineAngles) {
         for (const key in window.trampolineAngles) {
           const [row, col] = key.split(',').map(Number);
           // ãƒˆãƒ©ãƒ³ãƒãƒªãƒ³ãŒç¾å­˜ã—ãªã„å ´åˆã¯è»Œé“ã‚’æç”»ã—ãªã„
           if (!map[row] || map[row][col] !== 7) continue;
           const angle = window.trampolineAngles[key];
           const power = window.trampolinePowers[key] || 1.7;
           const x = col * TILE_SIZE + TILE_SIZE / 2;
           const y = row * TILE_SIZE + TILE_SIZE / 2;
           
           // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åˆæœŸä½ç½®ï¼ˆãƒˆãƒ©ãƒ³ãƒãƒªãƒ³ã®ä¸Šï¼‰
           const playerStartX = x;
           const playerStartY = y - TILE_SIZE; // ãƒˆãƒ©ãƒ³ãƒãƒªãƒ³ã®1ã‚¿ã‚¤ãƒ«ä¸Š
           
           // è»Œé“è¨ˆç®—ï¼ˆã‚²ãƒ¼ãƒ ã¨åŒã˜è¨ˆç®—ï¼‰
           const rad = (angle - 90) * Math.PI / 180;
           const basePower = Math.abs(-9) * power * 1.1; // 1.1å€ã®è¿½åŠ ãƒ–ãƒ¼ã‚¹ãƒˆ
           
           // è§’åº¦ã«å¿œã˜ãŸè»Œé“èª¿æ•´
           let powerMultiplier = 1.0;
           let horizontalMultiplier = 1.0;
           let verticalMultiplier = 1.0;
           
           if (angle >= 315 || angle < 45) {
             horizontalMultiplier = 1.2;
             verticalMultiplier = 0.8;
           } else if (angle >= 45 && angle < 135) {
             horizontalMultiplier = 0.6;
             verticalMultiplier = 1.4;
           } else if (angle >= 135 && angle < 225) {
             horizontalMultiplier = 1.2;
             verticalMultiplier = 0.8;
           } else {
             horizontalMultiplier = 0.6;
             verticalMultiplier = 1.4;
           }
           
           const angleMod = angle % 90;
           if (angleMod > 0 && angleMod < 90) {
             const diagonalMultiplier = 0.8 + (angleMod / 90) * 0.4;
             powerMultiplier = diagonalMultiplier;
           }
           
           const finalPower = basePower * powerMultiplier;
           const initialVx = Math.cos(rad) * finalPower * horizontalMultiplier;
           const initialVy = Math.sin(rad) * finalPower * verticalMultiplier;
           
           // è»Œé“ã®ãƒã‚¤ãƒ³ãƒˆã‚’è¨ˆç®—ã—ã¦æç”»ï¼ˆåœ°é¢ã«ç€åœ°ã™ã‚‹ã¾ã§ï¼‰
           let trajectoryPoints = [];
           
           // ç‰©ç†ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å…ˆã«å®£è¨€
           const gravity = 0.5;
           const airResistance = 0.98;
           const maxFallSpeed = 12;
           
           // ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã«é€Ÿåº¦ãƒ»åº§æ¨™ã‚’æ›´æ–°ã™ã‚‹è»Œé“è¨ˆç®—
           let trajectoryX = playerStartX;
           let trajectoryY = playerStartY;
           let vx = initialVx;
           let vy = initialVy;
           
           ctx.strokeStyle = '#4466ff';
           ctx.lineWidth = 3;
           ctx.setLineDash([8, 4]);
           ctx.beginPath();
           ctx.moveTo(trajectoryX, trajectoryY);
           
           for (let frame = 0; frame < 1000; frame++) {
             vx *= airResistance;
             vy += gravity;
             if (vy > maxFallSpeed) vy = maxFallSpeed;
             trajectoryX += vx;
             trajectoryY += vy;
             trajectoryPoints.push({ x: trajectoryX, y: trajectoryY });
             ctx.lineTo(trajectoryX, trajectoryY);
             
             // åœ°é¢ã«ç€åœ°ã—ãŸã‚‰çµ‚äº†ï¼ˆåœ°å½¢åˆ¤å®šï¼‰
             const tileBelow = typeof getTile === 'function' ? getTile(trajectoryX, trajectoryY + 1) : 0;
             // å½“ãŸã‚Šåˆ¤å®šã®ãªã„ãƒ–ãƒ­ãƒƒã‚¯ã‚’é™¤å¤–: 0(ç©º), 6(æ¯’), 7(ãƒˆãƒ©ãƒ³ãƒãƒªãƒ³), 8(ãƒã‚·ã‚´), 10(ã‚¹ãƒãƒ¼ãƒ³), 15(ã‚³ã‚¤ãƒ³), 16(ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ), 17(ã‚´ãƒ¼ãƒ«), 19(ãƒ€ãƒŸãƒ¼)
             if (tileBelow !== 0 && tileBelow !== 6 && tileBelow !== 7 && tileBelow !== 8 && tileBelow !== 10 && tileBelow !== 15 && tileBelow !== 16 && tileBelow !== 17 && tileBelow !== 19) {
               break;
             }
           }
           
           ctx.stroke();
           ctx.setLineDash([]);
           
           // è»Œé“ã®ãƒã‚¤ãƒ³ãƒˆã‚’å°ã•ãªå††ã§è¡¨ç¤º
           ctx.fillStyle = '#4466ff';
           for (let i = 0; i < trajectoryPoints.length; i += 5) { // 5ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã«ãƒã‚¤ãƒ³ãƒˆã‚’è¡¨ç¤º
             const point = trajectoryPoints[i];
             ctx.beginPath();
             ctx.arc(point.x, point.y, 2, 0, Math.PI * 2);
             ctx.fill();
           }
           
           // ç€åœ°ç‚¹ã‚’èµ¤ã„å††ã§è¡¨ç¤º
           if (trajectoryPoints.length > 0) {
             const landingPoint = trajectoryPoints[trajectoryPoints.length - 1];
             ctx.fillStyle = '#ff0000';
             ctx.beginPath();
             ctx.arc(landingPoint.x, landingPoint.y, 6, 0, Math.PI * 2);
             ctx.fill();
             
             // ç€åœ°ç‚¹ã®åº§æ¨™ã‚’è¡¨ç¤º
             ctx.fillStyle = '#ff0000';
             ctx.font = '10px Arial';
             ctx.fillText(`ç€åœ°: (${Math.round(landingPoint.x)}, ${Math.round(landingPoint.y)})`, 
                         landingPoint.x + 10, landingPoint.y - 10);
           }
           
           // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é–‹å§‹ä½ç½®ã‚’ç·‘ã®å††ã§è¡¨ç¤º
           ctx.fillStyle = '#00ff00';
           ctx.beginPath();
           ctx.arc(playerStartX, playerStartY, 4, 0, Math.PI * 2);
           ctx.fill();
           
           // è§’åº¦ç·šã‚’æç”»
           ctx.strokeStyle = '#ff6b35';
           ctx.lineWidth = 2;
           ctx.beginPath();
           ctx.moveTo(x, y);
           ctx.lineTo(x + Math.cos(rad) * 25, y + Math.sin(rad) * 25);
           ctx.stroke();
           
           // è§’åº¦ã¨åŠ›ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æç”»
           ctx.fillStyle = '#ff6b35';
           ctx.font = '12px Arial';
           ctx.fillText(`${angle.toFixed(1)}Â° / ${power.toFixed(1)}å€`, x + 30, y - 10);
         }
       }
      
      ctx.restore();
    }
    
    // æ—¢å­˜ã®drawé–¢æ•°ã‚’æ‹¡å¼µ
    const originalDraw = window.draw;
    window.draw = function() {
      if (originalDraw) originalDraw();
      drawTrajectories();
    };
    
    // è»Œé“è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã®çŠ¶æ…‹ã‚’è¡¨ç¤º
    function updateTrajectoryStatus() {
      const statusDiv = document.getElementById('trajectoryStatus');
      if (!statusDiv) {
        const div = document.createElement('div');
        div.id = 'trajectoryStatus';
        div.style.cssText = `
          position: fixed;
          top: 10px;
          right: 10px;
          background: rgba(0,0,0,0.7);
          color: white;
          padding: 8px 12px;
          border-radius: 6px;
          font-size: 12px;
          z-index: 1000;
          display: none;
        `;
        document.body.appendChild(div);
      }
      
      const div = document.getElementById('trajectoryStatus');
      if (window.showTrajectories) {
        div.textContent = 'è»Œé“è¡¨ç¤º: ON (Pã§OFF)';
        div.style.display = 'block';
      } else {
        div.style.display = 'none';
      }
    }
    

    

    

    

    

    
    // åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
    updateTrajectoryStatus();
    


  </script>
</body>
</html>
